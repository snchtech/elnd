–î–æ–±—Ä–µ, –¥–∞–≤–∞–π –∑—Ä–æ–±–∏–º–æ —Ç–∞–∫:

### üîß –¶—ñ–ª—å:
–°—Ç–≤–æ—Ä–∏—Ç–∏ **PL/SQL —Ñ—É–Ω–∫—Ü—ñ—é** –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–≤–æ–≥–æ SQL, —è–∫–∞ –ø—Ä–∏–π–º–∞—î –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ `p_date_start` —ñ `p_date_end` —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î **HTML-—Ä—è–¥–æ–∫** –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é:
- **–±—Ä–∏–≥–∞–¥ —ñ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ —Ñ—ñ—Ä–º–∏** (org = 1)
- **–±—Ä–∏–≥–∞–¥ —ñ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤** (org = 0)

---

## ‚úÖ –ö–†–û–ö 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó

```sql
CREATE OR REPLACE FUNCTION get_team_summary_html (
    p_date_start IN DATE,
    p_date_end   IN DATE
) RETURN CLOB IS
    v_html     CLOB;
    v_firm_teams       NUMBER := 0;
    v_firm_workers     NUMBER := 0;
    v_contractor_teams NUMBER := 0;
    v_contractor_workers NUMBER := 0;
BEGIN
    WITH team_data AS (
      SELECT 
        tt.id_outfit, 
        COUNT(tt.id) AS count_team
      FROM tw_wp_team_v tt
      JOIN tw.wp_outfit_v k ON tt.id_outfit = k.id_outfit
      WHERE (tt.data_end >= p_date_start OR tt.data_end IS NULL)
      GROUP BY tt.id_outfit
    ),
    g_data AS (
      SELECT 
        k.id_outfit,
        NVL(team.count_team, 0) + DECODE(k.performer, NULL, 0, 1) AS team_count
      FROM tw.wp_outfit_v k
      LEFT JOIN team_data team ON team.id_outfit = k.id_outfit
    ),
    outfit_open_status AS (
      SELECT 
        tl.id_outfit,
        COUNT(tl.id_status) AS outfit_open
      FROM tw_wp_status_v tl
      WHERE tl.data BETWEEN p_date_start AND p_date_end
        AND tl.id_status = 6
      GROUP BY tl.id_outfit
    ),
    full_data AS (
      SELECT 
        o.id_outfit,
        DECODE(o.id_org, NULL, 0, 1) AS org,
        g.team_count
      FROM g_data g
      LEFT JOIN outfit_open_status r ON r.id_outfit = g.id_outfit
      LEFT JOIN tw.wp_outfit@to_asics10 o ON o.id_outfit = g.id_outfit
      WHERE (
          (o.data_start <= p_date_end AND o.data_finish >= p_date_start)
          OR TRUNC(o.data_prolongation, 'dd') >= TRUNC(p_date_start, 'dd')
      )
      AND r.outfit_open IS NOT NULL

      UNION ALL

      SELECT 
        oo.id_outfit,
        DECODE(oo.id_org, NULL, 0, 1) AS org,
        0 AS team_count
      FROM outfit_open_status rr
      LEFT JOIN tw.wp_outfit@to_asics10 oo ON oo.id_outfit = rr.id_outfit
      WHERE (
          (oo.data_start <= p_date_end AND oo.data_finish >= p_date_start)
          OR TRUNC(oo.data_prolongation, 'dd') >= TRUNC(p_date_start, 'dd')
      )
      AND oo.team IS NULL
      AND rr.outfit_open IS NOT NULL
    )
    SELECT
      SUM(CASE WHEN org = 1 THEN 1 ELSE 0 END),
      SUM(CASE WHEN org = 1 THEN team_count ELSE 0 END),
      SUM(CASE WHEN org = 0 THEN 1 ELSE 0 END),
      SUM(CASE WHEN org = 0 THEN team_count ELSE 0 END)
    INTO
      v_firm_teams, v_firm_workers, v_contractor_teams, v_contractor_workers
    FROM full_data;

    -- –§–æ—Ä–º—É–≤–∞–Ω–Ω—è HTML-—Ä—è–¥–∫–∞
    v_html := 
        '–±—Ä–∏–≥–∞–¥ —Ñ—ñ—Ä–º–∏ - <span class="vl_sld">' || v_firm_teams || '</span>, –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ - <span class="vl_sld">' || v_firm_workers || '</span><br>' ||
        '–±—Ä–∏–≥–∞–¥ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤ - <span class="vl_sld">' || v_contractor_teams || '</span>, –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ - <span class="vl_sld">' || v_contractor_workers || '</span>';

    RETURN v_html;
EXCEPTION
    WHEN OTHERS THEN
        RETURN '–ü–æ–º–∏–ª–∫–∞: ' || SQLERRM;
END;
/
```

---

## ‚úÖ –ö–†–û–ö 2. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —É APEX –∞–±–æ PL/SQL

### üîπ –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –í—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç—É —ñ –¥–∞–ª—ñ
```sql
SELECT get_team_summary_html(SYSDATE, SYSDATE + 10) FROM DUAL;
```

### üîπ –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –í—ñ–¥ 12:00 –¥–æ 18:00 –ø–æ—Ç–æ—á–Ω–æ–≥–æ –¥–Ω—è
```sql
SELECT get_team_summary_html(
  TRUNC(SYSDATE) + 12/24,
  TRUNC(SYSDATE) + 18/24
) FROM DUAL;
```

### üîπ –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –ó–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
```sql
SELECT get_team_summary_html(
  TRUNC(SYSDATE),
  TRUNC(SYSDATE + 1) - INTERVAL '1' SECOND
) FROM DUAL;
```

---

## ‚úÖ –Ø–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤ APEX

1. –î–æ–¥–∞–π **PL/SQL dynamic content** –∞–±–æ `HTML Expression` —É –∑–≤—ñ—Ç.
2. –í—Å—Ç–∞–≤ –∑–∞–ø–∏—Ç:
```sql
SELECT get_team_summary_html(:P1_DATE_START, :P1_DATE_END) FROM DUAL
```
> `:P1_DATE_START` —ñ `:P1_DATE_END` ‚Äî —Ü–µ APEX page items —Ç–∏–ø—É date/time.

---

–•–æ—á–µ—à —â–µ –≤–∞—Ä—ñ–∞–Ω—Ç, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î **JSON** –∑–∞–º—ñ—Å—Ç—å HTML? –¶–µ –∑—Ä—É—á–Ω–æ –¥–ª—è JavaScript-–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.