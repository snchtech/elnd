–ß—É–¥–æ–≤–æ! –ú–∏ –º–æ–∂–µ–º–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ PL/SQL —Ñ—É–Ω–∫—Ü—ñ—é –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–≤–æ–≥–æ **–ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ–≥–æ SQL**, —è–∫–∞:

### ‚úÖ –†–æ–±–∏—Ç—å –Ω–∞—Å—Ç—É–ø–Ω–µ:
- –ü—Ä–∏–π–º–∞—î –¥–≤–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∏: `p_date_start`, `p_date_end` (–¥–µ `p_date_end` –º–æ–∂–µ –±—É—Ç–∏ NULL);
- –ü–æ–≤–µ—Ä—Ç–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É –≤–∏–≥–ª—è–¥—ñ **HTML**:

```html
–±—Ä–∏–≥–∞–¥ —Ñ—ñ—Ä–º–∏ - <span class="vl_sld">25</span>, –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ - <span class="vl_sld">40</span><br>
–±—Ä–∏–≥–∞–¥ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤ - <span class="vl_sld">5</span>, –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ - <span class="vl_sld">11</span>
```

---

## ‚úÖ –§—É–Ω–∫—Ü—ñ—è `get_outfit_html`

```sql
CREATE OR REPLACE FUNCTION get_outfit_html (
    p_date_start IN DATE,
    p_date_end   IN DATE DEFAULT NULL
) RETURN CLOB IS
    v_firm_teams           NUMBER := 0;
    v_firm_workers         NUMBER := 0;
    v_contract_teams       NUMBER := 0;
    v_contract_workers     NUMBER := 0;
    v_html                 CLOB;
BEGIN
    -- –û–±—á–∏—Å–ª–µ–Ω–Ω—è
    SELECT
        SUM(CASE WHEN org = 1 THEN 1 ELSE 0 END),
        SUM(CASE WHEN org = 1 THEN team_count ELSE 0 END),
        SUM(CASE WHEN org = 0 THEN 1 ELSE 0 END),
        SUM(CASE WHEN org = 0 THEN team_count ELSE 0 END)
    INTO
        v_firm_teams,
        v_firm_workers,
        v_contract_teams,
        v_contract_workers
    FROM (
        SELECT 
            o.id_outfit,
            DECODE(o.id_org, NULL, 0, 1) AS org,
            g.team_count
        FROM (
            SELECT 
                k.id_outfit,
                team.count_team + DECODE(k.performer, NULL, 0, 1) AS team_count
            FROM (
                SELECT 
                    tt.id_outfit, 
                    COUNT(tt.id) AS count_team 
                FROM tw_wp_team_v tt, tw.wp_outfit_v k
                WHERE tt.id_outfit = k.id_outfit
                  AND (tt.data_end >= p_date_start OR tt.data_end IS NULL)
                GROUP BY tt.id_outfit
            ) team,
            tw.wp_outfit_v k
            WHERE team.id_outfit = k.id_outfit
        ) g
        LEFT JOIN (
            SELECT
                tl.id_outfit,
                COUNT(id_status) AS outfit_open 
            FROM tw_wp_status_v tl
            WHERE tl.data >= p_date_start
              AND (p_date_end IS NULL OR tl.data <= p_date_end)
              AND tl.id_status = 6
            GROUP BY tl.id_outfit
        ) r ON r.id_outfit = g.id_outfit
        LEFT JOIN tw.wp_outfit@to_asics10 o ON o.id_outfit = g.id_outfit 
        WHERE (
            (o.data_start <= NVL(p_date_end, o.data_start) 
             AND o.data_finish >= p_date_start)
            OR TRUNC(o.data_prolongation, 'dd') >= TRUNC(p_date_start, 'dd')
        )
        AND r.outfit_open IS NOT NULL

        UNION ALL

        SELECT 
            oo.id_outfit,
            DECODE(oo.id_org, NULL, 0, 1) AS org,
            0 AS team_count
        FROM (
            SELECT
                tl.id_outfit,
                COUNT(id_status) AS outfit_open
            FROM tw_wp_status_v tl
            WHERE tl.data >= p_date_start
              AND (p_date_end IS NULL OR tl.data <= p_date_end)
              AND tl.id_status = 6
            GROUP BY tl.id_outfit
        ) rr
        LEFT JOIN tw.wp_outfit@to_asics10 oo ON oo.id_outfit = rr.id_outfit
        WHERE (
            (oo.data_start <= NVL(p_date_end, oo.data_start) 
             AND oo.data_finish >= p_date_start)
            OR TRUNC(oo.data_prolongation, 'dd') >= TRUNC(p_date_start, 'dd')
        )
        AND oo.team IS NULL
        AND rr.outfit_open IS NOT NULL
    );

    -- –§–æ—Ä–º—É–≤–∞–Ω–Ω—è HTML
    v_html := 
        '–±—Ä–∏–≥–∞–¥ —Ñ—ñ—Ä–º–∏ - <span class="vl_sld">' || v_firm_teams || '</span>, –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ - <span class="vl_sld">' || v_firm_workers || '</span><br>' ||
        '–±—Ä–∏–≥–∞–¥ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤ - <span class="vl_sld">' || v_contract_teams || '</span>, –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ - <span class="vl_sld">' || v_contract_workers || '</span>';

    RETURN v_html;

EXCEPTION
    WHEN OTHERS THEN
        RETURN '–ü–æ–º–∏–ª–∫–∞: ' || SQLERRM;
END;
/
```

---

## üß™ –°—Ü–µ–Ω–∞—Ä—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:

### üîπ 1. –í—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç—É —ñ –¥–∞–ª—ñ:
```sql
SELECT get_outfit_html(SYSDATE, NULL) FROM DUAL;
```

### üîπ 2. –í—ñ–¥ 12:00 –¥–æ 18:00:
```sql
SELECT get_outfit_html(TRUNC(SYSDATE) + 12/24, TRUNC(SYSDATE) + 18/24) FROM DUAL;
```

### üîπ 3. –ó–∞ –¥–µ–Ω—å (–≤—ñ–¥ 00:00 –¥–æ 23:59:59):
```sql
SELECT get_outfit_html(TRUNC(SYSDATE), TRUNC(SYSDATE + 1) - INTERVAL '1' SECOND) FROM DUAL;
```

---

## ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ APEX

–¢–∏ –º–æ–∂–µ—à:

- –¥–æ–¥–∞—Ç–∏ —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é —è–∫ **PL/SQL Dynamic Content**;
- –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `SELECT get_outfit_html(:P1_START, :P1_END) FROM DUAL` –∑ item‚Äô–∞–º–∏ –¥–∞—Ç–∏.

---

üîπ –Ø–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂—É –∑—Ä–æ–±–∏—Ç–∏ —Ç–∞–∫–æ–∂ –≤–∞—Ä—ñ–∞–Ω—Ç –∑ **JSON**, –∞–±–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è **—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ–≥–æ –æ–±'—î–∫—Ç–∞** –¥–ª—è REST/JS.