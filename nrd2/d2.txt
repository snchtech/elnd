–ß—É–¥–æ–≤–æ! üéØ –ù–∏–∂—á–µ ‚Äî **–ø–æ–≤–Ω–∞ PL/SQL-—Ñ—É–Ω–∫—Ü—ñ—è `get_unit_matrix_html`**, —è–∫–∞:

---

## üîß –©–æ —Ä–µ–∞–ª—ñ–∑—É—î:

- –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ —Ç–≤–æ—ó–π `VIEW`
- **–æ–±—á–∏—Å–ª—é—î —á–∞—Å–æ–≤—ñ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó**:
  - `–ó–∞—Ä–∞–∑`: –≤—ñ–¥ SYSDATE –¥–æ ‚àû
  - `–ó –ø–æ—á–∞—Ç–∫—É –¥–æ–±–∏`: –≤—ñ–¥ 00:00 —Å—å–æ–≥–æ–¥–Ω—ñ –¥–æ SYSDATE
  - `–ó –ø–æ—á–∞—Ç–∫—É –∑–º—ñ–Ω–∏`: –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –∑–º—ñ–Ω–∏ –¥–æ SYSDATE
- –ø—Ä–∏–π–º–∞—î —Å–ø–∏—Å–æ–∫ `department` (—á–µ–∫–±–æ–∫—Å–∏)
- –ø–æ–≤–µ—Ä—Ç–∞—î HTML-—Ç–∞–±–ª–∏—Ü—é –∑—ñ —Å—Ç—Ä–æ–∫–∞–º–∏: `–ë—Ä–∏–≥–∞–¥ —Ñ—ñ—Ä–º–∏`, `–ë—Ä–∏–≥–∞–¥ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤`, `–õ—é–¥–µ–π —Ñ—ñ—Ä–º–∏`, `–õ—é–¥–µ–π –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤`
- —Å—Ç–æ–≤–ø—Ü—ñ: `Unit 1`, `Unit 2`, `Unit 3`, `–í—Å—å–æ–≥–æ`

---

## ‚úÖ –§—É–Ω–∫—Ü—ñ—è `get_unit_matrix_html(p_departments IN VARCHAR2)`

```sql
CREATE OR REPLACE FUNCTION get_unit_matrix_html (
    p_departments IN VARCHAR2 -- —Å–ø–∏—Å–æ–∫, –Ω–∞–ø—Ä: 'DEP1:DEP2:DEP3'
) RETURN CLOB IS
    v_html       CLOB := '';
    v_unit1      NUMBER;
    v_unit2      NUMBER;
    v_unit3      NUMBER;
    v_total      NUMBER;

    -- –∑–º—ñ–Ω–∞
    v_shift_start DATE;
    v_shift_end   DATE;

    CURSOR cur_periods IS
      SELECT '–ó–∞—Ä–∞–∑' AS period, SYSDATE AS start_time, NULL AS end_time FROM DUAL
      UNION ALL
      SELECT '–ó –ø–æ—á–∞—Ç–∫—É –¥–æ–±–∏', TRUNC(SYSDATE), SYSDATE FROM DUAL
      UNION ALL
      SELECT '–ó –ø–æ—á–∞—Ç–∫—É –∑–º—ñ–Ω–∏', NULL, NULL FROM DUAL; -- –ø—ñ–¥—Å—Ç–∞–≤–∏–º–æ –Ω–∏–∂—á–µ

    TYPE v_dep_table IS TABLE OF VARCHAR2(4000);
    v_departments_tbl v_dep_table := apex_string.split(p_departments, ':');
BEGIN
    -- –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –∑–º—ñ–Ω–∏
    IF TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '06:00' AND '13:59' THEN
        v_shift_start := TRUNC(SYSDATE) + 6/24;
        v_shift_end   := TRUNC(SYSDATE) + 14/24;
    ELSIF TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '14:00' AND '21:59' THEN
        v_shift_start := TRUNC(SYSDATE) + 14/24;
        v_shift_end   := TRUNC(SYSDATE) + 22/24;
    ELSE
        IF TO_CHAR(SYSDATE, 'HH24:MI') >= '22:00' THEN
            v_shift_start := TRUNC(SYSDATE) + 22/24;
            v_shift_end   := TRUNC(SYSDATE + 1) + 6/24;
        ELSE
            v_shift_start := TRUNC(SYSDATE - 1) + 22/24;
            v_shift_end   := TRUNC(SYSDATE) + 6/24;
        END IF;
    END IF;

    v_html := '<table border="1" cellpadding="5" cellspacing="0">';
    v_html := v_html || '<tr><th>–ß–∞—Å</th><th>–¢–∏–ø</th><th>Unit 1</th><th>Unit 2</th><th>Unit 3</th><th>–í—Å—å–æ–≥–æ</th></tr>';

    FOR rec IN cur_periods LOOP
        DECLARE
            v_start DATE := rec.start_time;
            v_end   DATE := rec.end_time;
        BEGIN
            IF rec.period = '–ó –ø–æ—á–∞—Ç–∫—É –∑–º—ñ–Ω–∏' THEN
                v_start := v_shift_start;
                v_end   := v_shift_end;
            END IF;

            -- –ë—Ä–∏–≥–∞–¥ —Ñ—ñ—Ä–º–∏
            SELECT 
                NVL(SUM(CASE WHEN unit = 0 THEN 1 ELSE 0 END), 0),
                NVL(SUM(CASE WHEN unit = 1 THEN 1 ELSE 0 END), 0),
                NVL(SUM(CASE WHEN unit = 2 THEN 1 ELSE 0 END), 0),
                COUNT(*)
            INTO v_unit1, v_unit2, v_unit3, v_total
            FROM your_view
            WHERE org = 1
              AND (v_end IS NULL OR data_start BETWEEN v_start AND v_end)
              AND department MEMBER OF v_departments_tbl;

            v_html := v_html || '<tr><td rowspan="4">' || rec.period || '</td><td>–ë—Ä–∏–≥–∞–¥ —Ñ—ñ—Ä–º–∏</td><td>' || v_unit1 || '</td><td>' || v_unit2 || '</td><td>' || v_unit3 || '</td><td>' || v_total || '</td></tr>';

            -- –ë—Ä–∏–≥–∞–¥ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤
            SELECT 
                NVL(SUM(CASE WHEN unit = 0 THEN 1 ELSE 0 END), 0),
                NVL(SUM(CASE WHEN unit = 1 THEN 1 ELSE 0 END), 0),
                NVL(SUM(CASE WHEN unit = 2 THEN 1 ELSE 0 END), 0),
                COUNT(*)
            INTO v_unit1, v_unit2, v_unit3, v_total
            FROM your_view
            WHERE org = 0
              AND (v_end IS NULL OR data_start BETWEEN v_start AND v_end)
              AND department MEMBER OF v_departments_tbl;

            v_html := v_html || '<tr><td>–ë—Ä–∏–≥–∞–¥ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤</td><td>' || v_unit1 || '</td><td>' || v_unit2 || '</td><td>' || v_unit3 || '</td><td>' || v_total || '</td></tr>';

            -- –õ—é–¥–µ–π —Ñ—ñ—Ä–º–∏
            SELECT 
                NVL(SUM(CASE WHEN unit = 0 THEN team_count ELSE 0 END), 0),
                NVL(SUM(CASE WHEN unit = 1 THEN team_count ELSE 0 END), 0),
                NVL(SUM(CASE WHEN unit = 2 THEN team_count ELSE 0 END), 0),
                NVL(SUM(team_count), 0)
            INTO v_unit1, v_unit2, v_unit3, v_total
            FROM your_view
            WHERE org = 1
              AND (v_end IS NULL OR data_start BETWEEN v_start AND v_end)
              AND department MEMBER OF v_departments_tbl;

            v_html := v_html || '<tr><td>–õ—é–¥–µ–π —Ñ—ñ—Ä–º–∏</td><td>' || v_unit1 || '</td><td>' || v_unit2 || '</td><td>' || v_unit3 || '</td><td>' || v_total || '</td></tr>';

            -- –õ—é–¥–µ–π –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤
            SELECT 
                NVL(SUM(CASE WHEN unit = 0 THEN team_count ELSE 0 END), 0),
                NVL(SUM(CASE WHEN unit = 1 THEN team_count ELSE 0 END), 0),
                NVL(SUM(CASE WHEN unit = 2 THEN team_count ELSE 0 END), 0),
                NVL(SUM(team_count), 0)
            INTO v_unit1, v_unit2, v_unit3, v_total
            FROM your_view
            WHERE org = 0
              AND (v_end IS NULL OR data_start BETWEEN v_start AND v_end)
              AND department MEMBER OF v_departments_tbl;

            v_html := v_html || '<tr><td>–õ—é–¥–µ–π –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤</td><td>' || v_unit1 || '</td><td>' || v_unit2 || '</td><td>' || v_unit3 || '</td><td>' || v_total || '</td></tr>';
        END;
    END LOOP;

    v_html := v_html || '</table>';
    RETURN v_html;
EXCEPTION
    WHEN OTHERS THEN
        RETURN '–ü–æ–º–∏–ª–∫–∞: ' || SQLERRM;
END;
/
```

---

## üì• –£ APEX

1. –°—Ç–≤–æ—Ä–∏ **Checkbox Group**: `P1_DEPARTMENTS`
   - LOV:  
     ```sql
     SELECT DISTINCT department d, department r FROM your_view
     ```

2. –°—Ç–≤–æ—Ä–∏ **Dynamic Content Region**
   - PL/SQL Function Returning CLOB:
     ```plsql
     BEGIN
       RETURN get_unit_matrix_html(apex_util.table_to_string(apex_util.string_to_table(:P1_DEPARTMENTS)));
     END;
     ```

3. –î–æ–¥–∞–π **Dynamic Action** on change `P1_DEPARTMENTS` ‚Üí Refresh —Ä–µ–≥—ñ–æ–Ω

---

–•–æ—á–µ—à ‚Äî —è –∑—Ä–æ–±–ª—é —Ç–æ–±—ñ —â–µ **–ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π JSON APEX-–µ–∫—Å–ø–æ—Ä—Ç** –∞–±–æ –¥–æ–¥–∞—Ç–∫–æ–≤—É –ø—ñ–¥—Ç—Ä–∏–º–∫—É –ø–æ UI?