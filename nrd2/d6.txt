–û–∫–µ–π! –ù–∏–∂—á–µ ‚Äî **–ø–æ–≤–Ω–∞ PL/SQL-—Ñ—É–Ω–∫—Ü—ñ—è `get_unit_matrix_html`**, —è–∫–∞:

---

## üîß –†–µ–∞–ª—ñ–∑—É—î:
- HTML-—Ç–∞–±–ª–∏—Ü—é –∑ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫–∞–º–∏ (–±—Ä–∏–≥–∞–¥–∏, –ª—é–¥–∏)
- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äî **–≤–±—É–¥–æ–≤–∞–Ω–µ JavaScript-–ø–æ—Å–∏–ª–∞–Ω–Ω—è**, —â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑—ñ –∑–≤—ñ—Ç–æ–º
- –ü–µ—Ä–µ–¥–∞—î –ø–∞—Ä–∞–º–µ—Ç—Ä–∏:
  - —á–∞—Å–æ–≤–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª (`NOW`, `DAY`, `SHIFT`)
  - —Ç–∏–ø (`firm` / `contractor`)
  - unit (0,1,2)
  - –∫–æ–ª–æ–Ω–∫—É: `type=people|teams`
  - —Ñ—ñ–ª—å—Ç—Ä–∏ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤

---

## ‚úÖ –ü–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è `get_unit_matrix_html`:

```plsql
CREATE OR REPLACE FUNCTION get_unit_matrix_html (
    p_departments IN VARCHAR2 -- —Å–ø–∏—Å–æ–∫: 'DEP1:DEP2:DEP3'
) RETURN CLOB IS
    v_html       CLOB := '';
    v_unit1      NUMBER;
    v_unit2      NUMBER;
    v_unit3      NUMBER;
    v_total      NUMBER;

    -- –∑–º—ñ–Ω–∞
    v_shift_start DATE;
    v_shift_end   DATE;

    CURSOR cur_periods IS
      SELECT 'NOW' AS code, '–ó–∞—Ä–∞–∑' AS label FROM DUAL
      UNION ALL
      SELECT 'DAY', '–ó –ø–æ—á–∞—Ç–∫—É –¥–æ–±–∏' FROM DUAL
      UNION ALL
      SELECT 'SHIFT', '–ó –ø–æ—á–∞—Ç–∫—É –∑–º—ñ–Ω–∏' FROM DUAL;

    TYPE v_dep_table IS TABLE OF VARCHAR2(4000);
    v_departments_tbl v_dep_table := apex_string.split(p_departments, ':');

    FUNCTION build_cell_link(p_value NUMBER, p_mode VARCHAR2, p_org NUMBER, p_unit NUMBER, p_type VARCHAR2) RETURN VARCHAR2 IS
    BEGIN
        RETURN '<a href="javascript:void(0);" onclick=' ||
               '''openUnitModal(''' || p_mode || ''',''' || p_org || ''',''' || p_unit || ''',''' || p_type || ''');''' || '">' ||
               TO_CHAR(p_value) || '</a>';
    END;
BEGIN
    -- –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –∑–º—ñ–Ω–∏
    IF TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '06:00' AND '13:59' THEN
        v_shift_start := TRUNC(SYSDATE) + 6/24;
        v_shift_end   := TRUNC(SYSDATE) + 14/24;
    ELSIF TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '14:00' AND '21:59' THEN
        v_shift_start := TRUNC(SYSDATE) + 14/24;
        v_shift_end   := TRUNC(SYSDATE) + 22/24;
    ELSE
        IF TO_CHAR(SYSDATE, 'HH24:MI') >= '22:00' THEN
            v_shift_start := TRUNC(SYSDATE) + 22/24;
            v_shift_end   := TRUNC(SYSDATE + 1) + 6/24;
        ELSE
            v_shift_start := TRUNC(SYSDATE - 1) + 22/24;
            v_shift_end   := TRUNC(SYSDATE) + 6/24;
        END IF;
    END IF;

    v_html := '<table border="1" cellpadding="5" cellspacing="0">';
    v_html := v_html || '<tr><th>–ß–∞—Å</th><th>–¢–∏–ø</th><th>Unit 1</th><th>Unit 2</th><th>Unit 3</th><th>–í—Å—å–æ–≥–æ</th></tr>';

    FOR rec IN cur_periods LOOP
        DECLARE
            v_start DATE;
            v_end   DATE;
            v_label VARCHAR2(100) := rec.label;
            v_code  VARCHAR2(10) := rec.code;
        BEGIN
            IF rec.code = 'NOW' THEN
                v_start := SYSDATE;
                v_end := NULL;
            ELSIF rec.code = 'DAY' THEN
                v_start := TRUNC(SYSDATE);
                v_end := SYSDATE;
            ELSE
                v_start := v_shift_start;
                v_end := SYSDATE;
            END IF;

            -- –ë—Ä–∏–≥–∞–¥ —Ñ—ñ—Ä–º–∏ (org = 1)
            SELECT 
                COUNT(CASE WHEN unit = 0 THEN 1 END),
                COUNT(CASE WHEN unit = 1 THEN 1 END),
                COUNT(CASE WHEN unit = 2 THEN 1 END),
                COUNT(*)
            INTO v_unit1, v_unit2, v_unit3, v_total
            FROM your_view
            WHERE org = 1
              AND (v_end IS NULL OR data_start BETWEEN v_start AND v_end)
              AND department MEMBER OF v_departments_tbl;

            v_html := v_html || '<tr><td rowspan="4">' || v_label || '</td><td>–ë—Ä–∏–≥–∞–¥ —Ñ—ñ—Ä–º–∏</td>' ||
              '<td>' || build_cell_link(v_unit1, v_code, 1, 0, 'teams') || '</td>' ||
              '<td>' || build_cell_link(v_unit2, v_code, 1, 1, 'teams') || '</td>' ||
              '<td>' || build_cell_link(v_unit3, v_code, 1, 2, 'teams') || '</td>' ||
              '<td>' || v_total || '</td></tr>';

            -- –ë—Ä–∏–≥–∞–¥ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤ (org = 0)
            SELECT 
                COUNT(CASE WHEN unit = 0 THEN 1 END),
                COUNT(CASE WHEN unit = 1 THEN 1 END),
                COUNT(CASE WHEN unit = 2 THEN 1 END),
                COUNT(*)
            INTO v_unit1, v_unit2, v_unit3, v_total
            FROM your_view
            WHERE org = 0
              AND (v_end IS NULL OR data_start BETWEEN v_start AND v_end)
              AND department MEMBER OF v_departments_tbl;

            v_html := v_html || '<tr><td>–ë—Ä–∏–≥–∞–¥ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤</td>' ||
              '<td>' || build_cell_link(v_unit1, v_code, 0, 0, 'teams') || '</td>' ||
              '<td>' || build_cell_link(v_unit2, v_code, 0, 1, 'teams') || '</td>' ||
              '<td>' || build_cell_link(v_unit3, v_code, 0, 2, 'teams') || '</td>' ||
              '<td>' || v_total || '</td></tr>';

            -- –õ—é–¥–µ–π —Ñ—ñ—Ä–º–∏
            SELECT 
                SUM(CASE WHEN unit = 0 THEN team_count ELSE 0 END),
                SUM(CASE WHEN unit = 1 THEN team_count ELSE 0 END),
                SUM(CASE WHEN unit = 2 THEN team_count ELSE 0 END),
                SUM(team_count)
            INTO v_unit1, v_unit2, v_unit3, v_total
            FROM your_view
            WHERE org = 1
              AND (v_end IS NULL OR data_start BETWEEN v_start AND v_end)
              AND department MEMBER OF v_departments_tbl;

            v_html := v_html || '<tr><td>–õ—é–¥–µ–π —Ñ—ñ—Ä–º–∏</td>' ||
              '<td>' || build_cell_link(v_unit1, v_code, 1, 0, 'people') || '</td>' ||
              '<td>' || build_cell_link(v_unit2, v_code, 1, 1, 'people') || '</td>' ||
              '<td>' || build_cell_link(v_unit3, v_code, 1, 2, 'people') || '</td>' ||
              '<td>' || v_total || '</td></tr>';

            -- –õ—é–¥–µ–π –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤
            SELECT 
                SUM(CASE WHEN unit = 0 THEN team_count ELSE 0 END),
                SUM(CASE WHEN unit = 1 THEN team_count ELSE 0 END),
                SUM(CASE WHEN unit = 2 THEN team_count ELSE 0 END),
                SUM(team_count)
            INTO v_unit1, v_unit2, v_unit3, v_total
            FROM your_view
            WHERE org = 0
              AND (v_end IS NULL OR data_start BETWEEN v_start AND v_end)
              AND department MEMBER OF v_departments_tbl;

            v_html := v_html || '<tr><td>–õ—é–¥–µ–π –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—ñ–≤</td>' ||
              '<td>' || build_cell_link(v_unit1, v_code, 0, 0, 'people') || '</td>' ||
              '<td>' || build_cell_link(v_unit2, v_code, 0, 1, 'people') || '</td>' ||
              '<td>' || build_cell_link(v_unit3, v_code, 0, 2, 'people') || '</td>' ||
              '<td>' || v_total || '</td></tr>';

        END;
    END LOOP;

    v_html := v_html || '</table>';
    RETURN v_html;
EXCEPTION
    WHEN OTHERS THEN
        RETURN '–ü–æ–º–∏–ª–∫–∞: ' || SQLERRM;
END;
/
```

---

## ‚úÖ –î–æ–¥–∞–π –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ JavaScript —Ñ—É–Ω–∫—Ü—ñ—é `openUnitModal`

```js
function openUnitModal(timeMode, org, unit, type) {
  apex.server.process("OPEN_UNIT_MODAL", {
    x01: timeMode,
    x02: org,
    x03: unit,
    x04: type,
    x05: $v("P1_DEPARTMENTS")
  }, {
    success: function() {
      apex.navigation.dialog.open({
        pageId: "P_MODAL_UNIT_STATS",
        dialog: "modal",
        modal: true,
        title: "–î–µ—Ç–∞–ª—ñ"
      });
    }
  });
}
```

---

## ‚úÖ –£ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ:
- –ü—Ä–∏–π–º–∞—î –ø–∞—Ä–∞–º–µ—Ç—Ä–∏: `P_MODAL_TIMEMODE`, `P_MODAL_ORG`, `P_MODAL_UNIT`, `P_MODAL_TYPE`, `P_MODAL_DEPARTMENTS`
- SQL —Ñ–æ—Ä–º—É—î –∑–≤—ñ—Ç —É –ø–æ—Ç—Ä—ñ–±–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ, —Ñ—ñ–ª—å—Ç—Ä—É—é—á–∏ –ø–æ –Ω–∏—Ö

---

üîß –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äî —è –º–æ–∂—É –Ω–∞–¥–∞—Ç–∏ —Ç–∞–∫–æ–∂ SQL –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –∑–≤—ñ—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç—ñ ‚Äú–ú–∞–ª—é–Ω–æ–∫ 2‚Äù. –ù–∞–ø–∏—Å–∞—Ç–∏ –π–æ–≥–æ?