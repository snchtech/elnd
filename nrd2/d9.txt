–ó–≤–∏—á–∞–π–Ω–æ! –î–∞–≤–∞–π —Ä–æ–∑–±–µ—Ä–µ–º–æ —Ü–µ–π SQL-–∫–æ–¥ –ø–æ–µ—Ç–∞–ø–Ω–æ ‚Äî –≤—ñ–Ω –≥–µ–Ω–µ—Ä—É—î —Ç–∞–±–ª–∏—á–∫—É —É —Ñ–æ—Ä–º–∞—Ç—ñ ‚Äú–ú–∞–ª—é–Ω–æ–∫ 2‚Äù —ñ–∑ –ø—ñ–¥—Å—É–º–∫–∞–º–∏ –ø–æ —Ñ—ñ—Ä–º–∞—Ö, –ø—ñ–¥—Ä—è–¥–Ω–∏–∫–∞—Ö —ñ –∑–∞–≥–∞–ª–æ–º.

---

## üîÅ –ó–∞–≥–∞–ª—å–Ω–∏–π —Å–µ–Ω—Å:

SQL-–∑–∞–ø–∏—Ç:
1. **–§—ñ–ª—å—Ç—Ä—É—î –∑–∞–ø–∏—Å–∏ –∑ view** –∑–≥—ñ–¥–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤: —á–∞—Å, –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª, unit
2. **–ì—Ä—É–ø—É—î —ó—Ö –ø–æ –≤—ñ–¥–¥—ñ–ª—É –∞–±–æ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫—É + unit**
3. **–ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î (pivot)** –≤ 1 —Ä—è–¥–æ–∫ –Ω–∞ –≥—Ä—É–ø—É, –¥–µ —î –æ–∫—Ä–µ–º—ñ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è:
   - `Unit1: –ª—é–¥–∏`, `Unit1: –±—Ä–∏–≥–∞–¥`
   - `Unit2: –ª—é–¥–∏`, `...`
   - `Unit3: ...`
   - `–í—Å—å–æ–≥–æ`
4. –î–æ–¥–∞—î —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ä—è–¥–æ–∫ `–£—Å—å–æ–≥–æ`

---

## üîé –ü–æ—è—Å–Ω–µ–Ω–Ω—è –ø–æ —á–∞—Å—Ç–∏–Ω–∞—Ö:

---

### üîπ `base_data AS (...)`

**–í–∏—Ç—è–≥—É—î –∑ view –ª–∏—à–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑–∞–ø–∏—Å–∏**, –∑–∞ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏:

```sql
WHERE outfit_open = 6
```
üü° –ë–µ—Ä–µ —Ç—ñ–ª—å–∫–∏ —Ç—ñ –∑–∞–ø–∏—Å–∏, —è–∫—ñ –∞–∫—Ç–∏–≤–Ω—ñ / –≤—ñ–¥–∫—Ä–∏—Ç—ñ.

```sql
AND (
  (:P_MODAL_TIMEMODE = 'NOW' AND data_start <= SYSDATE)
  OR (:P_MODAL_TIMEMODE = 'DAY' AND data_start BETWEEN TRUNC(SYSDATE) AND SYSDATE)
  OR (:P_MODAL_TIMEMODE = 'SHIFT' AND data_start BETWEEN :P_SHIFT_START AND SYSDATE)
)
```
üü¢ –§—ñ–ª—å—Ç—Ä—É—î –ø–æ **—á–∞—Å–æ–≤–æ–º—É —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É**:
- `NOW` ‚Äî —É—Å–µ –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç—É
- `DAY` ‚Äî –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –¥–æ–±–∏
- `SHIFT` ‚Äî –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –∑–º—ñ–Ω–∏ (`P_SHIFT_START`)  
*–¶–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–æ–≥–æ, —â–æ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è —É `:P_MODAL_TIMEMODE`.*

```sql
AND (:P_MODAL_ORG IS NULL OR org = TO_NUMBER(:P_MODAL_ORG))
```
üü£ –§—ñ–ª—å—Ç—Ä –∑–∞ `org` (—Ñ—ñ—Ä–º–∞ / –ø—ñ–¥—Ä—è–¥–Ω–∏–∫) ‚Äî —è–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–∏–π.

```sql
AND (:P_MODAL_UNIT IS NULL OR unit = TO_NUMBER(:P_MODAL_UNIT))
```
üîµ –§—ñ–ª—å—Ç—Ä –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º —é–Ω—ñ—Ç–æ–º, —è–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–∏–π.

```sql
AND (
  :P_MODAL_DEPARTMENTS IS NULL 
  OR department IN (
    SELECT column_value FROM TABLE(apex_string.split(:P_MODAL_DEPARTMENTS, ':'))
  )
)
```
üü§ –§—ñ–ª—å—Ç—Ä –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–º–∏ `departments` (checkbox –≥—Ä—É–ø–∞).

---

### üîπ `agg_data AS (...)`

**–ê–≥—Ä–µ–≥–∞—Ü—ñ—è** –¥–∞–Ω–∏—Ö –∑ `base_data`:
```sql
CASE WHEN org = 1 THEN department ELSE org_txt END AS group_name
```
- –Ø–∫—â–æ —Ñ—ñ—Ä–º–∞ ‚Üí –≥—Ä—É–ø—É—î–º–æ –ø–æ `department`
- –Ø–∫—â–æ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫ ‚Üí –ø–æ `org_txt` (–Ω–∞–∑–≤–∞ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫–∞)

```sql
COUNT(id_outfit) AS brigades
SUM(team_count) AS people
```
- –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫: —Å–∫—ñ–ª—å–∫–∏ –±—Ä–∏–≥–∞–¥, —Å–∫—ñ–ª—å–∫–∏ –ª—é–¥–µ–π

–ì—Ä—É–ø—É—î–º–æ –ø–æ `group_name`, `org`, `unit`

---

### üîπ `pivoted AS (...)`

–¢—É—Ç –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è **pivot (—Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è)** –¥–∞–Ω–∏—Ö –ø–æ –∫–æ–ª–æ–Ω–∫–∞—Ö:

```sql
NVL(SUM(CASE WHEN unit = 0 THEN people END), 0) AS u1_people,
NVL(SUM(CASE WHEN unit = 0 THEN brigades END), 0) AS u1_brigades,
...
```
- –§–æ—Ä–º—É—î–º–æ –æ–∫—Ä–µ–º—ñ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ unit —ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∞ (–ª—é–¥–µ–π, –±—Ä–∏–≥–∞–¥)
- –î–æ–¥–∞—î–º–æ `total_people`, `total_brigades` ‚Äî –ø—ñ–¥—Å—É–º–∫–∏ –ø–æ —Ä—è–¥–∫—É

---

### üîπ `final_union AS (...)`

–û–±‚Äô—î–¥–Ω—É—î–º–æ:
- –í—Å—ñ —Å—Ç—Ä–æ–∫–∏ –∑ pivoted
- –û–¥–∏–Ω –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä—è–¥–æ–∫: **"–£—Å—å–æ–≥–æ"**

```sql
SELECT '–£—Å—å–æ–≥–æ' AS group_name,
...
SUM(...) AS u1_people, ...
```
üü¢ –¶–µ –∑–∞–≥–∞–ª—å–Ω—ñ —Å—É–º–∏ –ø–æ –≤—Å—ñ—Ö –≥—Ä—É–ø–∞—Ö.

---

### üîπ –§—ñ–Ω–∞–ª—å–Ω–∏–π SELECT

```sql
ORDER BY
  CASE 
    WHEN group_name = '–£—Å—å–æ–≥–æ' THEN 9999
    WHEN org = 1 THEN 1  -- —Ñ—ñ—Ä–º–∏ (–≤—ñ–¥–¥—ñ–ª–∏)
    WHEN org = 0 THEN 2  -- –ø—ñ–¥—Ä—è–¥–Ω–∏–∫–∏
    ELSE 3
  END,
  group_name;
```
üîΩ –°–æ—Ä—Ç—É—î:
- –°–ø–æ—á–∞—Ç–∫—É —Ñ—ñ—Ä–º–∏
- –ü–æ—Ç—ñ–º –ø—ñ–¥—Ä—è–¥–Ω–∏–∫–∏
- –í –∫—ñ–Ω—Ü—ñ ‚Äî `–£—Å—å–æ–≥–æ`

---

## üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç (–ø—Ä–æ—Å—Ç–∏–π –ø—Ä–∏–∫–ª–∞–¥):

| group_name     | u1_people | u1_brigades | u2_people | u2_brigades | u3_people | u3_brigades | total_people | total_brigades |
|----------------|-----------|-------------|-----------|-------------|-----------|-------------|---------------|----------------|
| –í—ñ–¥–¥—ñ–ª ‚Ññ1      | 100       | 10          | 80        | 7           | 10        | 2           | 190           | 19             |
| –í—ñ–¥–¥—ñ–ª ‚Ññ2      | ...       | ...         | ...       | ...         | ...       | ...         | ...           | ...            |
| –ü—ñ–¥—Ä—è–¥–Ω–∏–∫ ‚Ññ1   | 50        | 5           | 20        | 2           | 10        | 1           | 80            | 8              |
| –£—Å—å–æ–≥–æ         | 150       | 15          | 100       | 9           | 20        | 3           | 270           | 27             |

---

## üß† –ü—ñ–¥—Å—É–º–æ–∫

| CTE             | –û–ø–∏—Å |
|----------------|------|
| `base_data`     | —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ —á–∞—Å—É / org / –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª–∞—Ö |
| `agg_data`      | –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è –ø–æ org_txt –∞–±–æ department |
| `pivoted`       | —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –ø–æ –∫–æ–ª–æ–Ω–∫–∞—Ö Unit1/2/3 |
| `final_union`   | –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø—ñ–¥—Å—É–º–∫–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞ |

---

–•–æ—á–µ—à ‚Äî –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ —Ü–µ–π SQL –ø—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –Ω–∞–∑–≤—É —Ç–≤–æ—î—ó view –∞–±–æ –∑—Ä–æ–±–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ü—å–æ–≥–æ JSON.