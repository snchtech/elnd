–û—Å—å –ø–æ–≤–Ω—ñ—Å—Ç—é **–ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞** –≤–µ—Ä—Å—ñ—è —Ñ—É–Ω–∫—Ü—ñ—ó `get_unit_quick_stats`, —è–∫–∞:

- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `SYS.ODCIVARCHAR2LIST` –∑–∞–º—ñ—Å—Ç—å `t_varchar2_tab`
- –ó–∞—Å—Ç–æ—Å–æ–≤—É—î `split_string` –¥–ª—è —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è `p_departments`
- –ü—Ä–∞—Ü—é—î –∑ —É–º–æ–≤–æ—é `IN (SELECT COLUMN_VALUE FROM TABLE(...))` –∑–∞–º—ñ—Å—Ç—å `MEMBER OF`

---

### ‚úÖ **–û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è**
```sql
CREATE OR REPLACE FUNCTION get_unit_quick_stats (
    p_unit         IN NUMBER,
    p_departments  IN VARCHAR2 DEFAULT NULL, -- 'DEP1:DEP2'
    p_date_start   IN DATE DEFAULT NULL,
    p_date_end     IN DATE DEFAULT NULL
) RETURN CLOB IS
    v_html        CLOB := '';
    v_firm_brig   NUMBER := 0;
    v_cont_brig   NUMBER := 0;
    v_firm_people NUMBER := 0;
    v_cont_people NUMBER := 0;

    v_end         DATE;
    v_has_date    BOOLEAN := FALSE;

    v_dep_tbl SYS.ODCIVARCHAR2LIST := SYS.ODCIVARCHAR2LIST();
BEGIN
    -- –†–æ–∑–±–∏—Ç–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∏, —è–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ
    IF p_departments IS NOT NULL THEN
        v_dep_tbl := split_string(p_departments, ':');
    END IF;

    -- –í–∏–∑–Ω–∞—á–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä –ø–æ —á–∞—Å—É
    IF p_date_start IS NOT NULL THEN
        v_has_date := TRUE;
        v_end := NVL(p_date_end, SYSDATE);
    ELSIF p_date_end IS NOT NULL THEN
        v_has_date := TRUE;
        v_end := p_date_end;
    END IF;

    -- –ë—Ä–∏–≥–∞–¥–∏
    SELECT 
      COUNT(CASE WHEN org = 0 THEN 1 END),  -- —Ñ—ñ—Ä–º–∞
      COUNT(CASE WHEN org = 1 THEN 1 END)   -- –ø—ñ–¥—Ä—è–¥–Ω–∏–∫
    INTO v_firm_brig, v_cont_brig
    FROM your_view
    WHERE unit = p_unit
      AND outfit_open = 6
      AND (
        p_departments IS NULL 
        OR department IN (SELECT COLUMN_VALUE FROM TABLE(v_dep_tbl))
      )
      AND (
        NOT v_has_date OR (
          (p_date_start IS NULL OR data_start >= p_date_start) AND
          (p_date_end IS NULL OR data_start <= v_end)
        )
      );

    -- –õ—é–¥–∏
    SELECT 
      NVL(SUM(CASE WHEN org = 0 THEN team_count ELSE 0 END), 0),  -- —Ñ—ñ—Ä–º–∞
      NVL(SUM(CASE WHEN org = 1 THEN team_count ELSE 0 END), 0)   -- –ø—ñ–¥—Ä—è–¥–Ω–∏–∫
    INTO v_firm_people, v_cont_people
    FROM your_view
    WHERE unit = p_unit
      AND outfit_open = 6
      AND (
        p_departments IS NULL 
        OR department IN (SELECT COLUMN_VALUE FROM TABLE(v_dep_tbl))
      )
      AND (
        NOT v_has_date OR (
          (p_date_start IS NULL OR data_start >= p_date_start) AND
          (p_date_end IS NULL OR data_start <= v_end)
        )
      );

    -- HTML
    v_html := '–ü–æ Unit: ' || p_unit || '<br>' ||
              v_firm_brig || ' –±—Ä–∏–≥–∞–¥ –§—ñ—Ä–º–∞, ' || v_cont_brig || ' –ü—ñ–¥—Ä—è–¥–Ω–∏–∫–∏<br>' ||
              v_firm_people || ' —á–æ–ª. –§—ñ—Ä–º–∞, ' || v_cont_people || ' –ü—ñ–¥—Ä—è–¥–Ω–∏–∫–∏';

    RETURN v_html;

EXCEPTION
    WHEN OTHERS THEN
        RETURN '–ü–æ–º–∏–ª–∫–∞: ' || SQLERRM;
END;
```

---

### üß™ –ü—Ä–∏–º—ñ—Ç–∫–∞:

- `split_string` –ø–æ–≤–µ—Ä—Ç–∞—î `SYS.ODCIVARCHAR2LIST`, —Ç–æ–∂ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–≥–æ–ª–æ—à—É–≤–∞—Ç–∏ –æ–∫—Ä–µ–º–∏–π `TYPE`.
- –¢–∞–∫–∏–π –ø—ñ–¥—Ö—ñ–¥ **–ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ —É Oracle 12+**.
- –£—Å—ñ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –≥–Ω—É—á–∫—ñ: —è–∫—â–æ `p_departments` = `NULL` –∞–±–æ `p_date_start` –Ω–µ –≤–∫–∞–∑–∞–Ω–æ ‚Äî –Ω—ñ—á–æ–≥–æ –Ω–µ —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç—å—Å—è.

–•–æ—á–µ—à, –º–æ–∂—É –¥–æ–¥–∞—Ç–∏ –∞–≤—Ç–æ—Ç–µ—Å—Ç –∞–±–æ –ø—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–ª–∏–∫—É.