–û—Å—å –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è —Ñ—É–Ω–∫—Ü—ñ—ó `get_unit_quick_stats`, –∞–¥–∞–ø—Ç–æ–≤–∞–Ω–∞ –ø—ñ–¥ –Ω–æ–≤—É –ª–æ–≥—ñ–∫—É, –¥–µ `your_view` –º–æ–∂–µ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ **–¥–µ–∫—ñ–ª—å–∫–∞ —Ä—è–¥–∫—ñ–≤ –Ω–∞ `id_outfit`** —á–µ—Ä–µ–∑ —Ä—ñ–∑–Ω—ñ `status_start_date` / `status_end_date`, —ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å —É —á–∞—Å–æ–≤–æ–º—É —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ.

---

### ‚úÖ –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞:

1. –Ø–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ `p_date_start` —ñ/–∞–±–æ `p_date_end` ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Å—Ç–∞—Ç—É—Å 6 **–ø–µ—Ä–µ—Ç–∏–Ω–∞—î—Ç—å—Å—è** –∑ —Ü–∏–º —ñ–Ω—Ç–µ—Ä–≤–∞–ª–æ–º.
2. –Ø–∫—â–æ –¥–∞—Ç–∏ –Ω–µ –∑–∞–¥–∞–Ω—ñ ‚Üí –±–µ—Ä–µ–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ —Ä—è–¥–∫–∏, –¥–µ `status_end_date IS NULL`, –∞ `status_start_date < SYSDATE`.
3. –ó–∞–º—ñ—Å—Ç—å `data_start` —Ç–µ–ø–µ—Ä —É —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `status_start_date` —ñ `status_end_date`.

---

### üß© –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó:

| –°—Ü–µ–Ω–∞—Ä—ñ–π | –§—ñ–ª—å—Ç—Ä |
|----------|--------|
| `status_start_date < p_date_end` AND `p_date_start < status_end_date OR status_end_date IS NULL` | –∫–æ–ª–∏ –∑–∞–¥–∞–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª |
| `status_start_date < SYSDATE AND status_end_date IS NULL` | –∫–æ–ª–∏ –¥–∞—Ç–∏ –Ω–µ –∑–∞–¥–∞–Ω—ñ |

---

### ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è:

```plsql
CREATE OR REPLACE FUNCTION get_unit_quick_stats (
    p_unit         IN NUMBER,
    p_departments  IN VARCHAR2 DEFAULT NULL,
    p_date_start   IN DATE DEFAULT NULL,
    p_date_end     IN DATE DEFAULT NULL
) RETURN CLOB IS
    v_html        CLOB := '';
    v_firm_brig   NUMBER := 0;
    v_cont_brig   NUMBER := 0;
    v_firm_people NUMBER := 0;
    v_cont_people NUMBER := 0;

    v_dep_tbl SYS.ODCIVARCHAR2LIST := SYS.ODCIVARCHAR2LIST();
    v_now     DATE := SYSDATE;
BEGIN
    IF p_departments IS NOT NULL THEN
        v_dep_tbl := split_string(p_departments, ':');
    END IF;

    -- –ë—Ä–∏–≥–∞–¥–∏
    SELECT 
      COUNT(CASE WHEN org = 0 THEN 1 END),  -- —Ñ—ñ—Ä–º–∞
      COUNT(CASE WHEN org = 1 THEN 1 END)   -- –ø—ñ–¥—Ä—è–¥–Ω–∏–∫
    INTO v_firm_brig, v_cont_brig
    FROM your_view
    WHERE unit = p_unit
      AND outfit_open = 6
      AND (
        p_departments IS NULL 
        OR department IN (SELECT column_value FROM TABLE(v_dep_tbl))
      )
      AND (
        -- –Ø–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ —á–∞—Å–æ–≤–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª
        (
          p_date_start IS NOT NULL OR p_date_end IS NOT NULL
        AND
          (
            status_start_date < NVL(p_date_end, v_now) AND
            (status_end_date IS NULL OR NVL(p_date_start, TO_DATE('1900','YYYY')) < status_end_date)
          )
        )
        -- –Ø–∫—â–æ —á–∞—Å–æ–≤–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ –∑–∞–¥–∞–Ω–æ
        OR (
          p_date_start IS NULL AND p_date_end IS NULL AND
          status_start_date < v_now AND status_end_date IS NULL
        )
      );

    -- –õ—é–¥–∏
    SELECT 
      NVL(SUM(CASE WHEN org = 0 THEN team_count ELSE 0 END), 0),  -- —Ñ—ñ—Ä–º–∞
      NVL(SUM(CASE WHEN org = 1 THEN team_count ELSE 0 END), 0)   -- –ø—ñ–¥—Ä—è–¥–Ω–∏–∫
    INTO v_firm_people, v_cont_people
    FROM your_view
    WHERE unit = p_unit
      AND outfit_open = 6
      AND (
        p_departments IS NULL 
        OR department IN (SELECT column_value FROM TABLE(v_dep_tbl))
      )
      AND (
        (
          p_date_start IS NOT NULL OR p_date_end IS NOT NULL
        AND
          (
            status_start_date < NVL(p_date_end, v_now) AND
            (status_end_date IS NULL OR NVL(p_date_start, TO_DATE('1900','YYYY')) < status_end_date)
          )
        )
        OR (
          p_date_start IS NULL AND p_date_end IS NULL AND
          status_start_date < v_now AND status_end_date IS NULL
        )
      );

    v_html := '–ü–æ Unit: ' || p_unit || '<br>' ||
              v_firm_brig || ' –±—Ä–∏–≥–∞–¥ –§—ñ—Ä–º–∞, ' || v_cont_brig || ' –ü—ñ–¥—Ä—è–¥–Ω–∏–∫–∏<br>' ||
              v_firm_people || ' —á–æ–ª. –§—ñ—Ä–º–∞, ' || v_cont_people || ' –ü—ñ–¥—Ä—è–¥–Ω–∏–∫–∏';

    RETURN v_html;

EXCEPTION
    WHEN OTHERS THEN
        RETURN '–ü–æ–º–∏–ª–∫–∞: ' || SQLERRM;
END;
```

---

### üîç –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ:

- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ `NVL(p_date_end, SYSDATE)` —ñ `NVL(p_date_start, '1900')`, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ null'—ñ–≤ —É –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞—Ö.
- `status_start_date < p_date_end` –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —â–æ —Å—Ç–∞—Ç—É—Å –ø–æ—á–∞–≤—Å—è **–¥–æ –∫—ñ–Ω—Ü—è —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É**.
- `status_end_date IS NULL OR status_end_date > p_date_start` –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —â–æ –≤—ñ–Ω **—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –¥–æ –ø–æ—á–∞—Ç–∫—É —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É**.

---

–ì–æ—Ç–æ–≤–∏–π –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ –¥–æ —ñ–Ω—à–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ JSON –∑–∞–º—ñ—Å—Ç—å CLOB) –∞–±–æ –≤–∏–≤–µ—Å—Ç–∏ —Ü–µ —É –≤–∏–≥–ª—è–¥—ñ SQL-–∑–∞–ø–∏—Ç—É, —è–∫—â–æ —Ö–æ—á–µ—à –∑–∞–º—ñ–Ω–∏—Ç–∏ —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é –Ω–∞ `SELECT` –¥–ª—è WebSocket-—Å—Ü–µ–Ω–∞—Ä—ñ—é.