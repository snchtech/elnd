–î–æ–±—Ä–µ, —Ä–æ–∑–±–µ—Ä–µ–º–æ —Å–∏—Ç—É–∞—Ü—ñ—é –¥–µ—Ç–∞–ª—å–Ω–æ. –£ –≤–∞—Å —î:

- `VIEW v_outfit_pivot_base`, —è–∫–∞ –∞–≥—Ä–µ–≥—É—î –¥–∞–Ω—ñ –∑–∞ `department` —ñ `org_txt`.
- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø–æ `status_start_date`, `status_end_date`, `department`, `unit`, `org`.
- –í–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ **–Ω–µ—Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è –¥–∞–Ω–∏—Ö** –∑ —Ñ—É–Ω–∫—Ü—ñ—î—é `get_unit_matrix_html`.

---

## üîç –ê–Ω–∞–ª—ñ–∑ –º–æ–∂–ª–∏–≤–∏—Ö –ø—Ä–∏—á–∏–Ω —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç–µ–π

### 1. **–ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –≤ `agg_data` –≤–∫–ª—é—á–∞—î `unit`**
–£ `agg_data` –≤–∏ **–≥—Ä—É–ø—É—î—Ç–µ** –∑–∞ `unit`, –∞ –¥–∞–ª—ñ –≤ `SELECT` –∑–Ω–æ–≤—É –∞–≥—Ä–µ–≥—É—î—Ç–µ –ø–æ `unit`:

```sql
NVL(SUM(CASE WHEN unit = 0 THEN people END), 0) AS u1_people,
...
```

üî∂ –¶–µ –æ–∑–Ω–∞—á–∞—î: **–∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫ –º—ñ—Å—Ç–∏—Ç—å —É–∂–µ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω `unit`**, —ñ –≤—Å—ñ —ñ–Ω—à—ñ ‚Äî `0`. –ê–ª–µ –≤–∏ –≤—Å–µ –æ–¥–Ω–æ –Ω–∞–º–∞–≥–∞—î—Ç–µ—Å—å **–∑—Ä–æ–±–∏—Ç–∏ pivot** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ —Ü—å–æ–º—É —Å–∞–º–æ–º—É `unit`.  
üü† –£ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ ‚Äî –¥—É–±–ª—é–≤–∞–Ω–Ω—è, –Ω–µ—Ç–æ—á–Ω–µ pivot-–∞–≥—Ä–µ–≥—É–≤–∞–Ω–Ω—è.

---

### ‚úÖ –†—ñ—à–µ–Ω–Ω—è: **–ø–µ—Ä–µ–Ω–µ—Å—ñ—Ç—å pivot-–∞–≥—Ä–µ–≥–∞—Ü—ñ—é –≤ –æ–∫—Ä–µ–º–∏–π —à–∞—Ä**
–ü–µ—Ä–µ—Ä–æ–±—ñ—Ç—å `agg_data` —Ç–∞–∫, —â–æ–± –≤–æ–Ω–∞ –Ω–µ –≤–∫–ª—é—á–∞–ª–∞ `unit` —É `GROUP BY`. –¢–æ–¥—ñ pivot-–∞–≥—Ä–µ–≥–∞—Ü—ñ—è –±—É–¥–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏:

```sql
WITH base_data AS (
  SELECT 
    id_outfit,
    org,
    org_txt,
    department,
    unit,
    team_count,
    data_start,
    status_start_date,
    status_end_date
  FROM TEST_OUTFIT_DATA
  WHERE outfit_open = 6
),
agg_data AS (
  SELECT
    CASE WHEN org = 0 THEN department ELSE org_txt END AS group_name,
    org,
    department,
    data_start,
    status_start_date,
    status_end_date,
    unit,
    COUNT(id_outfit) AS brigades,
    SUM(team_count) AS people
  FROM base_data
  GROUP BY
    CASE WHEN org = 0 THEN department ELSE org_txt END,
    org,
    department,
    unit,
    data_start,
    status_start_date,
    status_end_date
)
SELECT
  group_name,
  org,
  department,
  data_start,
  status_start_date,
  status_end_date,
  -- pivot aggregation
  NVL(SUM(CASE WHEN unit = 0 THEN people END), 0) AS u1_people,
  NVL(SUM(CASE WHEN unit = 0 THEN brigades END), 0) AS u1_brigades,
  NVL(SUM(CASE WHEN unit = 1 THEN people END), 0) AS u2_people,
  NVL(SUM(CASE WHEN unit = 1 THEN brigades END), 0) AS u2_brigades,
  NVL(SUM(CASE WHEN unit = 2 THEN people END), 0) AS u3_people,
  NVL(SUM(CASE WHEN unit = 2 THEN brigades END), 0) AS u3_brigades,
  SUM(people) AS total_people,
  SUM(brigades) AS total_brigades
FROM agg_data
GROUP BY
  group_name,
  org,
  department,
  data_start,
  status_start_date,
  status_end_date;
```

---

### 2. **`group_name` ‚â† `department`**
–í `group_name` –≤–∏ –º–∞—î—Ç–µ:

```sql
CASE WHEN org = 0 THEN department ELSE org_txt END AS group_name
```

–ê —É `WHERE` –≤–∏ —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç–µ –ø–æ `department`, –∞ –Ω–µ `group_name`. –Ø–∫—â–æ `org = 1`, —Ç–æ–¥—ñ `department` –º–æ–∂–µ –±—É—Ç–∏ –≤ `NULL`, –∞–±–æ –Ω–µ —Ç–∏–º, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ.

‚úÖ –†—ñ—à–µ–Ω–Ω—è:
- –Ø–∫—â–æ `group_name` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É `report`, —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—é –≤–∞—Ä—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑ `group_name`, –∞ –Ω–µ `department`.

–ê–±–æ —É `WHERE` –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —É–º–æ–≤–Ω—É —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—é:

```sql
AND (
  :P_MODAL_DEPARTMENTS IS NULL
  OR (
    (org = 0 AND department IN (SELECT COLUMN_VALUE FROM TABLE(split_string(:P_MODAL_DEPARTMENTS, ':'))))
    OR (org = 1 AND org_txt IN (SELECT COLUMN_VALUE FROM TABLE(split_string(:P_MODAL_DEPARTMENTS, ':'))))
  )
)
```

–Ø–∫—â–æ –≤–∏ —Ç–æ—á–Ω–æ –ø–µ—Ä–µ–¥–∞—î—Ç–µ –ª–∏—à–µ `department` ID (–∞ –Ω–µ `org_txt`), —Ç–æ–¥—ñ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –º–∞—î –±—É—Ç–∏ —Ç—ñ–ª—å–∫–∏ –¥–ª—è `org = 0`.

---

### 3. **–ú–æ–∂–ª–∏–≤—ñ –¥—É–±–ª—ñ–∫–∞—Ç–∏ outfit –ø–æ —á–∞—Å—É**
–£ `status_start_date`, `status_end_date` –º–æ–∂—É—Ç—å –±—É—Ç–∏ **–∫—ñ–ª—å–∫–∞ –∑–∞–ø–∏—Å—ñ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ `id_outfit`**, —ñ –≤–∏ —ó—Ö –Ω–µ –ø—Ä–∏–±–∏—Ä–∞—î—Ç–µ –ø–µ—Ä–µ–¥ `GROUP BY`, –æ—Ç–∂–µ:

- –í–æ–Ω–∏ –Ω–∞–∫–æ–ø–∏—á—É—é—Ç—å—Å—è —É `COUNT`, `SUM`.
- –î–∞–Ω—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–∞–≤–∏—â–µ–Ω—ñ.

‚úÖ –†—ñ—à–µ–Ω–Ω—è:
- –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ `DISTINCT id_outfit` –ø–µ—Ä–µ–¥ `GROUP BY`, –∞–±–æ –∞–≥—Ä–µ–≥–∞—Ü—ñ—é —Ç—ñ–ª—å–∫–∏ –ø–æ `id_outfit`, –æ–±–º–µ–∂–µ–Ω—É –Ω–∞–π–∞–∫—Ç—É–∞–ª—å–Ω—ñ—à–∏–º–∏ –∑–∞–ø–∏—Å–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –æ—Å—Ç–∞–Ω–Ω—ñ–π —Å—Ç–∞—Ç—É—Å).

---

## üìå –ü—ñ–¥—Å—É–º–æ–∫

### üîß –©–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏:
1. –ü—Ä–∏–±—Ä–∞—Ç–∏ `unit` –∑ `GROUP BY` –≤ `agg_data`.
2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ `group_name` = `department` —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ `org = 0`, —ñ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –ª–∏—à–µ —Ç–æ–¥—ñ.
3. –í—Ä–∞—Ö—É–≤–∞—Ç–∏ –º–æ–∂–ª–∏–≤–µ –¥—É–±–ª—é–≤–∞–Ω–Ω—è `id_outfit` ‚Äî –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ –∑—Ä–æ–±–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –∞–≥—Ä–µ–≥–∞—Ü—ñ—é.

### ‚ùì –ß–æ–º—É get_unit_matrix_html –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
- –í–æ–Ω–∞ **–≤–∏–∫–æ–Ω—É—î –æ–∫—Ä–µ–º–∏–π `SELECT` –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–∏–ø—É unit/org**, –±–µ–∑ `GROUP BY` –ø–æ –≤—Å—å–æ–º—É.
- –¢–æ–±—Ç–æ, –≤–æ–Ω–∞ –ø—Ä–∞—Ü—é—î –∑ –±–∞–∑–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏ –±–µ–∑ pivot-–∞–≥—Ä–µ–≥–∞—Ü—ñ—ó ‚Äî —Ç–æ–º—É —Ç–æ—á–Ω—ñ—à–µ.

---

–•–æ—á–µ—à ‚Äî —è –º–æ–∂—É –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ `view` —ñ `WHERE` –±–ª–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ü–∏—Ö –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å.