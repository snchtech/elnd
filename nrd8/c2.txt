–û—Å—å –æ–Ω–æ–≤–ª–µ–Ω–∏–π —Ç–∞ **–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç `view` `v_outfit_pivot_base`**, –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º:

- –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è `GROUP BY` (–±–µ–∑ `unit`);
- –ö–æ—Ä–µ–∫—Ç–Ω–æ—ó pivot-–∞–≥—Ä–µ–≥–∞—Ü—ñ—ó;
- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è `status_start_date`, `status_end_date` –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ—ó —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó;
- –°—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ APEX-–∑–∞–ø–∏—Ç–æ–º.

---

### üîß –û–Ω–æ–≤–ª–µ–Ω–∞ `VIEW v_outfit_pivot_base`

```sql
CREATE OR REPLACE FORCE VIEW v_outfit_pivot_base AS
WITH base_data AS (
  SELECT 
    id_outfit,
    org,
    org_txt,
    department,
    unit,
    team_count,
    data_start,
    status_start_date,
    status_end_date
  FROM TEST_OUTFIT_DATA
  WHERE outfit_open = 6
),
agg_data AS (
  SELECT
    -- –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è –ø–æ –Ω–∞–∑–≤—ñ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É –∞–±–æ –ø—ñ–¥—Ä—è–¥–Ω–∏–∫–∞
    CASE WHEN org = 0 THEN department ELSE org_txt END AS group_name,
    org,
    department,
    data_start,
    status_start_date,
    status_end_date,
    unit,
    COUNT(DISTINCT id_outfit) AS brigades,
    SUM(team_count) AS people
  FROM base_data
  GROUP BY
    CASE WHEN org = 0 THEN department ELSE org_txt END,
    org,
    department,
    unit,
    data_start,
    status_start_date,
    status_end_date
)
SELECT
  group_name,
  org,
  department,
  data_start,
  status_start_date,
  status_end_date,
  -- pivot –ø–æ unit
  NVL(SUM(CASE WHEN unit = 0 THEN people END), 0) AS u1_people,
  NVL(SUM(CASE WHEN unit = 0 THEN brigades END), 0) AS u1_brigades,
  NVL(SUM(CASE WHEN unit = 1 THEN people END), 0) AS u2_people,
  NVL(SUM(CASE WHEN unit = 1 THEN brigades END), 0) AS u2_brigades,
  NVL(SUM(CASE WHEN unit = 2 THEN people END), 0) AS u3_people,
  NVL(SUM(CASE WHEN unit = 2 THEN brigades END), 0) AS u3_brigades,
  SUM(people) AS total_people,
  SUM(brigades) AS total_brigades
FROM agg_data
GROUP BY
  group_name,
  org,
  department,
  data_start,
  status_start_date,
  status_end_date;
```

---

### ‚úÖ –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –≤ APEX (`WHERE`)

```sql
SELECT *
FROM v_outfit_pivot_base
WHERE 1 = 1
  -- –º–∞–π–±—É—Ç–Ω—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
  --AND (:P_MODAL_ORG IS NULL OR org = TO_NUMBER(:P_MODAL_ORG))
  --AND (:P_MODAL_UNIT IS NULL OR unit = TO_NUMBER(:P_MODAL_UNIT))
  AND (
    :P_MODAL_DEPARTMENTS IS NULL 
    OR department IN (
      SELECT column_value FROM TABLE(split_string(:P_MODAL_DEPARTMENTS, ':'))
    )
  )
  AND (
    (:P_MODAL_TIMEMODE = 'NOW' AND status_start_date < SYSDATE AND status_end_date IS NULL)
    OR (:P_MODAL_TIMEMODE = 'DAY' AND status_start_date < SYSDATE AND (status_end_date IS NULL OR status_end_date >= TRUNC(SYSDATE)))
    OR (:P_MODAL_TIMEMODE = 'SHIFT' AND status_start_date < SYSDATE AND (status_end_date IS NULL OR status_end_date >= :P_SHIFT_START))
  )
```

---

### üìù –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ

- –£ `GROUP BY` **unit –≤–∏–Ω–µ—Å–µ–Ω–∏–π –≤ agg_data**, –∞ –Ω–µ —É —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π select.
- `COUNT(DISTINCT id_outfit)` ‚Äî –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—É–±–ª—é–≤–∞–Ω–Ω—è outfit, —è–∫—â–æ –∑ —è–∫–æ—ó—Å—å –ø—Ä–∏—á–∏–Ω–∏ –≤ –±–∞–∑—ñ —î –æ–¥–Ω–∞–∫–æ–≤—ñ `id_outfit` –∑ —Ä—ñ–∑–Ω–∏–º `status_start_date`.
- –¢–∞–∫–∞ `view` –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å—É–º—ñ—Å–Ω–∞ –∑ –¥–∏–Ω–∞–º—ñ—á–Ω–æ—é —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é —É APEX —ñ –±—É–¥–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∞ –∑ –ª–æ–≥—ñ–∫–æ—é `get_unit_matrix_html`.

–ì–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏ –¥–∞–ª—ñ ‚Äî —è–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂—É —Ç–∞–∫–æ–∂ –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ `checkbox group LOV SQL`, —â–æ–± –≤—Ä–∞—Ö–æ–≤—É–≤–∞–ª–∞ —Ü—ñ –¥–∞–Ω—ñ.