–ß—É–¥–æ–≤–æ, —â–æ —Ç–∏ –≤–∏–∫–ª–∞–≤ –ø–æ–≤–Ω–∏–π –∫–æ–¥ ‚Äî —Ü–µ –¥–æ–∑–≤–æ–ª—è—î —Ç–æ—á–Ω–æ –≤–∏—è–≤–∏—Ç–∏ –¥–∂–µ—Ä–µ–ª–∞ –ø—Ä–æ–±–ª–µ–º. –†–æ–∑–≥–ª—è–Ω–µ–º–æ:

---

## üî¥ **1. –ü–æ–º–∏–ª–∫–∞ `ORA-30482: DISTINCT option not allowed for this function`**

–¶–µ –æ–±–º–µ–∂–µ–Ω–Ω—è Oracle: —Ç–∏ **–Ω–µ –º–æ–∂–µ—à –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `DISTINCT` —É—Å–µ—Ä–µ–¥–∏–Ω—ñ `LISTAGG()`**, **—è–∫—â–æ —Ü–µ –Ω–µ —É –ø—ñ–¥–∑–∞–ø–∏—Ç—ñ**. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —Ç–∞–∫:

```sql
SELECT
  org,
  org_txt,
  (
    SELECT LISTAGG(department, ':') WITHIN GROUP (ORDER BY department)
    FROM (
      SELECT DISTINCT department
      FROM base_data d
      WHERE d.org = b.org AND d.org_txt = b.org_txt
    )
  ) AS dep_list
FROM base_data b
WHERE org != 0
GROUP BY org, org_txt
```

–û—Ç–∂–µ, –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ `org_departments` —Å–∞–º–µ –≤ —Ç–∞–∫–æ–º—É —Å—Ç–∏–ª—ñ (—á–µ—Ä–µ–∑ –ø—ñ–¥–∑–∞–ø–∏—Ç –∑ `DISTINCT`).

---

## üü† **2. –ü–æ–º–∏–ª–∫–∞ `ORA-00932: inconsistent datatypes: expected NUMBER got CHAR`**

–¶—è –ø–æ–º–∏–ª–∫–∞, –Ω–∞–π—ñ–º–æ–≤—ñ—Ä–Ω—ñ—à–µ, –≤–∏–Ω–∏–∫–∞—î —á–µ—Ä–µ–∑ —Ç–µ, —â–æ Oracle –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ `org` (NUMBER) –∑ —á–∏–º–æ—Å—å, —â–æ —Å—Ç–∞–ª–æ `CHAR`, –º–æ–∂–ª–∏–≤–æ, –ø—ñ—Å–ª—è `LEFT JOIN`, –¥–µ `d.org` —Å—Ç–∞–ª–æ NULL —ñ –¥–µ—Å—å —Ç–∏–ø `VARCHAR`.

–©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏:
- **–∑–∞–≤–∂–¥–∏ —Ä–æ–±–∏ CAST —É –≤–∏—Ä–∞–∑–∞—Ö, —è–∫—ñ –∑–º—ñ—à—É—é—Ç—å —Ç–∏–ø–∏**, –∞–±–æ **–ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∏–ø–∏ –∑–±—ñ–≥–∞—é—Ç—å—Å—è –≤ JOIN —ñ CASE**.
- `dep_list` ‚Äî —Ü–µ `VARCHAR2`, —ñ –∫–æ–ª–∏ —Ç–∏ –ø–∏—à–µ—à `group_name := CASE ... THEN department ELSE org_txt || ' (' || dep_list || ')'`, –≤–æ–Ω–æ –º–æ–∂–µ —Å–ø—Ä–∏–π–º–∞—Ç–∏—Å—å –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ. –ó—Ä–æ–±–∏ `TO_CHAR(department)` –≤ –ø–µ—Ä—à—ñ–π –≥—ñ–ª—Ü—ñ –∞–±–æ –æ–±–≥–æ—Ä–Ω–∏ –æ–±–∏–¥–≤–∞ `TO_CHAR(...)`.

---

## ‚úÖ **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è VIEW:**

```sql
CREATE OR REPLACE FORCE EDITIONABLE VIEW V_OUTFIT_PIVOT_BASE AS
WITH base_data AS (
  SELECT 
    id_outfit,
    org,
    org_txt,
    department,
    unit,
    team_count,
    data_start,
    status_start_date,
    status_end_date
  FROM TEST_OUTFIT_DATA
  WHERE outfit_open = 6
),
org_departments AS (
  SELECT
    b.org,
    b.org_txt,
    (
      SELECT LISTAGG(d.department, ':') WITHIN GROUP (ORDER BY d.department)
      FROM (
        SELECT DISTINCT department
        FROM base_data d
        WHERE d.org = b.org AND d.org_txt = b.org_txt
      ) d
    ) AS dep_list
  FROM base_data b
  WHERE b.org != 0
  GROUP BY b.org, b.org_txt
),
agg_data AS (
  SELECT
    CASE 
      WHEN b.org = 0 THEN TO_CHAR(b.department)
      ELSE d.org_txt || ' (' || d.dep_list || ')' 
    END AS group_name,
    b.org,
    b.unit,
    b.department,
    b.data_start,
    b.status_start_date,
    b.status_end_date,
    COUNT(b.id_outfit) AS brigades,
    SUM(b.team_count) AS people
  FROM base_data b
  LEFT JOIN org_departments d 
    ON b.org = d.org AND b.org_txt = d.org_txt
  GROUP BY
    CASE 
      WHEN b.org = 0 THEN TO_CHAR(b.department)
      ELSE d.org_txt || ' (' || d.dep_list || ')' 
    END,
    b.org,
    b.unit,
    b.department,
    b.data_start,
    b.status_start_date,
    b.status_end_date
)
SELECT
  group_name,
  org,
  unit,
  department,
  data_start,
  status_start_date,
  status_end_date,
  NVL(SUM(CASE WHEN unit = 0 THEN people END), 0) AS u1_people,
  NVL(SUM(CASE WHEN unit = 0 THEN brigades END), 0) AS u1_brigades,
  NVL(SUM(CASE WHEN unit = 1 THEN people END), 0) AS u2_people,
  NVL(SUM(CASE WHEN unit = 1 THEN brigades END), 0) AS u2_brigades,
  NVL(SUM(CASE WHEN unit = 2 THEN people END), 0) AS u3_people,
  NVL(SUM(CASE WHEN unit = 2 THEN brigades END), 0) AS u3_brigades,
  SUM(people) AS total_people,
  SUM(brigades) AS total_brigades
FROM agg_data
GROUP BY
  group_name,
  org,
  unit,
  department,
  data_start,
  status_start_date,
  status_end_date;
```

---

## üîç –ü–æ—è—Å–Ω–µ–Ω–Ω—è –∫–ª—é—á–æ–≤–∏—Ö –º–æ–º–µ–Ω—Ç—ñ–≤:

| –ë–ª–æ–∫            | –ó–º—ñ–Ω–∞                                         |
|------------------|-----------------------------------------------|
| `LISTAGG`        | –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –≤–∫–ª–∞–¥–µ–Ω–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç —ñ–∑ `DISTINCT` |
| `group_name`     | –û–±–∏–¥–≤—ñ –≥—ñ–ª–∫–∏ `CASE` –º–∞—é—Ç—å —Ç–∏–ø `VARCHAR2`     |
| `JOIN`           | –í–∏—Ä—ñ–≤–Ω—è–Ω–æ `org`, `org_txt` –ø–æ —Ç–∏–ø–∞—Ö          |

---

–•–æ—á–µ—à ‚Äî –º–æ–∂—É –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–ª—è —Ü—å–æ–≥–æ view –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ç–µ—Å—Ç-–∑–∞–ø–∏—Ç, —è–∫–∏–π –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –∞–≥—Ä–µ–≥–∞—Ç–∏ –ø–æ –≤—ñ–¥–æ–º–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö. –•–æ—á–µ—à?