–ó—Ä–æ–∑—É–º—ñ–ª–æ, –¥—è–∫—É—é! –¢–æ–±—Ç–æ, —è–∫—â–æ:

* **—î –≤—ñ–¥–∫—Ä–∏—Ç–∞ —Å–µ—Å—ñ—è**,
* **—ñ –≤–æ–Ω–∞ —Ç—Ä–∏–≤–∞—î –±—ñ–ª—å—à–µ 12 –≥–æ–¥–∏–Ω**,

—Ç–æ:

üëâ **—Ç—ñ–ª—å–∫–∏ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ —ó—ó** (`logout_date := now`, `close_reason := 'AUTO_TIMEOUT'`),
**–∞–ª–µ –Ω–µ —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É**.
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ ‚Äî **–ø–æ–∫–∞–∑—É—î–º–æ –¥—ñ–∞–ª–æ–≥ (mode\_id = 2)**.

---

### ‚úÖ –û–ù–û–í–õ–ï–ù–ò–ô –í–ê–†–Ü–ê–ù–¢ –±–ª–æ–∫—É `IF l_op = 1 THEN`

–û—Å—å —è–∫ –≤–∏–≥–ª—è–¥–∞—Ç–∏–º–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ª–æ–≥—ñ–∫–∞:

```plsql
IF l_op = 1 /* AUTO */ THEN
  IF l_open_id IS NULL THEN
    -- –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó —Å–µ—Å—ñ—ó ‚Äî –≤—Å–µ –¥–æ–±—Ä–µ, –º–æ–∂–Ω–∞ –ª–æ–≥—ñ–Ω–∏—Ç–∏
    INSERT INTO user_sessions (user_id, login_date)
      VALUES (l_user_id, l_now)
      RETURNING id INTO l_open_id;

    put_log(l_user_id, l_open_id, 'LOGIN', 'SUCCESS');

    apex_json.write('ok', true);
    apex_json.write('mode_id', 1); -- LOGIN_DONE
    apex_json.write('sessionId', l_open_id);
    apex_json.write('loginTs', TO_CHAR(l_now AT LOCAL TIME ZONE, 'dd.mm.yyyy hh24:mi'));

  ELSE
    -- –Ñ –∞–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—ñ—è
    IF l_now - l_login_dt > INTERVAL '12' HOUR THEN
      -- –í–æ–Ω–∞ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞ ‚Äì –∑–∞–∫—Ä–∏–≤–∞—î–º–æ —ó—ó
      UPDATE user_sessions
         SET logout_date = l_now,
             close_reason_id = lu.close_id('AUTO_TIMEOUT')
       WHERE id = l_open_id;

      put_log(l_user_id, l_open_id, 'LOGOUT', 'SUCCESS');

      -- –ø–æ–∫–∞–∑—É—î–º–æ –¥—ñ–∞–ª–æ–≥ (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î —Å–∞–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–π—Ç–∏)
      apex_json.write('ok', true);
      apex_json.write('mode_id', 2); -- HAS_OPEN_SESSION (–∞–ª–µ –≤–∂–µ –∑–∞–∫—Ä–∏—Ç–∞)
      apex_json.write('sessionId', l_open_id);
      apex_json.write('openLoginTs', TO_CHAR(l_login_dt AT LOCAL TIME ZONE, 'dd.mm.yyyy hh24:mi'));
      apex_json.write('message', '–°–µ—Å—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ.');
    ELSE
      -- –°–µ—Å—ñ—è —â–µ –∞–∫—Ç–∏–≤–Ω–∞ —ñ –Ω–µ –ø–µ—Ä–µ–≤–∏—â–∏–ª–∞ 12 –≥–æ–¥ ‚Äì –ø–æ–∫–∞–∑—É—î–º–æ –¥—ñ–∞–ª–æ–≥
      apex_json.write('ok', true);
      apex_json.write('mode_id', 2); -- HAS_OPEN_SESSION
      apex_json.write('sessionId', l_open_id);
      apex_json.write('openLoginTs', TO_CHAR(l_login_dt AT LOCAL TIME ZONE, 'dd.mm.yyyy hh24:mi'));
    END IF;
  END IF;
```

---

### üîç –ü–æ—è—Å–Ω–µ–Ω–Ω—è

| –£–º–æ–≤–∞                 | –î—ñ—è                                                 |
| --------------------- | --------------------------------------------------- |
| –ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó —Å–µ—Å—ñ—ó | –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É                                      |
| –Ñ —Å–µ—Å—ñ—è < 12 –≥–æ–¥      | –ü–æ–∫–∞–∑—É—î–º–æ –¥—ñ–∞–ª–æ–≥                                    |
| –Ñ —Å–µ—Å—ñ—è > 12 –≥–æ–¥      | –ó–∞–∫—Ä–∏–≤–∞—î–º–æ + –ø–æ–∫–∞–∑—É—î–º–æ –¥—ñ–∞–ª–æ–≥ (–±–µ–∑ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó) |

---

–Ø–∫—â–æ —Ç—Ä–µ–±–∞ ‚Äî –º–æ–∂—É –≤–±—É–¥—É–≤–∞—Ç–∏ —Ü–µ–π –∫–æ–¥ —É –ø–æ–≤–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É `BEGIN ... END`, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –≤—Å—é –∫–∞—Ä—Ç–∏–Ω—É.
