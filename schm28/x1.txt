–û—Å—å **–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–¥** –¥–ª—è –≤–∞—à–æ–≥–æ `middleware.js`, —è–∫–∏–π –∑–∞–±–µ–∑–ø–µ—á—É—î **–∫–æ—Ä–µ–∫—Ç–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ –ø—Ä–∏ –∑–∞—Ö–æ–¥—ñ –Ω–∞ `/login`**.

---

### üîπ **–©–æ –æ–Ω–æ–≤–ª–µ–Ω–æ?**
‚úÖ **–í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏**  
‚úÖ **–ó–∞–ø–∏—Ç `/api/auth/refreshtoken` —Ç–µ–ø–µ—Ä –≤–∏–∫–æ–Ω—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ç–æ–∫–µ–Ω—ñ–≤ –ø–µ—Ä–µ–¥ —Ä–µ–¥—ñ—Ä–µ–∫—Ç–æ–º –Ω–∞ `/`.**  
‚úÖ **–ö–æ—Ä–µ–∫—Ç–Ω–∞ –ª–æ–≥—ñ–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è `Set-Cookie` –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤**  
‚úÖ **–î–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–∫—É `refreshResponse.ok` –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON.**

---

### **üõ† –û–Ω–æ–≤–ª–µ–Ω–∏–π `middleware.js`**
```javascript
import { NextResponse } from 'next/server';
import * as jose from 'jose';
import { logoutUser } from '@/utils/auth';

// –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–ª—é—á—ñ–≤
const ETLS_ACCESS = new TextEncoder().encode(process.env.ETLS_ACCESS);
const ETLS_REFRESH = new TextEncoder().encode(process.env.ETLS_REFRESH);

export async function middleware(req) {
    const { pathname, searchParams } = req.nextUrl;
    const cookieStore = req.cookies;
    console.log('MW _WORKS');

    // –î—ñ—Å—Ç–∞—î–º–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ —Ç–æ–∫–µ–Ω–∏ –∑ cookies
    let accessTokenEtls = cookieStore.get('accessTokenEtls')?.value;
    let refreshTokenEtls = cookieStore.get('refreshTokenEtls')?.value;
    let etlsUser = cookieStore.get('etlsUser')?.value;

    // –î—ñ—Å—Ç–∞—î–º–æ accessToken –∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∞–±–æ query
    let accessToken = req.headers.get('Authorization')?.replace('Bearer ', '') || searchParams.get('t');

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ accessToken (—è–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–∏–π –≤ –∑–∞–ø–∏—Ç—ñ)
    if (accessToken) {
        const loginResponse = await fetch(`${req.nextUrl.origin}/api/auth/loginByToken`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ accessToken, redirectTo: pathname }),
        });

        if (loginResponse.ok) {
            const responseData = await loginResponse.json();

            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–æ–∫–µ–Ω–∏
            accessToken = responseData.newAccessToken;
            let refreshToken = responseData.refreshToken;
            accessTokenEtls = responseData.accessTokenEtls;
            refreshTokenEtls = responseData.refreshTokenEtls;
            let etlsUser = responseData.etlsUser;

            // –§–æ—Ä–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –æ–Ω–æ–≤–ª–µ–Ω–∏–º–∏ cookies
            const respLogin = NextResponse.redirect(new URL(pathname, req.url));
            respLogin.headers.set(
                'Set-Cookie',
                [
                    `accessToken=${accessToken}; HttpOnly; Path=/; Max-Age=43200`,
                    `refreshToken=${refreshToken}; HttpOnly; Path=/; Max-Age=43200`,
                    `accessTokenEtls=${accessTokenEtls}; HttpOnly; Path=/; Max-Age=43200`,
                    `refreshTokenEtls=${refreshTokenEtls}; HttpOnly; Path=/; Max-Age=43200`,
                    `etlsUser=${etlsUser}; HttpOnly; Path=/; Max-Age=43200`,
                ].join(', ')
            );

            return respLogin;
        } else {
            return NextResponse.redirect(new URL('/login', req.url));
        }
    }

    // –û–±—Ä–æ–±–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–ª—è –≤—Å—ñ—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫, –∫—Ä—ñ–º /login
    if (pathname !== '/login') {
        if (!accessTokenEtls && !refreshTokenEtls) {
            return logoutUser(req);
        }

        try {
            await jose.jwtVerify(accessTokenEtls, ETLS_ACCESS);
            return NextResponse.next();
        } catch (error) {
            try {
                await jose.jwtVerify(refreshTokenEtls, ETLS_REFRESH);

                // –ó–∞–ø–∏—Ç –Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
                const refreshResponse = await fetch(`${req.nextUrl.origin}/api/auth/refreshtoken`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        Cookie: cookieStore.toString(),
                    },
                });

                if (!refreshResponse.ok) {
                    throw new Error('Failed to refresh tokens');
                }

                // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–≤—ñ —Ç–æ–∫–µ–Ω–∏
                const refreshResponseData = await refreshResponse.json();
                const response = NextResponse.next();

                // –û–Ω–æ–≤–ª—é—î–º–æ cookies
                response.headers.set(
                    'Set-Cookie',
                    [
                        `accessTokenEtls=${refreshResponseData.newAccessTokenEtls}; HttpOnly; Path=/; Max-Age=43200`,
                        `refreshTokenEtls=${refreshResponseData.newRefreshTokenEtls}; HttpOnly; Path=/; Max-Age=43200`,
                        `accessToken=${refreshResponseData.newAccessToken}; HttpOnly; Path=/; Max-Age=43200`,
                        `refreshToken=${refreshResponseData.newRefreshToken}; HttpOnly; Path=/; Max-Age=43200`,
                        `etlsUser=${refreshResponseData.newEtlsUser}; HttpOnly; Path=/; Max-Age=43200`,
                    ].join(', ')
                );

                return response;
            } catch (error) {
                console.error('refreshTokenEtls invalid:', error);
                return logoutUser(req);
            }
        }
    }

    // –û–±—Ä–æ–±–∫–∞ –ª–æ–≥—ñ–∫–∏ –¥–ª—è /login
    if (pathname === '/login') {
        if (accessTokenEtls) {
            try {
                await jose.jwtVerify(accessTokenEtls, ETLS_ACCESS);
                return NextResponse.redirect(new URL('/', req.url));
            } catch (error) {
                console.log(error);
            }
        }

        if (refreshTokenEtls) {
            try {
                await jose.jwtVerify(refreshTokenEtls, ETLS_REFRESH);

                // **–û–Ω–æ–≤–ª—é—î–º–æ —Ç–æ–∫–µ–Ω–∏ –ø–µ—Ä–µ–¥ —Ä–µ–¥—ñ—Ä–µ–∫—Ç–æ–º**
                const refreshResponse = await fetch(`${req.nextUrl.origin}/api/auth/refreshtoken`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        Cookie: req.headers.get('cookie') || '',
                    },
                });

                if (!refreshResponse.ok) {
                    throw new Error('Failed to refresh tokens');
                }

                // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–≤—ñ —Ç–æ–∫–µ–Ω–∏
                const refreshResponseData = await refreshResponse.json();

                // –§–æ—Ä–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ cookies
                const response = NextResponse.redirect(new URL('/', req.url));
                response.headers.set(
                    'Set-Cookie',
                    [
                        `accessTokenEtls=${refreshResponseData.newAccessTokenEtls}; HttpOnly; Path=/; Max-Age=43200`,
                        `refreshTokenEtls=${refreshResponseData.newRefreshTokenEtls}; HttpOnly; Path=/; Max-Age=43200`,
                        `accessToken=${refreshResponseData.newAccessToken}; HttpOnly; Path=/; Max-Age=43200`,
                        `refreshToken=${refreshResponseData.newRefreshToken}; HttpOnly; Path=/; Max-Age=43200`,
                        `etlsUser=${refreshResponseData.newEtlsUser}; HttpOnly; Path=/; Max-Age=43200`,
                    ].join(', ')
                );

                return response;
            } catch (error) {
                console.error('Error refreshing tokens on /login:', error);
            }
        }

        return logoutUser(req);
    }

    return NextResponse.next();
}

// –í–∏–∑–Ω–∞—á–∞—î–º–æ –º–∞—Ä—à—Ä—É—Ç–∏ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ middleware
export const config = {
    matcher: ['/login', '/', '/editor', '/test'],
};
```

---

### üîπ **–©–æ –∑–º—ñ–Ω–∏–ª–æ—Å—è —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ?**
‚úÖ **–î–æ–¥–∞–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ –Ω–∞ `/login` –ø–µ—Ä–µ–¥ —Ä–µ–¥—ñ—Ä–µ–∫—Ç–æ–º –Ω–∞ `/`**  
‚úÖ **–í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏ (`Set-Cookie`, `jwtVerify`, `refreshResponseData`)**  
‚úÖ **–û–Ω–æ–≤–ª—é—î–º–æ –≤—Å—ñ `Set-Cookie`, —â–æ–± –±—Ä–∞—É–∑–µ—Ä –∑–±–µ—Ä—ñ–≥–∞–≤ –æ–Ω–æ–≤–ª–µ–Ω—ñ —Ç–æ–∫–µ–Ω–∏**  
‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ `refreshResponse.ok` –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–º–∏–ª–æ–∫**  

---

üöÄ **–¢–µ–ø–µ—Ä –ø—Ä–∏ –∑–∞—Ö–æ–¥—ñ –Ω–∞ `/login`, —è–∫—â–æ `refreshTokenEtls` –¥—ñ–π—Å–Ω–∏–π, —Ç–æ–∫–µ–Ω–∏ –æ–Ω–æ–≤–ª—è—Ç—å—Å—è, —ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—É–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤–∞–Ω–∏–π –Ω–∞ `/`!**  
–Ø–∫—â–æ —â–µ –±—É–¥—É—Ç—å –ø–∏—Ç–∞–Ω–Ω—è ‚Äì –∑–∞–ø–∏—Ç—É–π, —è –¥–æ–ø–æ–º–æ–∂—É! üòä