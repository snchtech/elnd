–û—Å—å –ø–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–Ω–æ–ø–∫–∏ **"–†–µ–¥–∞–≥—É–≤–∞—Ç–∏"**, –≤–∫–ª—é—á–∞—é—á–∏ **Next.js endpoint —Ç–∞ SQL**.

---

## **1. –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" —É `SchemeReport`**
–ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏", –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞–ø–∏—Ç –¥–æ `/api/rest/editScheme`, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î **ID –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó** (—ñ—Å–Ω—É—é—á–æ—ó –∞–±–æ –Ω–æ–≤–æ—ó). –ü—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è ID **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –≤ `editor`**.

### **–û–Ω–æ–≤–ª–µ–Ω–∏–π `SchemeReport.js`**
```tsx
import { useState, useEffect } from "react";
import { useRouter } from "next/router";
import {
  Table, TableBody, TableCell, TableContainer, TableHead, TableRow, IconButton,
  Typography, Button, Dialog, DialogActions, DialogContent, DialogContentText,
  DialogTitle, Paper, TablePagination
} from "@mui/material";
import { Visibility, Edit, Archive } from "@mui/icons-material";
import { fetchSchemes, editScheme } from "@/utils/api";

const SchemeReport = ({ albumId, userRole, mode }) => {
  const router = useRouter();
  const [schemes, setSchemes] = useState([]);
  const [page, setPage] = useState(0);
  const [rowsPerPage] = useState(15);

  useEffect(() => {
    const loadSchemes = async () => {
      try {
        const data = await fetchSchemes(albumId);
        setSchemes(data);
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ö–µ–º:", error);
      }
    };

    loadSchemes();
  }, [albumId]);

  const handleEditScheme = async (schemeId) => {
    try {
      const response = await editScheme(schemeId);
      router.push(`/editor/${response.scheme_version_id}?mode=editor`);
    } catch (error) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Å—Ö–µ–º–∏:", error);
    }
  };

  return (
    <TableContainer component={Paper}>
      <Table>
        <TableHead>
          <TableRow>
            <TableCell>–ü–µ—Ä–µ–≥–ª—è–¥</TableCell>
            <TableCell>ID</TableCell>
            <TableCell>–ù–∞–∑–≤–∞</TableCell>
            {mode === "editor" && userRole === "editor" && <TableCell>–î—ñ—ó</TableCell>}
          </TableRow>
        </TableHead>
        <TableBody>
          {schemes.slice(page * rowsPerPage, page * rowsPerPage + rowsPerPage).map((scheme) => (
            <TableRow key={scheme.id}>
              <TableCell>
                <IconButton onClick={() => router.push(`/schemes/${scheme.id}?mode=viewer`)}>
                  <Visibility />
                </IconButton>
              </TableCell>
              <TableCell>{scheme.id}</TableCell>
              <TableCell>{scheme.name}</TableCell>
              {mode === "editor" && userRole === "editor" && (
                <TableCell>
                  <IconButton onClick={() => handleEditScheme(scheme.id)}>
                    <Edit />
                  </IconButton>
                </TableCell>
              )}
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </TableContainer>
  );
};

export default SchemeReport;
```

---

## **2. –°—Ç–≤–æ—Ä—é—î–º–æ API-–µ–Ω–¥–ø–æ—ñ–Ω—Ç `/api/rest/editScheme.js`**
–¶–µ–π API:
1. **–ü–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó** (`is_stable = 1`).
2. **–ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ —î —Ä–µ–¥–∞–≥–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è** (`is_stable = 0`).
3. **–Ø–∫—â–æ —Ä–µ–¥–∞–≥–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è —î** ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î —ó—ó `scheme_version_id`.
4. **–Ø–∫—â–æ —Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó –Ω–µ–º–∞—î** ‚Üí —Å—Ç–≤–æ—Ä—é—î **–Ω–æ–≤—É** —ñ –ø–æ–≤–µ—Ä—Ç–∞—î —ó—ó `scheme_version_id`.

### **–§–∞–π–ª `/pages/api/rest/editScheme.js`**
```javascript
import { queryDatabase } from "@/utils/db";

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method Not Allowed" });
  }

  try {
    const { schemeId, userId } = req.body;

    if (!schemeId || !userId) {
      return res.status(400).json({ error: "–ù–µ–æ–±—Ö—ñ–¥–Ω—ñ schemeId —Ç–∞ userId" });
    }

    // 1. –û—Ç—Ä–∏–º—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—é —Å—Ç–∞–±—ñ–ª—å–Ω—É –∞–±–æ —Ä–µ–¥–∞–≥–æ–≤–∞–Ω—É –≤–µ—Ä—Å—ñ—é
    const versionQuery = `
      SELECT id, version_number, is_stable
      FROM SCHEME_VERSION
      WHERE scheme_id = :schemeId AND is_archived = 0
      ORDER BY is_stable DESC, created_at DESC
      FETCH FIRST 1 ROW ONLY
    `;
    const versionResult = await queryDatabase(versionQuery, { schemeId });

    if (versionResult.rows.length === 0) {
      return res.status(404).json({ error: "–°—Ç–∞–±—ñ–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞" });
    }

    const latestVersion = versionResult.rows[0];

    // –Ø–∫—â–æ —ñ—Å–Ω—É—î —Ä–µ–¥–∞–≥–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è (is_stable = 0) ‚Üí –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —ó—ó
    if (latestVersion.IS_STABLE === 0) {
      return res.status(200).json({ success: true, scheme_version_id: latestVersion.ID });
    }

    // 2. –Ø–∫—â–æ –Ω–µ–º–∞—î —Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó, —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é
    const newVersionNumber = latestVersion.VERSION_NUMBER + 1;
    const createVersionQuery = `
      INSERT INTO SCHEME_VERSION (scheme_id, version_number, is_stable, created_at, created_by)
      VALUES (:schemeId, :newVersionNumber, 0, SYSDATE, :userId)
      RETURNING id INTO :newVersionId
    `;

    const createVersionParams = {
      schemeId,
      newVersionNumber,
      userId,
      newVersionId: { dir: "out", type: "NUMBER" },
    };

    const createVersionResult = await queryDatabase(createVersionQuery, createVersionParams);

    res.status(201).json({ success: true, scheme_version_id: createVersionResult.outBinds.newVersionId });
  } catch (error) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Å—Ö–µ–º–∏:", error);
    res.status(500).json({ error: "Internal Server Error" });
  }
}
```

---

## **3. –î–æ–¥–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é `editScheme` —É `utils/api.js`**
```javascript
export const editScheme = async (schemeId) => {
  const response = await fetch("/api/rest/editScheme", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ schemeId, userId: 1 }), // TODO: –î–æ–¥–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π userId
  });

  if (!response.ok) {
    throw new Error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Å—Ö–µ–º–∏");
  }

  return response.json();
};
```

---

## **–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?**
1Ô∏è‚É£ **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" —É `SchemeReport`**.  
2Ô∏è‚É£ **–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è `POST` –∑–∞–ø–∏—Ç –Ω–∞ `/api/rest/editScheme`**.  
3Ô∏è‚É£ API:
   - **–®—É–∫–∞—î –æ—Å—Ç–∞–Ω–Ω—é —Å—Ç–∞–±—ñ–ª—å–Ω—É –∞–±–æ —Ä–µ–¥–∞–≥–æ–≤–∞–Ω—É –≤–µ—Ä—Å—ñ—é**.
   - –Ø–∫—â–æ **—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è —î** ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î —ó—ó `scheme_version_id`.
   - –Ø–∫—â–æ **–Ω–µ–º–∞—î** ‚Üí —Å—Ç–≤–æ—Ä—é—î **–Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é** (`is_stable = 0`).
4Ô∏è‚É£ **Next.js –æ—Ç—Ä–∏–º—É—î ID —Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó —Ç–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—î `/editor/{scheme_version_id}?mode=editor`**.  

---

## **–©–æ —â–µ –º–æ–∂–Ω–∞ –ø–æ–∫—Ä–∞—â–∏—Ç–∏?**
‚úÖ **–ü–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ `userId` –∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó** (–∑–∞–º—ñ—Å—Ç—å `1`).  
‚úÖ **–õ–æ–≥—É–≤–∞—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏** (–¥–æ–¥–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é `SCHEME_VERSION_LOG`).  
‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏, —á–∏ –≤–µ—Ä—Å—ñ—è –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∫–∏–º–æ—Å—å —ñ–Ω—à–∏–º** (`SELECT FOR UPDATE`).  

–ì–æ—Ç–æ–≤–æ! üéØ –¶–µ–π API **—Å—Ç–≤–æ—Ä—é—î —Ç–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—î —Ä–µ–¥–∞–≥–æ–≤–∞–Ω—É –≤–µ—Ä—Å—ñ—é —Å—Ö–µ–º–∏** –Ω–∞ —Ä—ñ–≤–Ω—ñ **Next.js + SQL**. üöÄ