–û—Å—å **—É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å `SAVE_SUBITEMS_FROM_COLLECTION`**, —è–∫–∏–π:

* –ü–µ—Ä–µ–≤—ñ—Ä—è—î `:P_TASK_MODE`
* –û–±—Ä–æ–±–ª—è—î:

  * –ö–æ–ª–µ–∫—Ü—ñ—é `TASK_SUBTASKS_COLLECTION` —è–∫—â–æ `:P_TASK_MODE = 0`
  * –ö–æ–ª–µ–∫—Ü—ñ—é `TASK_TEMPLATE_SUBTASKS_COLLECTION` —è–∫—â–æ `:P_TASK_MODE = 1`
* –ü—Ä–∞—Ü—é—î –∑ —É—Å—ñ–º–∞ —Ç—Ä—å–æ–º–∞ —Å—Ç–∞—Ç—É—Å–∞–º–∏: `NEW`, `EXISTING`, `DELETED`

---

## ‚úÖ –ö–æ–¥ –ø—Ä–æ—Ü–µ—Å—É `SAVE_SUBITEMS_FROM_COLLECTION`

```plsql
DECLARE
  v_id NUMBER;
BEGIN
  IF :P_TASK_MODE = '0' THEN
    -- üîπ INSERT –¥–ª—è TASK_SUBTASKS
    FOR r IN (
      SELECT c001, c003, c008, c009
      FROM apex_collections
      WHERE collection_name = 'TASK_SUBTASKS_COLLECTION'
        AND c010 = 'NEW'
    ) LOOP
      INSERT INTO TASK_SUBTASKS (
        TASK_ID,
        SUBTASK_CONTENT,
        PLANNING_DATE_END,
        PARENT_ID,
        SUBTASK_ORDER,
        STATUS_ID
      ) VALUES (
        :P_TASK_ID,
        r.c001,
        TO_DATE(r.c003, 'YYYY-MM-DD HH24:MI:SS'),
        TO_NUMBER(r.c009),
        TO_NUMBER(r.c008),
        1
      )
      RETURNING ID INTO v_id;
    END LOOP;

    -- üîπ UPDATE
    FOR r IN (
      SELECT c001, c002, c003, c008, c009
      FROM apex_collections
      WHERE collection_name = 'TASK_SUBTASKS_COLLECTION'
        AND c010 = 'EXISTING'
        AND c002 IS NOT NULL
    ) LOOP
      UPDATE TASK_SUBTASKS
      SET
        SUBTASK_CONTENT    = r.c001,
        PLANNING_DATE_END  = TO_DATE(r.c003, 'YYYY-MM-DD HH24:MI:SS'),
        PARENT_ID          = TO_NUMBER(r.c009),
        SUBTASK_ORDER      = TO_NUMBER(r.c008)
      WHERE ID = TO_NUMBER(r.c002);
    END LOOP;

    -- üîπ DELETE
    FOR r IN (
      SELECT c002
      FROM apex_collections
      WHERE collection_name = 'TASK_SUBTASKS_COLLECTION'
        AND c010 = 'DELETED'
        AND c002 IS NOT NULL
    ) LOOP
      DELETE FROM TASK_SUBTASKS WHERE ID = TO_NUMBER(r.c002);
    END LOOP;

    APEX_COLLECTION.DELETE_COLLECTION('TASK_SUBTASKS_COLLECTION');

  ELSIF :P_TASK_MODE = '1' THEN
    -- üîπ INSERT –¥–ª—è TASK_TEMPLATE_SUBTASKS
    FOR r IN (
      SELECT c001, c008, c009
      FROM apex_collections
      WHERE collection_name = 'TASK_TEMPLATE_SUBTASKS_COLLECTION'
        AND c010 = 'NEW'
    ) LOOP
      INSERT INTO TASK_TEMPLATE_SUBTASKS (
        TEMPLATE_ID,
        SUBTASK_CONTENT,
        STATUS_ID,
        PARENT_ID,
        SUBTASK_ORDER
      ) VALUES (
        :P_TEMPLATE_ID,
        r.c001,
        1,
        TO_NUMBER(r.c009),
        TO_NUMBER(r.c008)
      )
      RETURNING ID INTO v_id;
    END LOOP;

    -- üîπ UPDATE
    FOR r IN (
      SELECT c001, c002, c008, c009
      FROM apex_collections
      WHERE collection_name = 'TASK_TEMPLATE_SUBTASKS_COLLECTION'
        AND c010 = 'EXISTING'
        AND c002 IS NOT NULL
    ) LOOP
      UPDATE TASK_TEMPLATE_SUBTASKS
      SET
        SUBTASK_CONTENT    = r.c001,
        PARENT_ID          = TO_NUMBER(r.c009),
        SUBTASK_ORDER      = TO_NUMBER(r.c008)
      WHERE ID = TO_NUMBER(r.c002);
    END LOOP;

    -- üîπ DELETE
    FOR r IN (
      SELECT c002
      FROM apex_collections
      WHERE collection_name = 'TASK_TEMPLATE_SUBTASKS_COLLECTION'
        AND c010 = 'DELETED'
        AND c002 IS NOT NULL
    ) LOOP
      DELETE FROM TASK_TEMPLATE_SUBTASKS WHERE ID = TO_NUMBER(r.c002);
    END LOOP;

    APEX_COLLECTION.DELETE_COLLECTION('TASK_TEMPLATE_SUBTASKS_COLLECTION');
  END IF;
EXCEPTION
  WHEN OTHERS THEN
    raise_application_error(-20001, '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Å—ñ–≤: ' || SQLERRM);
END;
```

---

## üß© –î–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏?

* **–ü—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è** –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É (–∑–∞–≤–¥–∞–Ω–Ω—è –∞–±–æ —à–∞–±–ª–æ–Ω—É)
* –ú–æ–∂–µ—à –≤—Å—Ç–∞–≤–∏—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å —è–∫ `After Submit`, `Processing Point: After Submit` ‚Üí –ø—ñ—Å–ª—è INSERT/UPDATE –∑–∞–≤–¥–∞–Ω–Ω—è/—à–∞–±–ª–æ–Ω—É

---

## üîÑ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:

‚úÖ –•–æ—á–µ—à, —è –ø—ñ–¥–≥–æ—Ç—É—é –ø—Ä–∏–∫–ª–∞–¥ **–≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ä–º–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∑–∞–ø–∏—Å—É –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó**, –∞–±–æ **–≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ—î—Ä–∞—Ä—Ö—ñ—ó –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó –≤ IG**?
