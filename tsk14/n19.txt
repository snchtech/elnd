–ß—É–¥–æ–≤–æ, —Ç–µ–ø–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ **–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —ñ–∑ `APEX_COLLECTION` —É –ë–î** ‚Äî –∫–æ–ª–∏ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è **–∑–∞–≤–¥–∞–Ω–Ω—è** –∞–±–æ **—à–∞–±–ª–æ–Ω**, –≤—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è / –ø—ñ–¥—à–∞–±–ª–æ–Ω–∏, —è–∫—ñ –±—É–ª–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –∫–æ–ª–µ–∫—Ü—ñ—ó, –º–∞—é—Ç—å –±—É—Ç–∏ –∑–∞–ø–∏—Å–∞–Ω—ñ –≤ —Ç–∞–±–ª–∏—Ü—ñ `TASK_SUBTASKS` –∞–±–æ `TASK_TEMPLATE_SUBTASKS`.

---

## ‚úÖ –°—Ü–µ–Ω–∞—Ä—ñ–π

1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å—Ç–≤–æ—Ä—é—î –∑–∞–≤–¥–∞–Ω–Ω—è –∞–±–æ —à–∞–±–ª–æ–Ω.
2. –í –∫–æ–ª–µ–∫—Ü—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ø—ñ–¥–∑–∞–ø–∏—Å–∏ (`TASK_SUBTASKS_COLLECTION` –∞–±–æ `TASK_TEMPLATE_SUBTASKS_COLLECTION`)
3. –ü—ñ—Å–ª—è –≤—Å—Ç–∞–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ –≤ `TASKS`, –º–∏ –æ—Ç—Ä–∏–º—É—î–º–æ `v_task_id`
4. –ü–æ—Ç—ñ–º —É—Å—ñ –ø—ñ–¥–∑–∞–ø–∏—Å–∏ –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó –∫–æ–ø—ñ—é—é—Ç—å—Å—è –≤ –ë–î –∑ —Ü–∏–º `TASK_ID`

---

## üîß –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó (–Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è):

| C001             | C002 | C003                | C008  | C009       | C010   |
| ---------------- | ---- | ------------------- | ----- | ---------- | ------ |
| SUBTASK\_CONTENT | ID   | PLANNING\_DATE\_END | ORDER | PARENT\_ID | STATUS |

---

## üß© –ö–æ–¥ –≤—Å—Ç–∞–≤–∫–∏ –ø—ñ–¥–∑–∞–ø–∏—Å—ñ–≤ –ø—ñ—Å–ª—è `INSERT TASK` —á–∏ `INSERT TEMPLATE`

```plsql
-- –í—Å—Ç–∞–≤–∫–∞ –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è TASK –∞–±–æ TEMPLATE
DECLARE
  l_coll_name VARCHAR2(50);
  l_id_column VARCHAR2(50);
  l_main_id   NUMBER := :P_TASK_ID; -- –∞–±–æ :P_TEMPLATE_ID –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ task_mode

  -- –ú–∞–ø–∞: —Ç–∏–º—á–∞—Å–æ–≤–∏–π ID –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó ‚Üí –Ω–æ–≤–∏–π ID –≤ —Ç–∞–±–ª–∏—Ü—ñ
  TYPE t_id_map IS TABLE OF NUMBER INDEX BY VARCHAR2(255);
  l_id_map t_id_map;

  v_new_id TASK_SUBTASKS.ID%TYPE;

BEGIN
  l_coll_name := CASE :P_TASK_MODE
                   WHEN '0' THEN 'TASK_SUBTASKS_COLLECTION'
                   WHEN '1' THEN 'TASK_TEMPLATE_SUBTASKS_COLLECTION'
                 END;

  -- –ü–µ—Ä—à–∞ —Ñ–∞–∑–∞: –≤—Å—Ç–∞–≤–ª—è—î–º–æ –≤—Å—ñ –∑–∞–ø–∏—Å–∏, –±–µ–∑ PARENT_ID
  FOR rec IN (
    SELECT *
    FROM APEX_COLLECTIONS
    WHERE COLLECTION_NAME = l_coll_name
  ) LOOP
    IF :P_TASK_MODE = '0' THEN
      INSERT INTO TASK_SUBTASKS (
        ID, TASK_ID, SUBTASK_CONTENT, PLANNING_DATE_END,
        PARENT_ID, SUBTASK_ORDER, STATUS_ID
      ) VALUES (
        TASK_SUBTASKS_SEQ.NEXTVAL,
        l_main_id,
        rec.C001,
        TO_DATE(rec.C003, 'YYYY-MM-DD HH24:MI:SS'),
        NULL,
        TO_NUMBER(NVL(rec.C008, '1')),
        1
      )
      RETURNING ID INTO v_new_id;
    ELSE
      INSERT INTO TASK_TEMPLATE_SUBTASKS (
        ID, TEMPLATE_ID, SUBTASK_CONTENT,
        PARENT_ID, SUBTASK_ORDER, STATUS_ID
      ) VALUES (
        TASK_TEMPLATE_SUBTASKS_SEQ.NEXTVAL,
        l_main_id,
        rec.C001,
        NULL,
        TO_NUMBER(NVL(rec.C008, '1')),
        1
      )
      RETURNING ID INTO v_new_id;
    END IF;

    -- –ó–∞–ø–∞–º‚Äô—è—Ç–æ–≤—É—î–º–æ –Ω–æ–≤–∏–π ID
    l_id_map[rec.C002] := v_new_id;
  END LOOP;

  -- –î—Ä—É–≥–∞ —Ñ–∞–∑–∞: –æ–Ω–æ–≤–ª—é—î–º–æ PARENT_ID, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
  FOR rec IN (
    SELECT *
    FROM APEX_COLLECTIONS
    WHERE COLLECTION_NAME = l_coll_name
      AND C009 IS NOT NULL
  ) LOOP
    IF :P_TASK_MODE = '0' THEN
      UPDATE TASK_SUBTASKS
      SET PARENT_ID = l_id_map[rec.C009]
      WHERE TASK_ID = l_main_id AND ID = l_id_map[rec.C002];
    ELSE
      UPDATE TASK_TEMPLATE_SUBTASKS
      SET PARENT_ID = l_id_map[rec.C009]
      WHERE TEMPLATE_ID = l_main_id AND ID = l_id_map[rec.C002];
    END IF;
  END LOOP;

  -- ‚úÖ –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ–ª–µ–∫—Ü—ñ—é
  APEX_COLLECTION.DELETE_COLLECTION(l_coll_name);

EXCEPTION
  WHEN OTHERS THEN
    raise_application_error(-20001, '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤—Ü—ñ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å: ' || SQLERRM);
END;
```

---

## üìå –î–µ —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?

* –ü—ñ—Å–ª—è `INSERT_TASK` –∞–±–æ `INSERT_TEMPLATE` —É —Ç–æ–º—É –∂ `After Submit` –ø—Ä–æ—Ü–µ—Å—ñ.
* –ê–±–æ –æ–∫—Ä–µ–º–∏–º —Å–µ—Ä–≤–µ—Ä–Ω–∏–º –ø—Ä–æ—Ü–µ—Å–æ–º **"Insert Subtasks from Collection"**, –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É.

---

## üìå –ü–µ—Ä–µ–≤–∞–≥–∏:

* –í–∏ —É–Ω–∏–∫–Ω–µ—Ç–µ **—Å–º—ñ—Ç—Ç—î–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤** —É –ë–î.
* –ü–æ–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –Ω–∞—Ç–∏—Å–Ω–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏** ‚Äî –≤—Å—ñ –¥–∞–Ω—ñ –ª–∏—à–µ –≤ —Å–µ—Å—ñ—ó (–≤ –∫–æ–ª–µ–∫—Ü—ñ—ó).
* –ü—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è **—ñ—î—Ä–∞—Ä—Ö—ñ—è** —á–µ—Ä–µ–∑ –¥–≤–∞ –ø—Ä–æ—Ö–æ–¥–∏: —Å–ø–æ—á–∞—Ç–∫—É –≤—Å—Ç–∞–≤–∫–∞, –ø–æ—Ç—ñ–º –æ–Ω–æ–≤–ª–µ–Ω–Ω—è `PARENT_ID`.

---

‚úÖ –•–æ—á–µ—à ‚Äî –º–æ–∂–µ–º–æ –∑—Ä–æ–±–∏—Ç–∏ –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ—Ü–µ—Å –¥–ª—è **–æ–Ω–æ–≤–ª–µ–Ω–Ω—è** (update) —ñ—Å–Ω—É—é—á–æ–≥–æ —à–∞–±–ª–æ–Ω—É/–∑–∞–≤–¥–∞–Ω–Ω—è (—Ç–æ–±—Ç–æ –∫–æ–ª–µ–∫—Ü—ñ—è –º—ñ—Å—Ç–∏—Ç—å —ñ NEW, —ñ UPDATED –∑–∞–ø–∏—Å–∏).
