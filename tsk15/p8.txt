–û—Å—å **–ø–æ–≤–Ω—ñ—Å—Ç—é –≥–æ—Ç–æ–≤–∏–π PL/SQL-–∫–æ–¥ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è –∞–±–æ —à–∞–±–ª–æ–Ω—É**, –≤–∫–ª—é—á–Ω–æ –∑ –æ–±—Ä–æ–±–∫–æ—é –∑–∞–ø–∏—Å—ñ–≤ —É `APEX_COLLECTION`, —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏:

* **–Ω–æ–≤–∏–º–∏** ‚Üí –¥–æ–¥–∞—é—Ç—å—Å—è;
* **–ø–æ–º—ñ—á–µ–Ω—ñ —è–∫ DELETE** ‚Üí –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –∑ —Ç–∞–±–ª–∏—Ü—ñ;
* **—ñ—Å–Ω—É—é—á–∏–º–∏** ‚Üí –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è.

---

## ‚úÖ –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞:

* `:P8_TASK_ID` ‚Äî —É–∂–µ —ñ—Å–Ω—É—é—á–∏–π ID –∑–∞–≤–¥–∞–Ω–Ω—è/—à–∞–±–ª–æ–Ω—É
* `:P8_TASK_MODE` ‚Äî 0 (–∑–∞–≤–¥–∞–Ω–Ω—è) –∞–±–æ 1 (—à–∞–±–ª–æ–Ω)
* `:P8_TASK_ACTION_MODE` = 2 (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è)
* –£ –∫–æ–ª–µ–∫—Ü—ñ—ó `TASK_SUBTASKS_COLLECTION`:

  * `SEQ_ID` ‚Äî —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –≤ –∫–æ–ª–µ–∫—Ü—ñ—ó
  * `C007` ‚Äî ID –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è (–∑ —Ç–∞–±–ª–∏—Ü—ñ), —è–∫—â–æ —î
  * `C010` = `'DELETE'` ‚Üí —Ç—Ä–µ–±–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑ –ë–î

---

## üîÅ –ö–æ–¥ –¥–ª—è `UPDATE` –∑–∞–≤–¥–∞–Ω–Ω—è/—à–∞–±–ª–æ–Ω—É + –∫–æ–ª–µ–∫—Ü—ñ—ó:

```plsql
DECLARE
  v_task_id NUMBER := :P8_TASK_ID;
  v_task_mode NUMBER := :P8_TASK_MODE;
BEGIN
  -- 1. –û–ù–û–í–õ–ï–ù–ù–Ø –ó–ê–í–î–ê–ù–ù–Ø –∞–±–æ –®–ê–ë–õ–û–ù–£
  IF v_task_mode = 0 THEN
    -- –û–Ω–æ–≤–ª–µ–Ω–Ω—è TASK
    UPDATE TASKS
    SET 
      TASK_CONTENT         = :P8_TASK_CONTENT,
      PLANNING_DATE_START  = :P8_PLANNING_DATE_START,
      PLANNING_DATE_END    = :P8_PLANNING_DATE_END,
      NOTE                 = :P8_NOTE,
      TYPE_ID              = :P8_TYPE_ID,
      UNIT_ID              = :P8_UNIT
    WHERE ID = v_task_id;

  ELSIF v_task_mode = 1 THEN
    -- –û–Ω–æ–≤–ª–µ–Ω–Ω—è TEMPLATE
    UPDATE TASK_TEMPLATES
    SET
      TASK_CONTENT     = :P8_TASK_CONTENT,
      NOTE             = :P8_NOTE,
      TYPE_ID          = :P8_TYPE_ID,
      UNIT_ID          = :P8_UNIT,
      PERIOD_MODE      = :P8_PERIOD_MODE,
      PERIOD_INTERVAL  = :P8_PERIOD_INTERVAL,
      PERIOD_TIME      = :P8_PERIOD_TIME,
      WEEKLY_DAYS      = :P8_WEEKLY_DAYS,
      WEEKLY_TIME      = :P8_WEEKLY_TIME,
      DATE_END         = :P8_DATE_END
    WHERE ID = v_task_id;
  END IF;

  -- 2. –û–ë–†–û–ë–ö–ê –ö–û–õ–ï–ö–¶–Ü–á
  FOR r IN (
    SELECT *
    FROM APEX_COLLECTIONS
    WHERE COLLECTION_NAME = 'TASK_SUBTASKS_COLLECTION'
      AND TO_NUMBER(n001) = v_task_mode
  ) LOOP

    -- –í–∏–¥–∞–ª–µ–Ω–Ω—è
    IF r.c010 = 'DELETE' AND r.c007 IS NOT NULL THEN
      IF v_task_mode = 0 THEN
        DELETE FROM TASK_SUBTASKS WHERE ID = TO_NUMBER(r.c007);
      ELSIF v_task_mode = 1 THEN
        DELETE FROM TASK_TEMPLATE_SUBTASKS WHERE ID = TO_NUMBER(r.c007);
      END IF;

    -- –ù–æ–≤–∏–π –∑–∞–ø–∏—Å (–Ω–µ –º–∞—î C007)
    ELSIF r.c007 IS NULL THEN
      IF v_task_mode = 0 THEN
        INSERT INTO TASK_SUBTASKS (
          TASK_ID, SUBTASK_CONTENT, STATUS_ID,
          PLANNING_DATE_END, PARENT_ID, SUBTASK_ORDER
        ) VALUES (
          v_task_id,
          r.c002,
          TO_NUMBER(r.c003),
          TO_DATE(r.c004, 'YYYY-MM-DD HH24:MI:SS'),
          TO_NUMBER(r.c005),
          TO_NUMBER(r.c006)
        );
      ELSIF v_task_mode = 1 THEN
        INSERT INTO TASK_TEMPLATE_SUBTASKS (
          TEMPLATE_ID, SUBTASK_CONTENT, STATUS_ID,
          PARENT_ID, SUBTASK_ORDER
        ) VALUES (
          v_task_id,
          r.c002,
          TO_NUMBER(r.c003),
          TO_NUMBER(r.c005),
          TO_NUMBER(r.c006)
        );
      END IF;

    -- –Ü–Ω–∞–∫—à–µ: –æ–Ω–æ–≤–ª—é—î–º–æ
    ELSE
      IF v_task_mode = 0 THEN
        UPDATE TASK_SUBTASKS
        SET 
          SUBTASK_CONTENT     = r.c002,
          STATUS_ID           = TO_NUMBER(r.c003),
          PLANNING_DATE_END   = TO_DATE(r.c004, 'YYYY-MM-DD HH24:MI:SS'),
          PARENT_ID           = TO_NUMBER(r.c005),
          SUBTASK_ORDER       = TO_NUMBER(r.c006)
        WHERE ID = TO_NUMBER(r.c007);

      ELSIF v_task_mode = 1 THEN
        UPDATE TASK_TEMPLATE_SUBTASKS
        SET 
          SUBTASK_CONTENT     = r.c002,
          STATUS_ID           = TO_NUMBER(r.c003),
          PARENT_ID           = TO_NUMBER(r.c005),
          SUBTASK_ORDER       = TO_NUMBER(r.c006)
        WHERE ID = TO_NUMBER(r.c007);
      END IF;

    END IF;
  END LOOP;

  -- –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ–ª–µ–∫—Ü—ñ—é –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
  APEX_COLLECTION.DELETE_COLLECTION('TASK_SUBTASKS_COLLECTION');
END;
```

---

## üß© –©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤ –∫–æ–ª–µ–∫—Ü—ñ—ó:

| –ü–æ–ª–µ | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è                       |
| ---- | --------------------------------- |
| C001 | TASK\_ID (–º–æ–∂–µ –±—É—Ç–∏ NULL)         |
| C002 | SUBTASK\_CONTENT                  |
| C003 | STATUS\_ID                        |
| C004 | PLANNING\_DATE\_END               |
| C005 | PARENT\_ID                        |
| C006 | SUBTASK\_ORDER                    |
| C007 | ID –∑ –ë–î (–¥–ª—è —ñ—Å–Ω—É—é—á–∏—Ö –∑–∞–ø–∏—Å—ñ–≤)    |
| C010 | `'DELETE'` —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ |
| N001 | TASK\_MODE (0 –∞–±–æ 1)              |

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:

* –ü—Ä–∞—Ü—é—î –¥–ª—è —Ä–µ–∂–∏–º—É **—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è**
* –ó–∞–ø–∏—Å–∏, –ø–æ–º—ñ—á–µ–Ω—ñ —è–∫ `'DELETE'` ‚Äî –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è
* –ù–æ–≤—ñ ‚Üí –≤—Å—Ç–∞–≤–ª—è—é—Ç—å—Å—è
* –Ü—Å–Ω—É—é—á—ñ (C007 –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π, –∞–ª–µ –Ω–µ DELETE) ‚Äî –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è
* –ü—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ—è –æ—á–∏—â–∞—î—Ç—å—Å—è

–•–æ—á–µ—à ‚Äî –º–æ–∂–µ–º–æ –∑—Ä–æ–±–∏—Ç–∏ –∞–Ω–∞–ª–æ–≥—ñ—á–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—Ä–∏ —Å–∞–±–º—ñ—Ç—ñ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç–∏, –∞–±–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤–æ "—á–æ—Ä–Ω–æ–≤–∏–∫".
