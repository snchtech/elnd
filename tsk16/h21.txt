–û—Å—å –æ–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ—Ü–µ—Å –¥–ª—è **–∞–Ω—É–ª—é–≤–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è –∞–±–æ —à–∞–±–ª–æ–Ω—É**, —â–æ –≤—Ä–∞—Ö–æ–≤—É—î:

1. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è `STATUS_ID = 11` —É —Ç–∞–±–ª–∏—Ü—è—Ö `TASKS` –∞–±–æ `TASK_TEMPLATES`.
2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è `STATUS_ID = 11` –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å –∞–±–æ –ø—ñ–¥—à–∞–±–ª–æ–Ω—ñ–≤.
3. –ó–∞–ø–∏—Å –¥–æ `SIGNATUREHISTORY` –ø–æ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Å—É –∑ `SIGNATURERIGHTS`, —è–∫–æ–≥–æ —â–µ –Ω–µ–º–∞—î –≤ `SIGNATUREHISTORY`.

---

### ‚úÖ **PL/SQL –∫–æ–¥ –ø—Ä–æ—Ü–µ—Å—É:**

```plsql
DECLARE
  v_task_id      NUMBER := TO_NUMBER(APEX_APPLICATION.G_X01); -- –û—Ç—Ä–∏–º—É—î–º–æ ID —ñ–∑ –∫–ª—ñ—î–Ω—Ç–∞
  v_task_mode    NUMBER := TO_NUMBER(APEX_APPLICATION.G_X02); -- 0 - –∑–∞–≤–¥–∞–Ω–Ω—è, 1 - —à–∞–±–ª–æ–Ω
  v_user_id      NUMBER := :P0_USER_ID;
BEGIN
  IF v_task_mode = 0 THEN
    -- üî∏ –ó–∞–≤–¥–∞–Ω–Ω—è
    UPDATE TASKS
    SET STATUS_ID = 11
    WHERE ID = v_task_id;

    UPDATE TASK_SUBTASKS
    SET STATUS_ID = 11
    WHERE TASK_ID = v_task_id;

  ELSIF v_task_mode = 1 THEN
    -- üî∏ –®–∞–±–ª–æ–Ω
    UPDATE TASK_TEMPLATES
    SET STATUS_ID = 11
    WHERE ID = v_task_id;

    UPDATE TASK_TEMPLATE_SUBTASKS
    SET STATUS_ID = 11
    WHERE TEMPLATE_ID = v_task_id;
  END IF;

  -- üî∏ –î–æ–¥–∞—î–º–æ –∑–∞–ø–∏—Å–∏ –≤ SIGNATUREHISTORY, —è–∫–∏—Ö —â–µ –Ω–µ–º–∞—î
  FOR r IN (
    SELECT sr.ID AS SR_ID, sr.STAGE_ID
    FROM SIGNATURERIGHTS sr
    LEFT JOIN SIGNATUREHISTORY sh
      ON sr.ID = sh.SIGNATURE_RIGHT_ID
    WHERE sr.TASK_ID = v_task_id
      AND sh.ID IS NULL -- —Ç—ñ–ª—å–∫–∏ —Ç—ñ, —â–æ —â–µ –Ω–µ –º–∞—é—Ç—å —ñ—Å—Ç–æ—Ä—ñ—ó
  ) LOOP
    INSERT INTO SIGNATUREHISTORY (
      SIGNATURE_RIGHT_ID,
      NEW_STATUS_ID,
      SIGNER_BY,
      SIGNER_DATE,
      NOTE,
      SDATE
    ) VALUES (
      r.SR_ID,
      11,
      v_user_id,
      SYSDATE,
      '–ê–Ω—É–ª—å–æ–≤–∞–Ω–æ',
      SYSDATE
    );
  END LOOP;

  -- ‚úÖ JSON-–≤—ñ–¥–ø–æ–≤—ñ–¥—å
  APEX_JSON.OPEN_OBJECT;
  APEX_JSON.WRITE('status', 'ok');
  APEX_JSON.CLOSE_OBJECT;

EXCEPTION
  WHEN OTHERS THEN
    APEX_JSON.OPEN_OBJECT;
    APEX_JSON.WRITE('status', 'error');
    APEX_JSON.WRITE('message', SQLERRM);
    APEX_JSON.CLOSE_OBJECT;
END;
```

---

### üìå –Ø–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:

* `G_X01` ‚Äî –ø–µ—Ä–µ–¥–∞—î—à `TASK_ID` –∞–±–æ `TEMPLATE_ID`
* `G_X02` ‚Äî –ø–µ—Ä–µ–¥–∞—î—à —Ä–µ–∂–∏–º: `0` (TASK), `1` (TEMPLATE)
* `P0_USER_ID` ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —è–∫ `SIGNER_BY` —É `SIGNATUREHISTORY`

---

### üß© –î–æ–¥–∞—Ç–∫–æ–≤–æ:

* –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (`apex.message`) –ø—Ä–æ —É—Å–ø—ñ—à–Ω—É –∞–Ω—É–ª—è—Ü—ñ—é.
* –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ª–æ–≥—É–≤–∞—Ç–∏ —Ü—ñ –¥—ñ—ó –æ–∫—Ä–µ–º–æ ‚Äî –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥-—Ç–∞–±–ª–∏—Ü—é.

–ì–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Ü–µ —ñ –Ω–∞ –∫–Ω–æ–ø—Ü—ñ –≤ UI.
