–û—Å—å –ø–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–π `PL/SQL` –ø—Ä–æ—Ü–µ—Å `DUPLICATE_SUBITEMS_FROM_COLLECTION` –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º **–æ–Ω–æ–≤–ª–µ–Ω–æ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –∫–æ–ª–µ–∫—Ü—ñ–π**, –¥–µ:

* —î –ø–æ–ª—è `C001`‚Äì`C010` —Ç–∞ `N001`,
* –≤—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è `TASK_MODE`,
* –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è **–ø–æ–≤–Ω–µ –¥—É–±–ª—é–≤–∞–Ω–Ω—è** –ø—ñ–¥–∑–∞–ø–∏—Å—ñ–≤ (–ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å –∞–±–æ –ø—ñ–¥—à–∞–±–ª–æ–Ω—ñ–≤) –∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º `PARENT_ID`,
* –≤—Å—Ç–∞–Ω–æ–≤–ª—é—é—Ç—å—Å—è `DATE_CREATE`, `CREATOR`, –∞ —Ç–∞–∫–æ–∂ –º—ñ—Ç–∫–∞ `NEW` —É `C010`.

---

### ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

| CXXX | –î–∞–Ω—ñ                            |
| ---- | ------------------------------- |
| C001 | TASK\_ID / TEMPLATE\_ID         |
| C002 | SUBTASK\_CONTENT                |
| C003 | STATUS\_ID                      |
| C004 | PLANNING\_DATE\_END             |
| C005 | PARENT\_ID (–º–æ–∂–µ –±—É—Ç–∏ `SEQ_ID`) |
| C006 | SUBTASK\_ORDER                  |
| C007 | DATE\_CREATE                    |
| C008 | DATE\_UPDATE                    |
| C009 | CREATOR                         |
| C010 | UPDATOR –∞–±–æ –º—ñ—Ç–∫–∞ `NEW`         |
| N001 | TASK\_MODE (0 –∞–±–æ 1)            |

---

### üîÑ –û–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–¥:

```plsql
DECLARE
  l_coll_name      VARCHAR2(100);
  l_count          PLS_INTEGER;
  l_map_old_to_new DBMS_SQL.VARCHAR2_TABLE;
  l_seq_suffix     VARCHAR2(10);
BEGIN
  -- –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω—É –∫–æ–ª–µ–∫—Ü—ñ—é
  IF :P_TASK_MODE = '0' THEN
    l_coll_name := 'TASK_SUBTASKS_COLLECTION';
  ELSE
    l_coll_name := 'TASK_TEMPLATE_SUBTASKS_COLLECTION';
  END IF;

  l_count := APEX_COLLECTION.COLLECTION_MEMBER_COUNT(p_collection_name => l_coll_name);
  l_seq_suffix := TO_CHAR(SYSDATE, 'HH24MISS'); -- –î–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ SUBTASK_ORDER

  -- üîÅ –ü–µ—Ä—à–µ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è ‚Äî –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤
  FOR i IN 1 .. l_count LOOP
    DECLARE
      v_new_seq_id NUMBER;
      v_old_seq_id VARCHAR2(50) := TO_CHAR(APEX_COLLECTION.GET_SEQ_ID(l_coll_name, i));
      v_old_parent VARCHAR2(50) := APEX_COLLECTION.GET_MEMBER_ATTRIBUTE(l_coll_name, i, 'C005');
    BEGIN
      APEX_COLLECTION.ADD_MEMBER(
        p_collection_name => l_coll_name,
        p_c001 => APEX_COLLECTION.GET_MEMBER_ATTRIBUTE(l_coll_name, i, 'C001'), -- TASK_ID
        p_c002 => APEX_COLLECTION.GET_MEMBER_ATTRIBUTE(l_coll_name, i, 'C002'), -- CONTENT
        p_c003 => APEX_COLLECTION.GET_MEMBER_ATTRIBUTE(l_coll_name, i, 'C003'), -- STATUS_ID
        p_c004 => APEX_COLLECTION.GET_MEMBER_ATTRIBUTE(l_coll_name, i, 'C004'), -- PLANNING_DATE_END
        p_c005 => v_old_parent,                                                 -- PARENT_ID (—Ç–∏–º—á–∞—Å–æ–≤–æ)
        p_c006 => TO_NUMBER(TO_CHAR(i) || SUBSTR(l_seq_suffix, 1, 2)),          -- NEW ORDER
        p_c007 => SYSDATE,                                                      -- DATE_CREATE
        p_c008 => NULL,                                                         -- DATE_UPDATE
        p_c009 => :P0_USER_ID,                                                  -- CREATOR
        p_c010 => 'NEW',                                                        -- –ü–æ–∑–Ω–∞—á–∫–∞
        p_n001 => TO_NUMBER(:P_TASK_MODE)
      );

      v_new_seq_id := APEX_COLLECTION.LAST(l_coll_name).seq_id;

      -- –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –º–∞–ø—É —Å—Ç–∞—Ä–æ–≥–æ SEQ_ID ‚Üí –Ω–æ–≤–æ–≥–æ
      l_map_old_to_new(v_old_seq_id) := TO_CHAR(v_new_seq_id);
    END;
  END LOOP;

  -- üîÅ –î—Ä—É–≥–µ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è ‚Äî –æ–Ω–æ–≤–ª–µ–Ω–Ω—è PARENT_ID –≤ –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Å–∞—Ö
  FOR i IN 1 .. APEX_COLLECTION.COLLECTION_MEMBER_COUNT(p_collection_name => l_coll_name) LOOP
    IF APEX_COLLECTION.GET_MEMBER_ATTRIBUTE(l_coll_name, i, 'C010') = 'NEW' THEN
      DECLARE
        v_old_parent_id VARCHAR2(50) := APEX_COLLECTION.GET_MEMBER_ATTRIBUTE(l_coll_name, i, 'C005');
        v_new_parent_id VARCHAR2(50);
      BEGIN
        IF v_old_parent_id IS NOT NULL THEN
          v_new_parent_id := l_map_old_to_new(v_old_parent_id);
          IF v_new_parent_id IS NOT NULL THEN
            APEX_COLLECTION.UPDATE_MEMBER_ATTRIBUTE(
              p_collection_name => l_coll_name,
              p_seq             => APEX_COLLECTION.GET_SEQ_ID(l_coll_name, i),
              p_attr_number     => 5, -- C005 (PARENT_ID)
              p_attr_value      => v_new_parent_id
            );
          END IF;
        END IF;
      END;
    END IF;
  END LOOP;

EXCEPTION
  WHEN OTHERS THEN
    raise_application_error(-20001, '‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—ñ –ø—ñ–¥–∑–∞–ø–∏—Å—ñ–≤: ' || SQLERRM);
END;
```

---

‚úÖ **–¶–µ–π –∫–æ–¥:**

* –ø—Ä–∞—Ü—é—î **–¥–ª—è –æ–±–æ—Ö –∫–æ–ª–µ–∫—Ü—ñ–π** (`TASK_SUBTASKS_COLLECTION`, `TASK_TEMPLATE_SUBTASKS_COLLECTION`),
* –ø—ñ–¥—Ç—Ä–∏–º—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è `PARENT_ID`,
* —Å—Ç–∞–≤–∏—Ç—å –º—ñ—Ç–∫—É `'NEW'` —É `C010` –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è —á–∏ –≤—ñ–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è.

üîî –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –º–æ–∂—É —Ç–∞–∫–æ–∂ –¥–æ–ø–∏—Å–∞—Ç–∏ **JavaScript** –¥–ª—è –≤–∏–∫–ª–∏–∫—É —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É –∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è–º –¥—É–±–ª—é–≤–∞–Ω–Ω—è.
