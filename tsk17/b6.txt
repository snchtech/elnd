–©–æ–± –¥–æ–¥–∞—Ç–∏ –¥–æ –≤–∞—à–æ–≥–æ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É –∫–æ–ª–æ–Ω–∫—É `SIGNER_DATE` –∑ —Ç–∞–±–ª–∏—Ü—ñ `SIGNATUREHISTORY`, –ø–æ—Ç—Ä—ñ–±–Ω–æ:

* –≤–∏–∫–æ–Ω–∞—Ç–∏ `LEFT JOIN` –º—ñ–∂ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è–º–∏ —Ç–∞ `SIGNATURERIGHTS`, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `SUBTASK_ID = seq_id`, –∞–ª–µ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ç–∞–∫–∏–π –∑–∞–ø–∏—Å —É–∂–µ —ñ—Å–Ω—É—î –≤ —Ç–∞–±–ª–∏—Ü—ñ (—Ç–æ–±—Ç–æ —è–∫—â–æ `seq_id` —Å–ø—ñ–≤–ø–∞–¥–∞—î –∑ `SUBTASK_ID` —É `SIGNATURERIGHTS`).
* –¥–∞–ª—ñ ‚Äî `JOIN` –∑ `SIGNATUREHISTORY`, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ `SIGNER_DATE`.
* —è–∫—â–æ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è –Ω–æ–≤–µ (—î –ª–∏—à–µ –≤ –∫–æ–ª–µ–∫—Ü—ñ—ó), `SIGNER_DATE` –±—É–¥–µ `NULL`.

---

## ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–∏–π SQL-–∑–∞–ø–∏—Ç

–í–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–±–≥–æ—Ä–Ω—É—Ç–∏ `subtask_tree` —É —â–µ –æ–¥–∏–Ω `WITH`, –∞–±–æ –∂ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –π–æ–≥–æ —è–∫ –ø—ñ–¥–∑–∞–ø–∏—Ç —ñ –∑–∑–æ–≤–Ω—ñ –¥–æ—î–¥–Ω–∞—Ç–∏ `SIGNER_DATE`.

–û—Å—å **–∑–º—ñ–Ω–µ–Ω—É –≤–µ—Ä—Å—ñ—é –∑–∞–ø–∏—Ç—É**, –∑ –¥–æ–¥–∞–Ω–æ—é –∫–æ–ª–æ–Ω–∫–æ—é `fact_date_end` (—Ç–æ–±—Ç–æ `SIGNER_DATE`):

```sql
RETURN q'[
WITH subtask_tree (
  seq_id, task_id, parent_seq_id, subtask_content, subtask_order,
  level_b, path_b, full_number, drag_handle, task_mode
) AS (
  SELECT
    c.seq_id,
    c.c001,
    NULL,
    c.c002,
    TO_NUMBER(c.c006),
    1 AS level_b,
    LPAD(ROW_NUMBER() OVER (ORDER BY TO_NUMBER(c.c006)), 5, '0') AS path_b,
    TO_CHAR(ROW_NUMBER() OVER (ORDER BY TO_NUMBER(c.c006))) AS full_number,
    CASE WHEN c.c005 IS NULL THEN '<span class="drag-handle">‚ò∞</span>' END,
    TO_NUMBER(c.n001)
  FROM apex_collections c
  WHERE c.collection_name = 'TASK_SUBTASKS_COLLECTION'
    AND c.c005 IS NULL
    AND NVL(c.c010, 'ACTIVE') != 'DELETE'

  UNION ALL

  SELECT
    child.seq_id,
    child.c001,
    TO_NUMBER(child.c005),
    child.c002,
    TO_NUMBER(child.c006),
    parent.level_b + 1,
    parent.path_b || '.' || LPAD(ROW_NUMBER() OVER (
      PARTITION BY child.c005 ORDER BY TO_NUMBER(child.c006)
    ), 5, '0'),
    parent.full_number || '.' || TO_CHAR(
      ROW_NUMBER() OVER (
        PARTITION BY child.c005 ORDER BY TO_NUMBER(child.c006)
      )
    ),
    NULL,
    TO_NUMBER(child.n001)
  FROM apex_collections child
  JOIN subtask_tree parent
    ON TO_NUMBER(child.c005) = parent.seq_id
  WHERE child.collection_name = 'TASK_SUBTASKS_COLLECTION'
    AND NVL(child.c010, 'ACTIVE') != 'DELETE'
)
SELECT
  st.seq_id AS id,
  st.task_id,
  st.parent_seq_id AS parent_id,
  st.subtask_content,
  st.subtask_order,
  st.level_b,
  st.full_number,
  st.path_b,
  LPAD(' ', (st.level_b - 1) * 4, ' ') || st.full_number || ' ' || st.subtask_content AS display_content,
  st.drag_handle,
  st.task_mode,
  sh.SIGNER_DATE AS fact_date_end
FROM subtask_tree st
LEFT JOIN signaturerights sr
  ON sr.subtask_id = st.seq_id
LEFT JOIN signaturehistory sh
  ON sh.signright_id = sr.id
WHERE st.task_mode = 0
ORDER BY st.path_b;
]';
```

---

## üìå –ü–æ—è—Å–Ω–µ–Ω–Ω—è:

* `LEFT JOIN signaturerights sr ON sr.subtask_id = st.seq_id` ‚Äî —è–∫—â–æ —ñ—Å–Ω—É—î –∑–∞–ø–∏—Å —É –ë–î, –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ –π–æ–≥–æ.
* `LEFT JOIN signaturehistory sh ON sh.signright_id = sr.id` ‚Äî –æ—Ç—Ä–∏–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é –ø—ñ–¥–ø–∏—Å—É.
* `sh.SIGNER_DATE` ‚Üí –∫–æ–ª–æ–Ω–∫–∞ `fact_date_end`.

---

## ‚úÖ –î–æ–¥–∞—Ç–∫–æ–≤–æ:

* –Ø–∫—â–æ –≤ `SIGNATUREHISTORY` –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è **—ñ—Å—Ç–æ—Ä—ñ—è**, —ñ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ç—ñ–ª—å–∫–∏ **–æ—Å—Ç–∞–Ω–Ω—é –¥–∞—Ç—É**, –∑–∞–º—ñ–Ω—ñ—Ç—å `JOIN` –Ω–∞:

```sql
LEFT JOIN (
  SELECT signright_id, MAX(signer_date) AS signer_date
  FROM signaturehistory
  GROUP BY signright_id
) sh ON sh.signright_id = sr.id
```

–¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –±—É–¥–µ –≤–∑—è—Ç–∞ –ª–∏—à–µ **–Ω–∞–π–ø—ñ–∑–Ω—ñ—à–∞ –¥–∞—Ç–∞ –ø—ñ–¥–ø–∏—Å—É** –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ `signright_id`.

---

üîî –Ø–∫—â–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `SIGNATUREHISTORY` –¥–æ–∑–≤–æ–ª—è—î –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –ø—ñ–¥–ø–∏—Å—ñ–≤ –Ω–∞ –æ–¥–∏–Ω `signright_id`, –∫—Ä–∞—â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `MAX(signer_date)` –∞–±–æ –Ω–∞–≤—ñ—Ç—å `ROWNUM = 1 ORDER BY signer_date DESC`.

–•–æ—á–µ—Ç–µ ‚Äî –º–æ–∂—É –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ –ø—ñ–¥ –≤–∞—Ä—ñ–∞–Ω—Ç –∑ `RANK()` –∞–±–æ `ROWNUM`.
