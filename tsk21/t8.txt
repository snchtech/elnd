–û—Å—å —è–∫ –º–æ–∂–Ω–∞ **–≥—Ä–∞–º–æ—Ç–Ω–æ –¥–æ–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤–∞—à –∑–≤—ñ—Ç –∑–º—ñ–Ω `TASK_CHANGE_LOG`**, –≤—Ä–∞—Ö–æ–≤—É—é—á–∏:

---

### ‚úÖ 1. –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ—ó (Insert / Update / Delete)

–ó–∞–º—ñ—Å—Ç—å `ACTION_TYPE` (—è–∫–∏–π –∑–∞—Ä–∞–∑ –º–∞—î ID), –≤–∞–º —Ç—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ `DICT_ACTION_TYPE`:

```sql
DAT.NAME AS "–û–ø–µ—Ä–∞—Ü—ñ—è"
```

---

### ‚úÖ 2. –í–∏–≤–µ–¥–µ–Ω–Ω—è ‚Äú–ë—É–ª–æ / –°—Ç–∞–ª–æ‚Äù –∑ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `PERIOD_MODE`, `PERIOD_TIME`, `UNIT_ID`)

#### –í–∞—Ä—ñ–∞–Ω—Ç 1 ‚Äî –ß–µ—Ä–µ–∑ CASE –≤ SQL (—è–∫—â–æ –∑–Ω–∞—á–µ–Ω—å –Ω–µ–±–∞–≥–∞—Ç–æ):

```sql
CASE 
  WHEN DFN.CODE = 'PERIOD_MODE' THEN 
    CASE TCL.OLD_VALUE 
      WHEN '1' THEN '–ö–æ–∂–Ω—ñ N –¥–Ω—ñ–≤'
      WHEN '2' THEN '–©–æ—Ç–∏–∂–Ω—è'
      ELSE TCL.OLD_VALUE 
    END
  ELSE TCL.OLD_VALUE
END AS "–ë—É–ª–æ",
```

–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–ª—è `NEW_VALUE`.

#### –í–∞—Ä—ñ–∞–Ω—Ç 2 ‚Äî –ß–µ—Ä–µ–∑ LEFT JOIN –¥–æ lookup-—Ç–∞–±–ª–∏—Ü—å:

* –Ø–∫—â–æ –ø–æ–ª–µ –º–∞—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —ñ–Ω—à—É —Ç–∞–±–ª–∏—Ü—é (`UNIT_ID` ‚Üí `DICT_UNITS`, `CREATOR_ID` ‚Üí `USER_TABLE`, —Ç–æ—â–æ), –º–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é `DICT_FIELD_TRANSLATOR`, —è–∫–∞ –º—ñ—Å—Ç–∏—Ç—å –ª–æ–≥—ñ–∫—É —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∏, –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `CASE + JOIN`.

#### –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É:

```sql
CASE 
  WHEN DFN.CODE = 'PERIOD_TIME' THEN TO_CHAR(TO_DATE(TCL.OLD_VALUE, 'DD.MM.YYYY HH24:MI:SS'), 'HH24:MI')
  ELSE TCL.OLD_VALUE
END AS "–ë—É–ª–æ"
```

*–ó–∞ —É–º–æ–≤–∏, —â–æ OLD\_VALUE ‚Äî —Ç–µ–∫—Å—Ç–æ–≤–∞ –¥–∞—Ç–∞. –Ø–∫—â–æ —Ü–µ –∑–±–µ—Ä—ñ–≥–∞–ª–æ—Å—è —è–∫ `DATE`, –∫—Ä–∞—â–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —É DATE-–∫–æ–ª–æ–Ω–∫—É.*

---

### ‚úÖ 3. –ü—ñ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è username –∑–∞–º—ñ—Å—Ç—å USER\_ID

–ü—Ä–∏—î–¥–Ω—É—î—Ç–µ —Ç–∞–±–ª–∏—Ü—é `USER_TABLE`:

```sql
UT.USERNAME AS "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á"
```

---

### üîß –ü–†–ò–ö–õ–ê–î –û–ù–û–í–õ–ï–ù–û–ì–û –ó–ê–ü–ò–¢–£

```sql
SELECT 
  TCL.LOG_DATE       AS "–î–∞—Ç–∞ –∑–º—ñ–Ω–∏",
  UT.USERNAME        AS "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á",
  DAT.NAME           AS "–û–ø–µ—Ä–∞—Ü—ñ—è",
  DFN.NAME           AS "–ü–æ–ª–µ",

  -- –ë—É–ª–æ
  CASE 
    WHEN DFN.CODE = 'PERIOD_MODE' THEN 
      CASE TCL.OLD_VALUE 
        WHEN '1' THEN '–ö–æ–∂–Ω—ñ N –¥–Ω—ñ–≤'
        WHEN '2' THEN '–©–æ—Ç–∏–∂–Ω—è'
        ELSE TCL.OLD_VALUE 
      END
    WHEN DFN.CODE = 'PERIOD_TIME' THEN 
      TO_CHAR(TO_DATE(TCL.OLD_VALUE, 'DD.MM.YYYY HH24:MI:SS'), 'HH24:MI')
    ELSE TCL.OLD_VALUE
  END AS "–ë—É–ª–æ",

  -- –°—Ç–∞–ª–æ
  CASE 
    WHEN DFN.CODE = 'PERIOD_MODE' THEN 
      CASE TCL.NEW_VALUE 
        WHEN '1' THEN '–ö–æ–∂–Ω—ñ N –¥–Ω—ñ–≤'
        WHEN '2' THEN '–©–æ—Ç–∏–∂–Ω—è'
        ELSE TCL.NEW_VALUE 
      END
    WHEN DFN.CODE = 'PERIOD_TIME' THEN 
      TO_CHAR(TO_DATE(TCL.NEW_VALUE, 'DD.MM.YYYY HH24:MI:SS'), 'HH24:MI')
    ELSE TCL.NEW_VALUE
  END AS "–°—Ç–∞–ª–æ"

FROM TASK_CHANGE_LOG TCL
LEFT JOIN USER_TABLE UT ON UT.USER_ID = TCL.USER_ID
LEFT JOIN DICT_ACTION_TYPE DAT ON DAT.ID = TCL.ACTION_TYPE_ID
LEFT JOIN DICT_FIELD_NAME DFN ON DFN.ID = TCL.FIELD_NAME_ID

WHERE TCL.OBJECT_ID = :P50_HISTORY_OBJECT_ID
  AND TCL.OBJECT_TYPE_ID = (
    SELECT ID FROM DICT_OBJECT_TYPE WHERE CODE = :P50_HISTORY_OBJECT_TYPE
  )

ORDER BY TCL.LOG_DATE DESC
```

---

### ‚úÖ –î–æ–¥–∞—Ç–∫–æ–≤–æ:

* –Ø–∫—â–æ `OLD_VALUE` —Ç–∞ `NEW_VALUE` –º–æ–∂—É—Ç—å –±—É—Ç–∏ —á–∏—Å–ª–∞–º–∏, —è–∫—ñ –º–∞—é—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–∫–∏ —É lookup-—Ç–∞–±–ª–∏—Ü—è—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `UNIT_ID`, `DEPARTMENT_ID`) ‚Äî –∑—Ä–æ–±—ñ—Ç—å LEFT JOIN —â–µ –π –¥–æ –Ω–∏—Ö, —É–º–æ–≤–Ω–æ —á–µ—Ä–µ–∑:

```sql
LEFT JOIN DICT_UNIT U1 ON DFN.CODE = 'UNIT_ID' AND TO_NUMBER(TCL.OLD_VALUE) = U1.ID
LEFT JOIN DICT_UNIT U2 ON DFN.CODE = 'UNIT_ID' AND TO_NUMBER(TCL.NEW_VALUE) = U2.ID
```

–Ü —Ç–æ–¥—ñ –≤ CASE –º–æ–∂–Ω–∞ —Å–∫–∞–∑–∞—Ç–∏:

```sql
WHEN DFN.CODE = 'UNIT_ID' THEN U1.UNIT_NAME
```

---

üîî –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äî –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑—Ä–æ–±–∏—Ç–∏ –æ–∫—Ä–µ–º—É —Ñ—É–Ω–∫—Ü—ñ—é `TRANSLATE_LOG_VALUE(p_field_code, p_value)` –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ —Ç–∞–∫–∏—Ö –ø–æ–ª—ñ–≤.
