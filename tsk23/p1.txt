–ß—É–¥–æ–≤–∏–π –ø—ñ–¥—Ö—ñ–¥ ‚Äî –≤–∏ –≤–∂–µ –∑–∞–∫–ª–∞–ª–∏ –≥–Ω—É—á–∫—É —Ç–∞ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—É —Å–∏—Å—Ç–µ–º—É. –î–∞–≤–∞–π—Ç–µ —è –¥–æ–ø–æ–º–æ–∂—É –≤–∞–º **—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –∫–æ–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏**, –∑—Ä–æ–±–ª—é –π–æ–≥–æ –±—ñ–ª—å—à —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–º —ñ –ø—ñ–¥–≥–æ—Ç—É—é –±–∞–∑—É –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ —Ä–æ–∑–≤–∏—Ç–∫—É.

---

## üåü –©–æ –º–∏ —Ä–µ–∞–ª—ñ–∑—É—î–º–æ

‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥—É, —è–∫–∞:

* –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ —î –∑–∞–º—ñ—â–µ–Ω–Ω—è (`P0_NEW_*` –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ);
* –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –≥—Ä—É–ø–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω—Ç–∞ (1 = –ø–æ—Å–∞–¥–∞+–≤—ñ–¥–¥—ñ–ª+unit, 2 = –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á), –≤–∏–∫–æ–Ω—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫—É;
* —Ñ–æ—Ä–º—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π HTML-—Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∫–Ω–æ–ø–∫–∞, —Å—Ç–∞—Ç—É—Å —Ç–æ—â–æ).

‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ **PL/SQL best practices**:

* –º—ñ–Ω—ñ–º—É–º –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∫–æ–¥—É;
* —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –æ–±—Ä–æ–±–∫–∞ —É–º–æ–≤;
* –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ –Ω–∞ –ì—Ä—É–ø—É 3.

---

## üí° –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π PLSQL

```plsql
DECLARE
    l_user_id         NUMBER := NVL(:P0_NEW_USER_ID, :P0_USER_ID);
    l_position_id     NUMBER := NVL(:P0_NEW_POSITION_ID, :P0_POSITION_ID);
    l_department_id   NUMBER := NVL(:P0_NEW_DEPARTMENT_ID, :P0_DEPARTMENT_ID);
    l_unit_id         NUMBER := NVL(:P0_NEW_UNIT_ID, :P0_UNIT_ID);
    
    l_is_role         BOOLEAN := FALSE;
    l_signature_id    NUMBER := :P1_SIGNATURE_ID; -- –ø—Ä–∏–∫–ª–∞–¥
    l_count_cb        NUMBER := 0; -- —Ä–∞—Ö—ñ–≤–Ω–∏–∫ –∫–Ω–æ–ø–æ–∫/–≤—ñ–¥–º—ñ—Ç–æ–∫ –Ω–∞ –ø—ñ–¥—Å—Ç–∞–¥—ñ—ó
    l_substage_btn_text VARCHAR2(4000) := '–í—ñ–¥–º—ñ—Ç–∏—Ç–∏'; -- —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏

BEGIN
    -- –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ –º–∏ –∑–Ω–∞—î–º–æ group_id –∑ –¥–∞–Ω–∏—Ö –ø—ñ–¥–ø–∏—Å–∞–Ω—Ç–∞
    CASE :P1_SIGNER_GROUP_ID -- group id –∑–∞–¥–∞—î—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –ø—ñ–¥–ø–∏—Å–∞–Ω—Ç–∞
    WHEN 2 THEN  -- –ì–†–£–ü–ê 2: –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π user_id
        IF l_user_id = :P1_SIGNER_USER_ID THEN
            l_is_role := TRUE;
        END IF;
    
    WHEN 1 THEN  -- –ì–†–£–ü–ê 1: position + department + optional unit
        IF :P1_SIGNER_POSITION_ID IS NOT NULL AND
           l_position_id = :P1_SIGNER_POSITION_ID THEN

            IF :P1_SIGNER_DEPARTMENT_ID IS NULL OR
               l_department_id = :P1_SIGNER_DEPARTMENT_ID THEN

                IF :P1_SIGNER_UNIT_ID IS NULL OR
                   l_unit_id = :P1_SIGNER_UNIT_ID THEN
                    l_is_role := TRUE;
                END IF;

            END IF;
        END IF;

    ELSE
        -- –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ì–†–£–ü–£ 3 –∞–±–æ —ñ–Ω—à—ñ –æ–±—Ä–æ–±–∫–∏ —Ç—É—Ç
        NULL;
    END CASE;

    -- –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    IF l_is_role AND l_count_cb = 0 THEN
        HTP.P('<button id="signature-btn" data-signature-id="' || l_signature_id || 
              '" class="confirm-signature-button">' || l_substage_btn_text || '</button>');
        l_count_cb := l_count_cb + 1;
    ELSIF l_is_role AND l_count_cb > 0 THEN
        HTP.P('<span class="wait-confirm-signature-text">–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏</span>');
    ELSIF NOT l_is_role AND l_count_cb = 0 THEN
        HTP.P('<span class="wait-confirm-signature-text wait-confirm-signature-text-current">–†–æ–∑–≥–ª—è–¥–∞—î</span>');
        l_count_cb := l_count_cb + 1;
    ELSE
        HTP.P('<span class="wait-confirm-signature-text">–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏</span>');
    END IF;

END;
```

---

## üìù –ü–æ—è—Å–Ω–µ–Ω–Ω—è

‚úÖ **–ó–∞–º—ñ–Ω–µ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É APEX\_ACL.HAS\_USER\_ROLE**

* –¢—É—Ç –º–∏ –ø—Ä–∞—Ü—é—î–º–æ –Ω–∞–ø—Ä—è–º—É –∑ –ø–æ–∑–∏—Ü—ñ—è–º–∏/–≤—ñ–¥–¥—ñ–ª–∞–º–∏/—é–Ω–∏—Ç–∞–º–∏ –∑ –≤–∞—à–æ—ó —Ç–∞–±–ª–∏—Ü—ñ `USERS`, –∞ –Ω–µ —á–µ—Ä–µ–∑ ACL.
* –Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ APEX ACL (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ –¥–ª—è unit —á–∏ department), –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏:

  ```plsql
  l_is_department := APEX_ACL.HAS_USER_ROLE(...);
  ```

‚úÖ **CASE –ø–æ group\_id**

* –¶–µ –¥—É–∂–µ —Å–ø—Ä–æ—â—É—î –ª–æ–≥—ñ–∫—É. –î–æ–¥–∞—Ç–∏ –ì—Ä—É–ø—É 3 –º–æ–∂–Ω–∞ –≤ –æ–¥–∏–Ω WHEN.

‚úÖ **–ú—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—è –¥—É–±–ª—é–≤–∞–Ω–Ω—è**

* HTML-–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –≤ –æ–¥–Ω–æ–º—É –±–ª–æ—Ü—ñ.

‚úÖ **–ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è**

* CASE –º–æ–∂–Ω–∞ –¥–æ–ø–æ–≤–Ω–∏—Ç–∏ shift-–ª–æ–≥—ñ–∫–æ—é, ACL-–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏, –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º–∏ —É–º–æ–≤–∞–º–∏.

---

## üåü –©–æ —â–µ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏

üí° *–ü–µ—Ä–µ–≤—ñ—Ä–∫—É –∑–∞–º—ñ—â–µ–Ω–Ω—è –æ–∫—Ä–µ–º–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é*

```plsql
FUNCTION GET_EFFECTIVE_USER_ID RETURN NUMBER IS
BEGIN
  RETURN NVL(:P0_NEW_USER_ID, :P0_USER_ID);
END;
```

üí° *–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–ª—è position, department, unit*

üí° *–§—É–Ω–∫—Ü—ñ—é –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ HTML-—Å—Ç–∞—Ç—É—Å—É*

```plsql
FUNCTION GENERATE_SIGNATURE_HTML(p_is_role BOOLEAN, p_count_cb NUMBER, p_signature_id NUMBER, p_text VARCHAR2) RETURN VARCHAR2
```

---

## ‚úâ –•–æ—á–µ—Ç–µ, —â–æ–± —è:

* –Ω–∞–ø–∏—Å–∞–≤ –≥–æ—Ç–æ–≤–∏–π **–ø–∞–∫–µ—Ç PL/SQL –∑ —Ç–∞–∫–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏**?
* –∞–±–æ –ø—ñ–¥–≥–æ—Ç—É–≤–∞–≤ **–≤–∞—Ä—ñ–∞–Ω—Ç –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º APEX ACL –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ –ø—Ä—è–º–∏–º–∏ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è–º–∏**?

–ù–∞–ø–∏—à—ñ—Ç—å ‚Äî —ñ —è —Å—Ñ–æ—Ä–º—É—é –ø–æ–≤–Ω—ñ—Å—Ç—é –≥–æ—Ç–æ–≤–∏–π –∫–æ–¥. üöÄ
