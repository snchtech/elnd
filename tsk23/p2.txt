–ß—É–¥–æ–≤–æ! –û—Å—å **—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π PL/SQL –ø–∞–∫–µ—Ç**, —è–∫–∏–π:
‚úÖ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –¥–æ—Å—Ç—É–ø—É (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑–∞–º—ñ—â–µ–Ω–Ω—è);
‚úÖ –≥–µ–Ω–µ—Ä—É—î HTML –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏/—Å—Ç–∞—Ç—É—Å—É;
‚úÖ –ø–æ–ª–µ–≥—à—É—î –ø—ñ–¥—Ç—Ä–∏–º–∫—É —Ç–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –ø—ñ–¥ –ì—Ä—É–ø—É 3 —Ç–∞ —ñ–Ω—à–µ.

---

## üåü 1Ô∏è‚É£ –ü–∞–∫–µ—Ç **SIGNATURE\_ACCESS\_PKG**

```plsql
CREATE OR REPLACE PACKAGE signature_access_pkg IS
  FUNCTION get_effective_user_id RETURN NUMBER;
  FUNCTION get_effective_position_id RETURN NUMBER;
  FUNCTION get_effective_department_id RETURN NUMBER;
  FUNCTION get_effective_unit_id RETURN NUMBER;

  FUNCTION is_role_allowed (
    p_signer_group_id      NUMBER,
    p_signer_user_id       NUMBER,
    p_signer_position_id   NUMBER,
    p_signer_department_id NUMBER,
    p_signer_unit_id       NUMBER
  ) RETURN BOOLEAN;

  FUNCTION generate_signature_html (
    p_is_role        BOOLEAN,
    p_count_cb       NUMBER,
    p_signature_id   NUMBER,
    p_button_text    VARCHAR2
  ) RETURN VARCHAR2;
END signature_access_pkg;
/
```

```plsql
CREATE OR REPLACE PACKAGE BODY signature_access_pkg IS

  FUNCTION get_effective_user_id RETURN NUMBER IS
  BEGIN
    RETURN NVL(:P0_NEW_USER_ID, :P0_USER_ID);
  END;

  FUNCTION get_effective_position_id RETURN NUMBER IS
  BEGIN
    RETURN NVL(:P0_NEW_POSITION_ID, :P0_POSITION_ID);
  END;

  FUNCTION get_effective_department_id RETURN NUMBER IS
  BEGIN
    RETURN NVL(:P0_NEW_DEPARTMENT_ID, :P0_DEPARTMENT_ID);
  END;

  FUNCTION get_effective_unit_id RETURN NUMBER IS
  BEGIN
    RETURN NVL(:P0_NEW_UNIT_ID, :P0_UNIT_ID);
  END;

  FUNCTION is_role_allowed (
    p_signer_group_id      NUMBER,
    p_signer_user_id       NUMBER,
    p_signer_position_id   NUMBER,
    p_signer_department_id NUMBER,
    p_signer_unit_id       NUMBER
  ) RETURN BOOLEAN IS
    l_user_id       NUMBER := get_effective_user_id;
    l_position_id   NUMBER := get_effective_position_id;
    l_department_id NUMBER := get_effective_department_id;
    l_unit_id       NUMBER := get_effective_unit_id;
  BEGIN
    CASE p_signer_group_id
      WHEN 2 THEN -- USER
        RETURN l_user_id = p_signer_user_id;

      WHEN 1 THEN -- POSITION + DEPT + UNIT
        IF p_signer_position_id IS NOT NULL AND
           l_position_id = p_signer_position_id THEN

          IF p_signer_department_id IS NULL OR
             l_department_id = p_signer_department_id THEN

            IF p_signer_unit_id IS NULL OR
               l_unit_id = p_signer_unit_id THEN
              RETURN TRUE;
            END IF;

          END IF;

        END IF;
        RETURN FALSE;

      ELSE
        RETURN FALSE; -- –ì—Ä—É–ø–∞ 3 –¥–æ–¥–∞—Ç–∏ –æ–∫—Ä–µ–º–æ
    END CASE;
  END;

  FUNCTION generate_signature_html (
    p_is_role        BOOLEAN,
    p_count_cb       NUMBER,
    p_signature_id   NUMBER,
    p_button_text    VARCHAR2
  ) RETURN VARCHAR2 IS
    l_html VARCHAR2(4000);
  BEGIN
    IF p_is_role AND p_count_cb = 0 THEN
      l_html := '<button id="signature-btn" data-signature-id="' || p_signature_id ||
                '" class="confirm-signature-button">' || p_button_text || '</button>';
    ELSIF p_is_role AND p_count_cb > 0 THEN
      l_html := '<span class="wait-confirm-signature-text">–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏</span>';
    ELSIF NOT p_is_role AND p_count_cb = 0 THEN
      l_html := '<span class="wait-confirm-signature-text wait-confirm-signature-text-current">–†–æ–∑–≥–ª—è–¥–∞—î</span>';
    ELSE
      l_html := '<span class="wait-confirm-signature-text">–û—á—ñ–∫—É—î –≤—ñ–¥–º—ñ—Ç–∫–∏</span>';
    END IF;
    RETURN l_html;
  END;

END signature_access_pkg;
/
```

---

## üåü 2Ô∏è‚É£ –Ø–∫ –∑–º—ñ–Ω—é—î—Ç—å—Å—è –æ—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥?

–í–∞—à –æ—Å–Ω–æ–≤–Ω–∏–π –±–ª–æ–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –π –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å—Ç–∞—î –ø—Ä–æ—Å—Ç–∏–º —ñ —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–º:

```plsql
DECLARE
  l_is_role      BOOLEAN;
  l_count_cb     NUMBER := 0; -- –†–∞—Ö—ñ–≤–Ω–∏–∫ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –ø—ñ–¥—Å—Ç–∞–¥—ñ—ó
  l_signature_id NUMBER := :P1_SIGNATURE_ID; -- –ü—Ä–∏–∫–ª–∞–¥
  l_html         VARCHAR2(4000);
  l_btn_text     VARCHAR2(4000) := '–í—ñ–¥–º—ñ—Ç–∏—Ç–∏';
BEGIN
  l_is_role := signature_access_pkg.is_role_allowed (
                  p_signer_group_id      => :P1_SIGNER_GROUP_ID,
                  p_signer_user_id       => :P1_SIGNER_USER_ID,
                  p_signer_position_id   => :P1_SIGNER_POSITION_ID,
                  p_signer_department_id => :P1_SIGNER_DEPARTMENT_ID,
                  p_signer_unit_id       => :P1_SIGNER_UNIT_ID
               );

  l_html := signature_access_pkg.generate_signature_html (
               p_is_role      => l_is_role,
               p_count_cb     => l_count_cb,
               p_signature_id => l_signature_id,
               p_button_text  => l_btn_text
            );

  -- –í–∏–≤–æ–¥–∏–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  HTP.P(l_html);

  -- –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –æ–Ω–æ–≤—ñ—Ç—å –ª—ñ—á–∏–ª—å–Ω–∏–∫
  IF l_is_role AND l_count_cb = 0 THEN
    l_count_cb := l_count_cb + 1;
  ELSIF NOT l_is_role AND l_count_cb = 0 THEN
    l_count_cb := l_count_cb + 1;
  END IF;
END;
```

---

## üåü 3Ô∏è‚É£ –ü–µ—Ä–µ–≤–∞–≥–∏ —Ç–∞–∫–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É

‚úÖ –í–µ—Å—å –∫–æ–¥ –æ–±—Ä–æ–±–∫–∏ —Ä–æ–ª–µ–π —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –≤–∏–Ω–µ—Å–µ–Ω–æ –≤ –æ–¥–∏–Ω –ø–∞–∫–µ—Ç ‚Äî **–ª–µ–≥–∫–æ —Å—É–ø—Ä–æ–≤–æ–¥–∂—É–≤–∞—Ç–∏**.
‚úÖ –ü—Ä–æ—Å—Ç–∏–π —ñ —á–∏—Å—Ç–∏–π –æ—Å–Ω–æ–≤–Ω–∏–π –±–ª–æ–∫ ‚Äî **–º–µ–Ω—à–µ –¥—É–±–ª—é–≤–∞–Ω–Ω—è**.
‚úÖ –ì–æ—Ç–æ–≤–æ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ì—Ä—É–ø–∏ 3 –∞–±–æ —ñ–Ω—à–∏—Ö –ª–æ–≥—ñ–∫.
‚úÖ –Ø–∫—â–æ –∑–≥–æ–¥–æ–º –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äî **–ª–µ–≥–∫–æ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ APEX\_ACL.HAS\_USER\_ROLE** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `is_role_allowed`.

---

## üöÄ –ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫

–Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ, —è –º–æ–∂—É –æ–¥—Ä–∞–∑—É:

* –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –¥–ª—è –ì—Ä—É–ø–∏ 3 (–∑–º—ñ–Ω–∞);
* –¥–æ–¥–∞—Ç–∏ –≤–∏–∫–ª–∏–∫ APEX ACL –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≥—ñ–±—Ä–∏–¥–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏;
* –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ SQL view –∞–±–æ –ø—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–ª–∏–∫—É –Ω–∞ APEX Server Process.

–°–∫–∞–∂—ñ—Ç—å, —è–∫ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ ‚Äî —ñ —è –ø—ñ–¥–≥–æ—Ç—É—é. üöÄ
