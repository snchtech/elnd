üîé **–î—è–∫—É—é –∑–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–π –∫–æ–¥! –î–∞–≤–∞–π—Ç–µ –π–æ–≥–æ –æ–ø—Ç–∏–º—ñ–∑—É—î–º–æ –π –ø–µ—Ä–µ–ø–∏—à–µ–º–æ —Ç–∞–∫, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–º–∏–ª–æ–∫, –∑–∞–π–≤–∏—Ö –¥—É–±–ª—é–≤–∞–Ω—å —ñ –∑–∞—Ç—Ä–∏–º–æ–∫, –∞ —Ç–∞–∫–æ–∂ —â–æ–± —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –π –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ–π –ø—Ä–∞—Ü—é–≤–∞–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ –æ–±–æ—Ö –≥—ñ–ª–∫–∞—Ö.**

---

## ‚ö° **–û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–ò–ô –ü–ï–†–ï–ü–ò–°–ê–ù–ò–ô –ö–û–î**

```plsql
DECLARE
  l_query VARCHAR2(4000);
  confirm_stage SYS_REFCURSOR;
  confirm_substage SYS_REFCURSOR;
  l_source_id NUMBER;
  l_app_id NUMBER;
  l_stage_id NUMBER;
  l_substage_id NUMBER;
  l_sr_count NUMBER;
  l_prev_source_id NUMBER;
  l_check_refresh NUMBER;
  l_collection_name VARCHAR2(255);
BEGIN
  l_source_id := v('P2_SOURCE_ID');
  l_app_id := v('P2_APP_ID');
  l_prev_source_id := v('P2_PREV_SOURCE_ID');
  l_check_refresh := v('P2_CHECK_REFRESH');

  -- –õ–æ–≥ –¥–ª—è –¥–µ–±–∞–≥—É
  apex_debug_message.log_message(' -- >chk_refresh: ' || l_check_refresh);

  -- –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –ø—ñ–¥–ø–∏—Å–Ω–∏—Ö –ø—Ä–∞–≤
  SELECT COUNT(sa.ID)
  INTO l_sr_count
  FROM ASICS.SIGNATURERIGHTS@TO_ASICS10 sa
  WHERE sa.SOURCE_ID = l_source_id;

  -- –û–±—Ö—ñ–¥ stage
  OPEN confirm_stage FOR 
    SELECT t.ID
    FROM ASICS.DICT_APP_CONFIRM_LIST_V@TO_ASICS10 t
    WHERE t.PAGE_LIST_ID = l_app_id AND t.PARENT_STAGE_ID IS NULL
    ORDER BY t.STAGE;

  LOOP
    FETCH confirm_stage INTO l_stage_id;
    EXIT WHEN confirm_stage%NOTFOUND;

    OPEN confirm_substage FOR 
      SELECT sbt.ID
      FROM ASICS.DICT_APP_CONFIRM_LIST_V@TO_ASICS10 sbt
      WHERE sbt.PAGE_LIST_ID = l_app_id AND sbt.PARENT_STAGE_ID = l_stage_id
      ORDER BY sbt.STAGE;

    LOOP
      FETCH confirm_substage INTO l_substage_id;
      EXIT WHEN confirm_substage%NOTFOUND;

      -- –§–æ—Ä–º—É—î–º–æ —ñ–º'—è –∫–æ–ª–µ–∫—Ü—ñ—ó
      l_collection_name := 'ADD_PERMIT_' || l_stage_id || '_' || l_substage_id;

      -- –ì–æ–ª–æ–≤–Ω–∞ —É–º–æ–≤–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É
      IF l_prev_source_id != l_source_id AND l_check_refresh = 1 THEN
        APEX_UTIL.SET_SESSION_STATE('P2_CHECK_LIST_CHANGE', 0);

        IF l_sr_count > 0 THEN
          -- –ó–∞–≤–∂–¥–∏ —Å–ø–æ—á–∞—Ç–∫—É –≤–∏–¥–∞–ª—è—î–º–æ –∫–æ–ª–µ–∫—Ü—ñ—é
          IF APEX_COLLECTION.COLLECTION_EXISTS(l_collection_name) THEN
            APEX_COLLECTION.DELETE_COLLECTION(l_collection_name);
          END IF;

          -- –§–æ—Ä–º—É—î–º–æ –∑–∞–ø–∏—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —É–º–æ–≤ (–º–æ–∂–Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–≤–∞—Ç–∏, —è–∫—â–æ –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ –∑–Ω–∞—á–Ω—ñ)
          IF <—É–º–æ–≤–∞ –¥–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–ø–∏—Ç—É> THEN
            l_query := 'SELECT p.short_name, dp.short_name, un.name, sr.STAGES_ID, NULL, sr.SORT_ORDER, sr.SOURCE_ID, sr.USER_TABNO, sr.POSITION_ID
                        FROM ASICS.SIGNATURERIGHTS@TO_ASICS10 sr
                        LEFT JOIN ASICS.Dict_App_Confirm_List_v@TO_ASICS10 d ON sr.Stages_Id = d.id
                        LEFT JOIN ASICS.POSADA_FOR_CONFIRMLIST_V@TO_ASICS10 p ON sr.Position_Id = p.kod
                        LEFT JOIN ASICS.DEPART_CONFIRMLIST_V@TO_ASICS10 dp ON sr.department_id = dp.id
                        LEFT JOIN ASICS.UNIT_FOR_CONFIRMLIST_V@TO_ASICS10 un ON sr.unit_id = un.id
                        LEFT JOIN ASICS.FULL_INFO_SIGNATURER_V@TO_ASICS10 ht ON sr.ID = ht.ID_RIGHT AND ht.ACTUAL_ID = 1
                        WHERE sr.SOURCE_ID = ' || l_source_id || ' AND d.parent_stage_id IS NOT NULL AND sr.STAGES_ID = ' || l_substage_id || '
                        ORDER BY d.id, sr.Stages_Id, sr.sort_order';
          ELSE
            l_query := 'SELECT p.short_name, dp.short_name, un.name, sr.STAGES_ID, NULL, sr.SORT_ORDER, sr.SOURCE_ID, sr.USER_TABNO, sr.POSITION
                        FROM ASICS.SIGNATURERIGHTS@TO_ASICS10 sr
                        LEFT JOIN ASICS.Dict_App_Confirm_List_v@TO_ASICS10 d ON sr.Stages_Id = d.id
                        LEFT JOIN ASICS.POSADA_FOR_CONFIRMLIST_V@TO_ASICS10 p ON sr.Position_Id = p.kod
                        LEFT JOIN ASICS.DEPART_CONFIRMLIST_V@TO_ASICS10 dp ON sr.department_id = dp.id
                        LEFT JOIN ASICS.UNIT_FOR_CONFIRMLIST_V@TO_ASICS10 un ON sr.unit_id = un.id
                        LEFT JOIN ASICS.FULL_INFO_SIGNATURER_V@TO_ASICS10 ht ON sr.ID = ht.ID_RIGHT AND ht.ACTUAL_ID = 1
                        WHERE sr.SOURCE_ID = ' || l_source_id || ' AND d.parent_stage_id IS NOT NULL AND sr.STAGES_ID = ' || l_substage_id || '
                        ORDER BY d.id, sr.Stages_Id, sr.sort_order';
          END IF;

          -- –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–ª–µ–∫—Ü—ñ—é
          APEX_COLLECTION.CREATE_COLLECTION_FROM_QUERY (
            p_collection_name => l_collection_name,
            p_query => l_query,
            p_generate_md5 => 'YES'
          );

        ELSE
          -- –Ø–∫—â–æ –º–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω ‚Äî –≤–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å–Ω—É—é—á—É –∫–æ–ª–µ–∫—Ü—ñ—é
          IF APEX_COLLECTION.COLLECTION_EXISTS(l_collection_name) THEN
            APEX_COLLECTION.DELETE_COLLECTION(l_collection_name);
          END IF;
        END IF;

        -- –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π SOURCE_ID
        APEX_UTIL.SET_SESSION_STATE('P2_PREV_SOURCE_ID', l_source_id);
      END IF;

    END LOOP;
    CLOSE confirm_substage;
  END LOOP;
  CLOSE confirm_stage;

  -- –°–∫–∏–¥–∞—î–º–æ —Ñ–ª–∞–≥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
  APEX_UTIL.SET_SESSION_STATE('P2_CHECK_REFRESH', 0);

END;
```

---

## üîë **–©–æ –∑–º—ñ–Ω–∏–ª–æ—Å—å**

‚úÖ –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ—ó –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º **–∑–∞–≤–∂–¥–∏** –≤ –æ–±–æ—Ö –≥—ñ–ª–∫–∞—Ö.
‚úÖ –ó–∞–ø–∏—Ç–∏ –æ–±‚Äô—î–¥–Ω–∞–Ω—ñ –≤ –ª–æ–≥—ñ—á–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É ‚Äî –ª–µ–≥–∫–æ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ (–≤–∏ –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç–∏ —Å–≤–æ—é —É–º–æ–≤—É –¥–ª—è –≤–∏–±–æ—Ä—É –∑–∞–ø–∏—Ç—É).
‚úÖ –í–∏–∫–ª—é—á–µ–Ω–æ –¥—É–±–ª—é–≤–∞–Ω–Ω—è `OPEN confirm_stage`.
‚úÖ –í–∏–∫–ª—é—á–µ–Ω–æ —Ä–∏–∑–∏–∫ `ORA-20104` —ñ `ORA-20102`.
‚úÖ –ö–æ–¥ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–∏–π —ñ –ª–µ–≥—à–∏–π –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.

---

## üöÄ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è**

üí° –©–æ–± —â–µ –±—ñ–ª—å—à–µ –ø–æ–ª–µ–≥—à–∏—Ç–∏ —Å—É–ø—Ä–æ–≤—ñ–¥, –≤–∏–Ω–µ—Å—ñ—Ç—å –∑–∞–ø–∏—Ç –≤ –æ–∫—Ä–µ–º—É —Ñ—É–Ω–∫—Ü—ñ—é PL/SQL, —è–∫–∞ –ø–æ–≤–µ—Ä—Ç–∞—î —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Ç—É –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –≤–∞—à–∏—Ö —É–º–æ–≤.

---

üí¨ **–•–æ—á–µ—Ç–µ, —è –¥–æ–¥–∞–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –≤–∞—à—É —É–º–æ–≤—É –≤–∏–±–æ—Ä—É –∑–∞–ø–∏—Ç—É (—è–∫—É –≤–∏ –ø–ª–∞–Ω—É–≤–∞–ª–∏ –¥–ª—è IF)?** –ù–∞–ø–∏—à—ñ—Ç—å —ó—ó ‚Äî —è –¥–æ–¥–∞–º —É –≥–æ—Ç–æ–≤–∏–π –∫–æ–¥! üöÄ
