üí° **–î—è–∫—É—é –∑–∞ –∫–æ–¥! –î–∞–≤–∞–π—Ç–µ –π–æ–≥–æ —É–≤–∞–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É—î–º–æ, –∑–Ω–∞–π–¥–µ–º–æ –≤—Å—ñ –º–æ–∂–ª–∏–≤—ñ –¥–∂–µ—Ä–µ–ª–∞ –ø–æ–º–∏–ª–æ–∫ —ñ –ø–µ—Ä–µ–ø–∏—à–µ–º–æ —É —Å—Ç–∞–±—ñ–ª—å–Ω—É —Ç–∞ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—É —Ñ–æ—Ä–º—É.**

---

## ‚ö† **–û—Å–Ω–æ–≤–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É –∫–æ–¥—ñ**

### 1Ô∏è‚É£ **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å `DELETE_COLLECTION` –ø–µ—Ä–µ–¥ `CREATE_COLLECTION_FROM_QUERY` –≤ —É—Å—ñ—Ö –≥—ñ–ª–∫–∞—Ö**

üëâ –£ –≥—ñ–ª—Ü—ñ `ELSE` –≤–∏ —Å—Ç–≤–æ—Ä—é—î—Ç–µ –∫–æ–ª–µ–∫—Ü—ñ—é –±–µ–∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –π –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó ‚Üí —Ä–∏–∑–∏–∫ `ORA-20104`.

---

### 2Ô∏è‚É£ **–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–µ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤**

üëâ –£ –∑–∞–ø–∏—Ç–∞—Ö:

* –Ñ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∏ (`|I`, `|l`, –∑–∞–π–≤—ñ —Å–∏–º–≤–æ–ª–∏).
* –Ñ –º—ñ—Å—Ü—è –±–µ–∑ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `WHERE sr.TASK_ID = '|| l_source_id` ‚Äî —Ç–∏–ø—É –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑‚Äô—î–¥–Ω–∞–Ω–æ).

---

### 3Ô∏è‚É£ **–î—É–±–ª—é–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –±–µ–∑ –ø–æ—Ç—Ä–µ–±–∏**

üëâ –î–≤–∞ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ –æ–¥–Ω–∞–∫–æ–≤—ñ –∑–∞–ø–∏—Ç–∏ –≤ `IF / ELSE`, –∞–ª–µ –±–µ–∑ —Å–µ–Ω—Å—É –¥—É–±–ª—é–≤–∞—Ç–∏ ‚Äî –∫—Ä–∞—â–µ —É–º–æ–≤–Ω–æ –±—É–¥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç.

---

### 4Ô∏è‚É£ **–í—ñ–¥—Å—É—Ç–Ω—î –æ—á–∏—â–µ–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ–π –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö**

üëâ –Ø–∫—â–æ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ —É SIGNATURERIGHTS ‚Äî –∫–æ–ª–µ–∫—Ü—ñ—ó –Ω–µ –æ—á–∏—â—É—é—Ç—å—Å—è —è–≤–Ω–æ.

---

### 5Ô∏è‚É£ **–ú–æ–∂–ª–∏–≤—ñ –∑–∞—Ç—Ä–∏–º–∫–∏ —á–µ—Ä–µ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ —ñ –∫–æ–ª–µ–∫—Ü—ñ–π**

üëâ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–¥–Ω–∏—Ö —ñ —Ç–∏—Ö —Å–∞–º–∏—Ö –∫–æ–ª–µ–∫—Ü—ñ–π –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤ –±–µ–∑ –æ—á–∏—â–µ–Ω–Ω—è.

---

## üöÄ **–û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–π –∫–æ–¥**

```plsql
DECLARE
  l_query VARCHAR2(4000);
  confirm_stage SYS_REFCURSOR;
  confirm_substage SYS_REFCURSOR;
  l_source_id NUMBER;
  l_app_id NUMBER;
  l_stage_id NUMBER;
  l_substage_id NUMBER;
  l_sr_count NUMBER;
  l_page_list_id NUMBER;
  l_collection_name VARCHAR2(255);
BEGIN
  l_source_id := v('P5_TASK_ID');
  l_app_id := :APP_ID;
  l_page_list_id := v('P_PAGE_LIST_ID');

  -- –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–ø–∏—Å—ñ–≤ SIGNATURERIGHTS
  SELECT COUNT(sa.ID)
  INTO l_sr_count
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sa
  WHERE sa.TASK_ID = l_source_id;

  -- –û–±—Ö—ñ–¥ stage
  OPEN confirm_stage FOR 
    SELECT t.ID
    FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 t
    WHERE t.PAGE_LIST_ID = l_page_list_id AND t.PARENT_STAGE_ID IS NULL
    ORDER BY t.STAGE;

  LOOP
    FETCH confirm_stage INTO l_stage_id;
    EXIT WHEN confirm_stage%NOTFOUND;

    OPEN confirm_substage FOR 
      SELECT sbt.ID
      FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 sbt
      WHERE sbt.PAGE_LIST_ID = l_page_list_id AND sbt.PARENT_STAGE_ID = l_stage_id
      ORDER BY sbt.STAGE;

    LOOP
      FETCH confirm_substage INTO l_substage_id;
      EXIT WHEN confirm_substage%NOTFOUND;

      l_collection_name := 'CONFIRM_CART_' || l_stage_id || '_' || l_substage_id;

      -- –ó–∞–≤–∂–¥–∏ –≤–∏–¥–∞–ª—è—î–º–æ —ñ—Å–Ω—É—é—á—É –∫–æ–ª–µ–∫—Ü—ñ—é
      IF APEX_COLLECTION.COLLECTION_EXISTS(l_collection_name) THEN
        APEX_COLLECTION.DELETE_COLLECTION(l_collection_name);
      END IF;

      -- –Ø–∫—â–æ —î –ø—ñ–¥–ø–∏—Å–∏ ‚Äî –±—É–¥—É—î–º–æ –∑–∞–ø–∏—Ç —ñ —Å—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–ª–µ–∫—Ü—ñ—é
      IF l_sr_count > 0 THEN
        l_query := 'SELECT p.short_name, dp.short_name, un.name, sr.STAGES_ID, NULL, sr.SORT_ORDER, sr.TASK_ID, ' ||
                   'sr.USER_TABNO, sr.POSITION_ID, sr.DEPARTMENT_ID, sr.UNIT_ID, sr.ID ' ||
                   'FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr ' ||
                   'LEFT JOIN TaskTracker.Dict_App_Confirm_List@TO_TASKTRACKER10 d ON sr.Stages_Id = d.id ' ||
                   'LEFT JOIN TaskTracker.POSADA_FOR_CONFIRMLIST_V@TO_TASKTRACKER10 p ON sr.Position_Id = p.kod ' ||
                   'LEFT JOIN TaskTracker.DEPART_CONFIRMLIST_V@TO_TASKTRACKER10 dp ON sr.department_id = dp.id ' ||
                   'LEFT JOIN TaskTracker.DICT_UNIT@TO_TASKTRACKER10 un ON sr.unit_id = un.id ' ||
                   'WHERE sr.TASK_ID = ' || l_source_id || ' ' ||
                   'AND d.parent_stage_id IS NOT NULL ' ||
                   'AND sr.STAGES_ID = ' || l_substage_id || ' ' ||
                   'ORDER BY d.id, sr.Stages_Id, sr.sort_order';

        APEX_COLLECTION.CREATE_COLLECTION_FROM_QUERY (
          p_collection_name => l_collection_name,
          p_query => l_query,
          p_generate_md5 => 'YES'
        );

      END IF;

      -- –Ø–∫—â–æ –ø—ñ–¥–ø–∏—Å—ñ–≤ –Ω–µ–º–∞—î ‚Äî –∫–æ–ª–µ–∫—Ü—ñ—è –≤–∂–µ –æ—á–∏—â–µ–Ω–∞ –≤–∏—â–µ

    END LOOP;
    CLOSE confirm_substage;
  END LOOP;
  CLOSE confirm_stage;
END;
```

---

## ‚úÖ **–©–æ –∑–º—ñ–Ω–∏–ª–æ—Å—å**

‚úÖ –ö–æ–ª–µ–∫—Ü—ñ—è **–∑–∞–≤–∂–¥–∏ –æ—á–∏—â–∞—î—Ç—å—Å—è –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –∞–±–æ –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö**.
‚úÖ –î—É–±–ª—é–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –ø—Ä–∏–±—Ä–∞–Ω–æ ‚Äî –æ–¥–∏–Ω –∑–∞–ø–∏—Ç, –ª–æ–≥—ñ–∫–∞ –ø—Ä–æ—Å—Ç–∞.
‚úÖ –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ (–∂–æ–¥–Ω–∏—Ö `|I`, `|l`, –ø–æ–º–∏–ª–æ–∫ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü—ñ—ó).
‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥—É –∫–æ–º–ø–∞–∫—Ç–Ω–∞ –π —Å—Ç–∞–±—ñ–ª—å–Ω–∞.

---

## üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó**

üåü –î–æ–¥–∞–π—Ç–µ `FOR rec IN (SELECT collection_name FROM APEX_COLLECTIONS WHERE collection_name LIKE 'CONFIRM_CART_%') LOOP APEX_COLLECTION.DELETE_COLLECTION(rec.collection_name); END LOOP;`
–Ω–∞ –ø–æ—á–∞—Ç–∫—É –ø—Ä–æ—Ü–µ—Å—É, —è–∫—â–æ —Ö–æ—á–µ—Ç–µ –º–∞—Å–æ–≤–µ –æ—á–∏—â–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º –Ω–æ–≤–æ—ó –∫–∞—Ä—Ç–∫–∏.

üåü –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ bind –∑–º—ñ–Ω–Ω—ñ –¥–ª—è `TASK_ID` —ñ `STAGES_ID` —É –¥–∏–Ω–∞–º—ñ—á–Ω–æ–º—É SQL –¥–ª—è –±—ñ–ª—å—à–æ—ó –±–µ–∑–ø–µ–∫–∏ (—è–∫—â–æ –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–∏ –Ω–∞ `EXECUTE IMMEDIATE`).

---

## üí¨ **–•–æ—á–µ—Ç–µ, —è –¥–æ–¥–∞–º –≥–æ—Ç–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å –æ—á–∏—â–µ–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ–π –∞–±–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é –Ω–∞ –ø–∞–∫–µ—Ç / —Ñ—É–Ω–∫—Ü—ñ—é?**

–ù–∞–ø–∏—à—ñ—Ç—å ‚Äî —è –ø—ñ–¥–≥–æ—Ç—É—é! üöÄ
