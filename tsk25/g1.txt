üîé **–ß—É–¥–æ–≤–æ —Ä–æ–∑–ø–∏—Å–∞–ª–∏ –∑–∞–¥–∞—á—É! –Ø –∑—ñ–±—Ä–∞–≤ —É—Å–µ –≤ —î–¥–∏–Ω–∏–π –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –±–ª–æ–∫ –∫–æ–¥—É, —è–∫–∏–π:**
‚úÖ –í—Ä–∞—Ö–æ–≤—É—î `:P6_TASK_MODE` (0 ‚Äî –¥–ª—è TASK, 1 ‚Äî –¥–ª—è TEMPLATE).
‚úÖ –ë—É–¥—É—î –∫–æ–ª–µ–∫—Ü—ñ—ó –±–µ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –ª–æ–≥—ñ–∫–∏.
‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ–Ω–æ–≤–ª–µ–Ω–∏–π –∑–∞–ø–∏—Ç, —è–∫–∏–π –≤–∏ –≤–∫–∞–∑–∞–ª–∏.
‚úÖ –û—á–∏—â–∞—î –π —Å—Ç–≤–æ—Ä—é—î –∫–æ–ª–µ–∫—Ü—ñ—ó –∞–∫—É—Ä–∞—Ç–Ω–æ.

---

## üöÄ **–ü–µ—Ä–µ—Ä–æ–±–ª–µ–Ω–∏–π PL/SQL –∫–æ–¥**

```plsql
DECLARE
  confirm_stage SYS_REFCURSOR;
  confirm_substage SYS_REFCURSOR;
  l_source_id NUMBER;
  l_app_id NUMBER;
  l_stage_id NUMBER;
  l_substage_id NUMBER;
  l_sr_count NUMBER;
  l_page_list_id NUMBER;
  l_collection_name VARCHAR2(255);
BEGIN
  l_source_id := v('P5_TASK_ID');
  l_app_id := :APP_ID;
  l_page_list_id := v('P_PAGE_LIST_ID');

  -- –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø—ñ–¥–ø–∏—Å–Ω–∏—Ö –ø—Ä–∞–≤
  SELECT COUNT(1) INTO l_sr_count
  FROM TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 
  WHERE TASK_ID = l_source_id;

  -- –û–±—Ö—ñ–¥ –µ—Ç–∞–ø—ñ–≤
  OPEN confirm_stage FOR 
    SELECT t.ID
    FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 t
    WHERE t.PAGE_LIST_ID = l_page_list_id AND t.PARENT_STAGE_ID IS NULL
    ORDER BY t.STAGE;

  LOOP
    FETCH confirm_stage INTO l_stage_id;
    EXIT WHEN confirm_stage%NOTFOUND;

    -- –û–±—Ö—ñ–¥ –ø—ñ–¥–µ—Ç–∞–ø—ñ–≤
    OPEN confirm_substage FOR 
      SELECT sbt.ID
      FROM TaskTracker.DICT_APP_CONFIRM_LIST@TO_TASKTRACKER10 sbt
      WHERE sbt.PAGE_LIST_ID = l_page_list_id AND sbt.PARENT_STAGE_ID = l_stage_id
      ORDER BY sbt.STAGE;

    LOOP
      FETCH confirm_substage INTO l_substage_id;
      EXIT WHEN confirm_substage%NOTFOUND;

      l_collection_name := 'CONFIRM_CART_' || l_stage_id || '_' || l_substage_id;

      -- –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ–ª–µ–∫—Ü—ñ—é —è–∫—â–æ —ñ—Å–Ω—É—î
      IF APEX_COLLECTION.COLLECTION_EXISTS(l_collection_name) THEN
        APEX_COLLECTION.DELETE_COLLECTION(l_collection_name);
      END IF;

      -- –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–ª–µ–∫—Ü—ñ—é —è–∫—â–æ —î –∑–∞–ø–∏—Å–∏
      IF l_sr_count > 0 THEN
        APEX_COLLECTION.CREATE_COLLECTION(l_collection_name);

        FOR r IN (
          SELECT
            p1.SPR_DOLZNOST AS spr_dolznost,
            sd.SHORT_NAME AS dep_short,
            un.NAME AS unit_name,
            sr.STAGES_ID,
            sr.SORT_ORDER,
            sr.TASK_ID,
            sr.USER_TABNO,
            sr.POSITION_ID,
            sr.DEPARTMENT_ID,
            sr.UNIT_ID,
            sr.ID AS sr_id,
            ht.ID AS ht_id,
            p.FAMILIA AS l_name,
            p.IMYA AS f_name,
            p.OTCHESTVO AS m_name,
            p.SPR_DOLZNOST AS posada,
            p.TSEH_SHORT AS depart,
            TO_CHAR(ht.SDATE, 'dd.mm.yyyy hh24:mi:ss') AS sign_date,
            sr.SUBTASK_ID,
            sr.SR_TASK_MODE
          FROM
            TaskTracker.SIGNATURERIGHTS@TO_TASKTRACKER10 sr
          LEFT JOIN
            TaskTracker.Dict_App_Confirm_List@TO_TASKTRACKER10 d
            ON sr.Stages_Id = d.ID
          LEFT JOIN
            kbs.PERSONAL@TO_TASKTRACKER10 p1
            ON p1.DOLZNOST = sr.Position_Id
          LEFT JOIN
            kbs.SPR_DEPARTMENT@TO_TASKTRACKER10 sd
            ON sd.ID = sr.DEPARTMENT_ID
          LEFT JOIN
            TaskTracker.DICT_UNIT@TO_TASKTRACKER10 un
            ON sr.UNIT_ID = un.ID
          LEFT JOIN
            TaskTracker.SIGNATUREHISTORY@TO_TASKTRACKER10 ht
            ON sr.ID = ht.SIGNRIGHT_ID
          LEFT JOIN
            kbs.PERSONAL@TO_TASKTRACKER10 p
            ON p.TAB_NO = ht.SIGNER_BY
          WHERE
            sr.TASK_ID = l_source_id
            AND d.PARENT_STAGE_ID IS NOT NULL
            AND sr.STAGES_ID = l_substage_id
            AND p.PRIZNAK IS NULL
            AND p1.PRIZNAK IS NULL
            AND sd.DATE_END IS NULL
            AND sd.SPRDEPARTMENT_ID IS NULL
          ORDER BY
            d.ID, sr.STAGES_ID, sr.SORT_ORDER
        ) LOOP
          APEX_COLLECTION.ADD_MEMBER(
            p_collection_name => l_collection_name,
            p_c001 => r.spr_dolznost,
            p_c002 => r.dep_short,
            p_c003 => r.unit_name,
            p_c004 => r.STAGES_ID,
            p_c005 => r.SORT_ORDER,
            p_c006 => r.TASK_ID,
            p_c007 => r.USER_TABNO,
            p_c008 => r.POSITION_ID,
            p_c009 => r.DEPARTMENT_ID,
            p_c010 => r.UNIT_ID,
            p_c011 => r.sr_id,
            p_c012 => r.ht_id,
            p_c013 => r.l_name,
            p_c014 => r.f_name,
            p_c015 => r.m_name,
            p_c016 => r.posada,
            p_c017 => r.depart,
            p_c018 => r.sign_date,
            p_c019 => r.SUBTASK_ID,
            p_n001 => r.SR_TASK_MODE
          );
        END LOOP;
      END IF;

    END LOOP;
    CLOSE confirm_substage;
  END LOOP;
  CLOSE confirm_stage;
END;
```

---

## ‚úÖ **–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏**

‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ `l_sr_count`** ‚Üí –∫–æ–ª–µ–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –∑–∞–ø–∏—Å–∏.
‚úÖ **–û—á–∏—Å—Ç–∫–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º** ‚Üí –∑–∞–ø–æ–±—ñ–≥–∞—î ORA-20104.
‚úÖ **–î–∞–Ω—ñ –¥–æ–¥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ `APEX_COLLECTION.ADD_MEMBER`** ‚Üí —è–∫ —É –ø—Ä–∏–∫–ª–∞–¥—ñ –∑ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è–º–∏.
‚úÖ **–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –∑–∞–ø–∏—Ç** ‚Üí –Ω–µ–º–∞—î –¥—É–±–ª—é–≤–∞–Ω–Ω—è –¥–ª—è ELSE –≥—ñ–ª–æ–∫.

---

## üí° **–î–æ–¥–∞—Ç–∫–æ–≤–æ**

üìå –Ø–∫—â–æ —Ç—Ä–µ–±–∞ –≤—Ä–∞—Ö—É–≤–∞—Ç–∏ `:P6_TASK_MODE` –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –¥–∂–µ—Ä–µ–ª–∞ (TASK/TEMPLATE), —Ç–∏ –º–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ —É WHERE:

```sql
AND sr.SR_TASK_MODE = :P6_TASK_MODE
```

–∞–±–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –≤–∂–µ –ø—Ä–∏ –ø–æ–±—É–¥–æ–≤—ñ –∫–æ–ª–µ–∫—Ü—ñ—ó.

---

## üí¨ **–•–æ—á–µ—à, —â–æ–± —è –ø—ñ–¥–≥–æ—Ç—É–≤–∞–≤ –≥–æ—Ç–æ–≤–∏–π —Ñ–∞–π–ª –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É –≤ APEX –∞–±–æ –ø–æ—è—Å–Ω–∏–≤ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –∑ —Ä–µ–≥—ñ–æ–Ω–æ–º?**

–ù–∞–ø–∏—à–∏ ‚Äî —è –∑–≥–µ–Ω–µ—Ä—É—é! üöÄ
