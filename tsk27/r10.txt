–ß—É–¥–æ–≤–æ! –Ø–∫—â–æ –≤ —Ç–∞–±–ª–∏—Ü—ñ `signaturerights` **–Ω–µ–º–∞—î –∫–æ–ª–æ–Ω–∫–∏ `status`**, –∞–ª–µ —Ç–∏ –≤–µ–¥–µ—à **—Ñ–∞–∫—Ç –ø—ñ–¥–ø–∏—Å—É** —á–µ—Ä–µ–∑ `signaturehistory`, —Ç–æ–¥—ñ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –ª–æ–≥—ñ–∫–æ—é –±—É–¥–µ:

* –≤–∑—è—Ç–∏ **—É—Å—ñ –∑–∞–ø–∏—Å–∏ –∑ `signaturerights`**, —è–∫—ñ **—â–µ –Ω–µ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ** (`–Ω–µ–º–∞—î –∑–∞–ø–∏—Å—É –≤ `signaturehistory`–∑–∞ —Ü–∏–º`signright\_id\`)
* —Å–µ—Ä–µ–¥ –Ω–∏—Ö –≤—ñ–¥—ñ–±—Ä–∞—Ç–∏ **–Ω–∞–π–±–ª–∏–∂—á–∏–π (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π) `stages_order`** –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ `task_id` ‚Äî —Ü–µ –±—É–¥–µ **–ø–æ—Ç–æ—á–Ω–∞ —á–µ—Ä–≥–∞ –Ω–∞ –ø—ñ–¥–ø–∏—Å**
* –¥–∞–ª—ñ ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ —Ü–µ–π –∑–∞–ø–∏—Å –Ω–∞–ª–µ–∂–∏—Ç—å **—Å–∞–º–µ —Ç–æ–±—ñ** (`user_id` –∞–±–æ `position+department+unit`)

---

### ‚úÖ –ó–∞–ø–∏—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ ‚Äú–î–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è‚Äù (—á–µ—Ä–µ–∑ `signaturerights` + `signaturehistory`):

```sql
-- –≤–∫–ª–∞–¥–∫–∞ TODO (–î–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è)
(:PXX_TAB_MODE = 'TODO'
 AND EXISTS (
   SELECT 1
   FROM signaturerights sr
   WHERE sr.task_id = t.id
     AND NOT EXISTS (
       SELECT 1
       FROM signaturehistory sh
       WHERE sh.signright_id = sr.id
     )
     AND sr.stages_order = (
       SELECT MIN(sr2.stages_order)
       FROM signaturerights sr2
       WHERE sr2.task_id = sr.task_id
         AND NOT EXISTS (
           SELECT 1
           FROM signaturehistory sh2
           WHERE sh2.signright_id = sr2.id
         )
     )
     AND (
       sr.user_id = :P0_USER_ID
       OR (
         sr.user_id IS NULL
         AND sr.position_id = :P0_POSITION_ID
         AND sr.department_id = :P0_DEPARTMENT_ID
         AND sr.unit_id = :P0_UNIT_ID
       )
     )
 ))
```

---

### üß† –©–æ —Ç—É—Ç –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è:

* `NOT EXISTS (...)` ‚Äî –æ–∑–Ω–∞—á–∞—î, —â–æ **–∑–∞–ø–∏—Å —É `signaturerights` —â–µ –Ω–µ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π** (–≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É `signaturehistory`).
* `MIN(stages_order)` ‚Äî –º–∏ –±–µ—Ä–µ–º–æ **–Ω–∞–π–ø–µ—Ä—à–∏–π –Ω–µ–ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –µ—Ç–∞–ø** —É –∑–∞–≤–¥–∞–Ω–Ω—ñ.
* –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ —Å–∞–º–µ **–ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á** –º–∞—î –ø—ñ–¥–ø–∏—Å–∞—Ç–∏ (–ø–æ `user_id` –∞–±–æ –ø–æ `position+department+unit`).

---

### üìå –ü–æ—Ä–∞–¥–∞:

* –Ø–∫—â–æ `signaturehistory` —ñ–Ω–æ–¥—ñ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å `signright_id`, –∞ –ª–∏—à–µ `task_id + stage_id` ‚Äî –º–æ–∂–Ω–∞ –ø—Ä–∏—î–¥–Ω—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ —Ü—ñ –ø–æ–ª—è.
* –Ø–∫—â–æ —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à **–∑–∞–º—ñ–Ω—É (substitution)** ‚Äî –≤–∞—Ä—Ç–æ –¥–æ–¥–∞—Ç–∏ CTE `user_ctx` (–º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏).

---

üîî –•–æ—á–µ—à ‚Äî –ø–µ—Ä–µ—Ä–æ–±–ª—é —Ü–µ–π –∑–∞–ø–∏—Ç –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º `substitution_mode` —ñ `user_ctx`, —è–∫ —É —Ç–≤–æ—ó—Ö –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –∑–∞–ø–∏—Ç–∞—Ö.
