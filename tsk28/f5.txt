–©–æ–± —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –æ–ø–∏—Å–∞–Ω—É –ª–æ–≥—ñ–∫—É:

> **–Ø–∫—â–æ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É –≤ `task_access_control` (–Ω—ñ –ø–æ `user_id`, –Ω—ñ –ø–æ `position_id` + `department_id` + `unit_id`) ‚Äî —Ç–æ–¥—ñ –≤—ñ–¥–ø—Ä–∞—Ü—å–æ–≤—É—î –ª–æ–≥—ñ–∫–∞ —è–∫ –¥–ª—è `access_level = 3`, —Ç–æ–±—Ç–æ –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —Ç—ñ –∑–∞–≤–¥–∞–Ω–Ω—è, –¥–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î —É `signaturerights`.**

---

### ‚úÖ –†—ñ—à–µ–Ω–Ω—è:

1. –î–æ–¥–∞–π –æ–∫—Ä–µ–º—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É `NOT EXISTS` –¥–ª—è `task_access_control` ‚Äî **–Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É** –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
2. –î–æ–¥–∞–π `OR EXISTS (signaturerights...)` —É —Ä–∞–∑—ñ —Ü—å–æ–≥–æ `NOT EXISTS`.

---

### üîß –û–ù–û–í–õ–ï–ù–ò–ô `AND (...)` –ë–õ–û–ö:

```sql
AND (
  -- –Ø–∫—â–æ –¥–æ—Å—Ç—É–ø —î –≤ task_access_control
  EXISTS (
    SELECT 1
    FROM task_access_control ac
    WHERE 
      (
        ac.access_level = 1
        AND (
          ac.user_id = :P0_USER_ID
          OR ac.position_id = :P0_POSITION_ID
        )
      )
      OR
      (
        ac.access_level = 2
        AND (
          (ac.position_id IS NULL OR ac.position_id = :P0_POSITION_ID)
          AND (ac.department_id IS NULL OR ac.department_id = :P0_DEPARTMENT_ID)
          AND (ac.unit_id IS NULL OR ac.unit_id = :P0_UNIT_ID)
        )
        AND (
          ac.user_id IS NULL OR ac.user_id = :P0_USER_ID
        )
      )
      OR
      (
        ac.access_level = 3
        AND ac.user_id = :P0_USER_ID
      )
      AND ac.task_id = t.id
      AND ROWNUM = 1
  )

  -- –ê–ë–û —è–∫—â–æ –¥–æ—Å—Ç—É–ø—ñ–≤ –Ω–µ–º–∞—î –≤–∑–∞–≥–∞–ª—ñ ‚Äî —Ç–æ–¥—ñ —Ç—ñ–ª—å–∫–∏ —Ç—ñ –∑–∞–¥–∞—á—ñ, –¥–µ —î –≤ signaturerights
  OR (
    NOT EXISTS (
      SELECT 1
      FROM task_access_control ac
      WHERE 
        (ac.user_id = :P0_USER_ID OR ac.position_id = :P0_POSITION_ID)
        AND ac.task_id = t.id
    )
    AND EXISTS (
      SELECT 1
      FROM signaturerights sr
      WHERE sr.task_id = t.id
        AND sr.user_id = :P0_USER_ID
    )
  )
)
```

---

### üìù –ü–æ—è—Å–Ω–µ–Ω–Ω—è:

* **`EXISTS (...)`** ‚Äî —è–∫—â–æ —î –∑–∞–ø–∏—Å –≤ `task_access_control` ‚Äî –ø—Ä–∞—Ü—é—î –∑–≤–∏—á–∞–π–Ω–∞ –ª–æ–≥—ñ–∫–∞ –¥–æ—Å—Ç—É–ø—É.
* **`NOT EXISTS (...) AND EXISTS (...)`** ‚Äî —è–∫—â–æ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É –ø–æ –¥–æ—Å—Ç—É–ø—É ‚Äî —Ç–æ–¥—ñ –¥–∏–≤–∏–º–æ—Å—å, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î –≤ `signaturerights`.

---

### ‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–∫–æ—Ä–æ—Ç—à–∞ –≤–µ—Ä—Å—ñ—è):

–Ø–∫—â–æ `task_access_control` –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –≤–∑–∞–≥–∞–ª—ñ `user_id` –∞–±–æ `position_id`, –º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ `user_has_access` —É CTE —ñ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –¥–∞–ª—ñ –∑ –Ω–∏–º. –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äî –ø—ñ–¥–∫–∞–∂—É —Ü–µ–π –≤–∞—Ä—ñ–∞–Ω—Ç.
