–û—Å—å –ø–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–π SQL-–∑–∞–ø–∏—Ç —ñ–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —É—Å—ñ—Ö —Ç–≤–æ—ó—Ö —É–º–æ–≤:

* —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ `:PXX_TAB_MODE`;
* –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É (access level 1/2/3 —ñ signaturerights);
* –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–∫–∏ `status_label_problem` –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ `PROBLEM`;
* **–±–µ–∑ –≤–∏—Ç–æ–∫—É –∑–∞–ø–∏—Å—ñ–≤ –∑ —ñ–Ω—à–∏—Ö –≤—ñ–¥–¥—ñ–ª—ñ–≤.**

---

```sql
WITH tasks_with_access AS (
  SELECT t.*
  FROM tasks t
  WHERE
    (
      (:PXX_TAB_MODE = 'PLANNED')
      OR (
        :PXX_TAB_MODE = 'SHIFT'
        AND (
          (t.PLANNING_DATE_START < :PXX_SHIFT_END AND (t.ACTUAL_DATE_END IS NULL OR t.ACTUAL_DATE_END > :PXX_SHIFT_START))
          OR t.PLANNING_DATE_END BETWEEN :PXX_SHIFT_START AND :PXX_SHIFT_END
        )
      )
      OR (
        :PXX_TAB_MODE = 'PROBLEM'
        AND (
          (t.PLANNING_DATE_END < SYSDATE AND t.ACTUAL_DATE_END IS NULL)
          OR EXISTS (
            SELECT 1
            FROM DICT_APP_CONFIRM_LIST d
            WHERE d.PAGE_LIST_ID = t.PAGE_LIST_ID
              AND NOT EXISTS (
                SELECT 1
                FROM SIGNATURERIGHTS r
                WHERE r.TASK_ID = t.ID AND r.STAGES_ID = d.STAGE
              )
          )
        )
      )
      OR (:PXX_TAB_MODE = 'ARCHIVE' AND t.STATUS_ID = 14)
    )
    AND (
      EXISTS (
        SELECT 1
        FROM task_access_control ac
        WHERE 
          (
            ac.access_level = 1 AND (
              ac.user_id = :P0_USER_ID
              OR ac.position_id = :P0_POSITION_ID
            )
          )
          OR (
            ac.access_level = 2 AND (
              (ac.position_id IS NULL OR ac.position_id = :P0_POSITION_ID)
              AND (ac.department_id IS NULL OR ac.department_id = :P0_DEPARTMENT_ID)
              AND (ac.unit_id IS NULL OR ac.unit_id = :P0_UNIT_ID)
            ) AND (ac.user_id IS NULL OR ac.user_id = :P0_USER_ID)
          )
          OR (ac.access_level = 3 AND ac.user_id = :P0_USER_ID)
          AND ac.task_id = t.id
          AND ROWNUM = 1
      )
      OR EXISTS (
        SELECT 1
        FROM signaturerights sr
        WHERE sr.task_id = t.id
          AND sr.user_id = :P0_USER_ID
      )
    )
)
SELECT t.*,
  CASE
    WHEN :PXX_TAB_MODE = 'PROBLEM' THEN
      CASE
        WHEN (t.PLANNING_DATE_END < SYSDATE AND t.ACTUAL_DATE_END IS NULL)
             AND EXISTS (
               SELECT 1
               FROM DICT_APP_CONFIRM_LIST d
               WHERE d.PAGE_LIST_ID = t.PAGE_LIST_ID
                 AND d.PARENT_STAGE_ID IS NOT NULL
                 AND NOT EXISTS (
                   SELECT 1
                   FROM SIGNATURERIGHTS r
                   WHERE r.TASK_ID = t.ID AND r.STAGES_ID = d.ID
                 )
             ) THEN
          '<span class="t-Icon fa fa-clock-o" style="color:red;" title="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"></span> ' ||
          '<span class="t-Icon fa fa-id-card-o" style="color:orange;" title="–û—á—ñ–∫—É—î –ø—ñ–¥–ø–∏—Å—É"></span>'
        WHEN t.PLANNING_DATE_END < SYSDATE AND t.ACTUAL_DATE_END IS NULL THEN
          '<span class="t-Icon fa fa-clock-o" style="color:red;" title="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"></span>'
        WHEN EXISTS (
               SELECT 1
               FROM DICT_APP_CONFIRM_LIST d
               WHERE d.PAGE_LIST_ID = t.PAGE_LIST_ID
                 AND d.PARENT_STAGE_ID IS NOT NULL
                 AND NOT EXISTS (
                   SELECT 1
                   FROM SIGNATURERIGHTS r
                   WHERE r.TASK_ID = t.ID AND r.STAGES_ID = d.ID
                 )
             ) THEN
          '<span class="t-Icon fa fa-id-card-o" style="color:orange;" title="–û—á—ñ–∫—É—î –ø—ñ–¥–ø–∏—Å—É"></span>'
        ELSE NULL
      END
    ELSE NULL
  END AS status_label_problem
FROM tasks_with_access t
```

---

### ‚úÖ –©–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:

* –ó–∞–±–µ–∑–ø–µ—á–µ–Ω–æ, —â–æ –≤—Å—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –¥–æ—Å—Ç—É–ø—É –ø—Ä–∞—Ü—é—é—Ç—å –¥–æ —Ç–æ–≥–æ, —è–∫ –±—É–¥–µ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ `status_label_problem`.
* –ó–∞–ø–∏—Å–∏ –∑ —ñ–Ω—à–∏—Ö –≤—ñ–¥–¥—ñ–ª—ñ–≤ –Ω–µ –∑‚Äô—è–≤–ª—è—Ç—å—Å—è, —è–∫—â–æ –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –≤ `task_access_control` –∞–±–æ `signaturerights`.
* –¢–≤–æ—è –ª–æ–≥—ñ–∫–∞ –≤–∫–ª–∞–¥–∫–∏ `PROBLEM` –∞–∫—É—Ä–∞—Ç–Ω–æ –≤–±—É–¥–æ–≤–∞–Ω–∞, —ñ –Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —ñ–Ω—à—ñ —á–∞—Å—Ç–∏–Ω–∏ –∑–∞–ø–∏—Ç—É.

üîî –Ø–∫—â–æ —Ö–æ—á–µ—à –¥–æ–¥–∞—Ç–∏ —â–µ –ª–æ–≥—ñ–∫—É –≤ `SELECT` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–ª—è `SHIFT` –∞–±–æ `PLANNED`), –∫—Ä–∞—â–µ –≤–∏–Ω–æ—Å–∏—Ç–∏ —Ç–∞–∫–æ–∂ —É CTE –∞–±–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –æ–±–µ—Ä–µ–∂–Ω–æ –≤ —Ç—ñ–ª—ñ `SELECT`, **–Ω–µ –∑–º—ñ–Ω—é—é—á–∏ –ª–æ–≥—ñ–∫—É `FROM`**.

–ì–æ—Ç–æ–≤–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏, —è–∫—â–æ –±—É–¥–µ –ø–æ—Ç—Ä–µ–±–∞ –¥–æ–¥–∞—Ç–∏ —â–µ –∫–æ–ª–æ–Ω–∫–∏/—Å—Ç–∞—Ç—É—Å–∏/—Ñ—ñ–ª—å—Ç—Ä–∏.
