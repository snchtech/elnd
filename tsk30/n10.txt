–¢–∏ –º–æ–∂–µ—à —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –¥–∏–Ω–∞–º—ñ—á–Ω—É –ª–æ–≥—ñ–∫—É –¥–ª—è –≤–∏–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø–æ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—é –≤ SQL-–≤–∏—Ä–∞–∑—ñ —É view –∞–±–æ, —è–∫—â–æ –ø—Ä–æ—Å—Ç—ñ—à–µ ‚Äî —É SQL-–∑–∞–ø–∏—Ç—ñ –≤ APEX, –¥–µ –º–∞—î—à –¥–æ—Å—Ç—É–ø –¥–æ `:P_...` items. –û—Å–∫—ñ–ª—å–∫–∏ –≤ APEX –∫—Ä–∞—â–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ –ª–æ–≥—ñ–∫—É –Ω–∞ —Ä—ñ–≤–Ω—ñ SQL –∑ `CASE` —ñ `:P_ITEM`, –æ—Å—å –ø—Ä–∏–∫–ª–∞–¥, —è–∫ —Ü–µ –º–æ–∂–Ω–∞ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏:

---

### ‚úÖ **–í–∞—Ä—ñ–∞–Ω—Ç SQL-–∑–∞–ø–∏—Ç—É –¥–ª—è APEX, –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –æ–ø–∏—Å–∞–Ω–æ—ó –ª–æ–≥—ñ–∫–∏**

```sql
(
  SELECT 
    CASE 
      -- üîπ –Ø–∫—â–æ P_SUBSTITUTION_MODE = 0
      WHEN :P_SUBSTITUTION_MODE = 0 THEN
        CASE 
          -- –Ø–∫—â–æ P_CUR_SHIFT –ø–æ—Ä–æ–∂–Ω—ñ–π => –≤–∏–≤–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–Ω—é –¥–∞—Ç—É (–Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ shift)
          WHEN NVL(:P_CUR_SHIFT, '0') = '0' THEN
            (
              SELECT 
                (us.FAMILIA || ' ' || substr(us.IMYA, 1, 1) || '. ' || substr(us.OTCHESTVO, 1, 1) || '.') || ', ' ||
                us.SPR_DOLZNOST || ', ' || us.TSEH || 
                ' (' || TO_CHAR(MAX(tv.DATE_VIEWED), 'DD.MM.YYYY HH24:MI') || ')'
              FROM TASK_VIEWED tv
              JOIN USERS us ON tv.USER_ID = us.TAB_NO AND us.PRIZNAK IS NULL
              WHERE tv.TASK_ID = t.ID 
                AND tv.USER_ID = :P_CUR_VIEWED
            )
          -- –Ø–∫—â–æ P_CUR_SHIFT —ñ—Å–Ω—É—î => –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ –º–µ–∂–∞—Ö –ø–æ—Ç–æ—á–Ω–æ—ó –∑–º—ñ–Ω–∏
          ELSE
            (
              SELECT 
                (us.FAMILIA || ' ' || substr(us.IMYA, 1, 1) || '. ' || substr(us.OTCHESTVO, 1, 1) || '.') || ', ' ||
                us.SPR_DOLZNOST || ', ' || us.TSEH || 
                ' (' || TO_CHAR(tv.DATE_VIEWED, 'DD.MM.YYYY HH24:MI') || ')'
              FROM TASK_VIEWED tv
              JOIN USERS us ON tv.USER_ID = us.TAB_NO AND us.PRIZNAK IS NULL
              WHERE tv.TASK_ID = t.ID 
                AND tv.USER_ID = :P_CUR_VIEWED
                AND tv.DATE_VIEWED BETWEEN TO_DATE(:P_START_SHIFT, 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE(:P_END_SHIFT, 'YYYY-MM-DD HH24:MI:SS')
              FETCH FIRST ROW ONLY
            )
        END
      
      -- üîπ –Ø–∫—â–æ P_SUBSTITUTION_MODE = 1
      WHEN :P_SUBSTITUTION_MODE = 1 THEN
        CASE 
          -- –Ø–∫—â–æ P_NEW_SHIFT –ø–æ—Ä–æ–∂–Ω—ñ–π => –≤–∏–≤–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–Ω—é –¥–∞—Ç—É
          WHEN NVL(:P_NEW_SHIFT, '0') = '0' THEN
            (
              SELECT 
                (us.FAMILIA || ' ' || substr(us.IMYA, 1, 1) || '. ' || substr(us.OTCHESTVO, 1, 1) || '.') || ', ' ||
                us.SPR_DOLZNOST || ', ' || us.TSEH || 
                ' (' || TO_CHAR(MAX(tv.DATE_VIEWED), 'DD.MM.YYYY HH24:MI') || ')'
              FROM TASK_VIEWED tv
              JOIN USERS us ON tv.USER_ID = us.TAB_NO AND us.PRIZNAK IS NULL
              WHERE tv.TASK_ID = t.ID 
                AND tv.USER_ID = :P_NEW_VIEWED
            )
          -- –Ø–∫—â–æ —î –∑–º—ñ–Ω–∞ => –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–æ–ø–∞–¥–∞–Ω–Ω—è –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω
          ELSE
            (
              SELECT 
                (us.FAMILIA || ' ' || substr(us.IMYA, 1, 1) || '. ' || substr(us.OTCHESTVO, 1, 1) || '.') || ', ' ||
                us.SPR_DOLZNOST || ', ' || us.TSEH || 
                ' (' || TO_CHAR(tv.DATE_VIEWED, 'DD.MM.YYYY HH24:MI') || ')'
              FROM TASK_VIEWED tv
              JOIN USERS us ON tv.USER_ID = us.TAB_NO AND us.PRIZNAK IS NULL
              WHERE tv.TASK_ID = t.ID 
                AND tv.USER_ID = :P_NEW_VIEWED
                AND tv.DATE_VIEWED BETWEEN TO_DATE(:P_START_SHIFT, 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE(:P_END_SHIFT, 'YYYY-MM-DD HH24:MI:SS')
              FETCH FIRST ROW ONLY
            )
        END
    END
) AS VIEWED_BY
```

---

### üõ† –©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä–∞—Ö—É–≤–∞—Ç–∏:

* `TASK_VIEWED` ‚Äî —Ü–µ —Ç–∞–±–ª–∏—Ü—è –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω—å, —è–∫–∞ –º–∞—î `TASK_ID`, `USER_ID`, `DATE_VIEWED`.
* `t.ID` ‚Äî —Ü–µ alias —Ç–∞–±–ª–∏—Ü—ñ –∑–∞–≤–¥–∞–Ω—å —É –∑–∞–ø–∏—Ç—ñ.
* `:P_CUR_VIEWED`, `:P_NEW_VIEWED` ‚Äî –∑–Ω–∞—á–µ–Ω–Ω—è `USER_ID` –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∞–±–æ –∑–∞–º—ñ—â—É–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
* `:P_CUR_SHIFT`, `:P_NEW_SHIFT` ‚Äî –ø—Ä–∞–ø–æ—Ä—Ü—ñ, —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –¥—ñ–∞–ø–∞–∑–æ–Ω –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è –ø–æ –∑–º—ñ–Ω—ñ.
* `:P_START_SHIFT`, `:P_END_SHIFT` ‚Äî –º–µ–∂—ñ –∑–º—ñ–Ω–∏, —Ñ–æ—Ä–º–∞—Ç `YYYY-MM-DD HH24:MI:SS`.

---

### ‚úÖ –°–ø—Ä–æ—â–µ–Ω–Ω—è (—è–∫—â–æ –≤–∏–≤–æ–¥–∏—Ç–∏ –ª–∏—à–µ `DATE_VIEWED` –∞–±–æ `BOOLEAN`):

–ú–æ–∂–Ω–∞ –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç –ø—ñ–¥ APEX-–ª–æ–≥—ñ–∫—É –Ω–∞ —Ä—ñ–≤–Ω—ñ `interactive report` —ñ –ø–æ—Ç—ñ–º —É –∫–æ–ª–æ–Ω—Ü—ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ JavaScript –∞–±–æ —à–∞–±–ª–æ–Ω (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–µ–ª–µ–Ω–∏–π/—Å—ñ—Ä–∏–π —Å—Ç–∞—Ç—É—Å).

---

üîî –Ø–∫—â–æ —Ö–æ—á–µ—à –≤–∏–Ω–µ—Å—Ç–∏ —Ü—é –ª–æ–≥—ñ–∫—É —É **Oracle View**, —Ç–æ –¥–æ–≤–µ–¥–µ—Ç—å—Å—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —á–µ—Ä–µ–∑ `context` –∞–±–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ `APEX_APPLICATION.G_X01`, `V('APP_USER')`, —Ç–æ—â–æ, —â–æ —Å–∫–ª–∞–¥–Ω—ñ—à–µ. –ù–∞–π–∫—Ä–∞—â–µ ‚Äî –ø–∏—Å–∞—Ç–∏ —Ü–µ–π –≤–∏—Ä–∞–∑ –ø—Ä—è–º–æ —É SQL –¥–∂–µ—Ä–µ–ª—ñ APEX-–∑–≤—ñ—Ç—É.

–•–æ—á–µ—à, —è –ø–æ–∫–∞–∂—É, —è–∫ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ü–µ –≤ PL/SQL-—Ñ—É–Ω–∫—Ü—ñ—ó, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —ó—ó –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω–æ—é –≤ —Ä—ñ–∑–Ω–∏—Ö –∑–∞–ø–∏—Ç–∞—Ö?
