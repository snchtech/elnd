–ß—É–¥–æ–≤–æ! –†–æ–∑–¥—ñ–ª–∏–º–æ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é –Ω–∞ –¥–≤—ñ —á–∞—Å—Ç–∏–Ω–∏:

---

## ‚úÖ 1. **PL/SQL-—Ñ—É–Ω–∫—Ü—ñ—è `can_sign_by_name`**

–§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á **–º–∞—î –ø—Ä–∞–≤–æ –ø—ñ–¥–ø–∏—Å–∞—Ç–∏ "–≤—ñ–¥ —ñ–º–µ–Ω—ñ"**, —ñ –ø–æ–≤–µ—Ä—Ç–∞—î `TRUE/FALSE`.

```sql
CREATE OR REPLACE FUNCTION can_sign_by_name (
    p_signature_user_id     IN NUMBER,  -- SIGNATURERIGHTS.USER_ID
    p_signature_position_id IN NUMBER,  -- SIGNATURERIGHTS.POSITION_ID
    p_signature_department  IN NUMBER,  -- SIGNATURERIGHTS.DEPARTMENT_ID
    p_signature_uchastok    IN VARCHAR2, -- SIGNATURERIGHTS.UCHASTOK
    p_signature_kategoria   IN NUMBER,  -- SIGNATURERIGHTS.KATEGORIA_OTIZ
    p_cur_position_id       IN NUMBER,  -- P0_CURRENT_POSITION_ID –∞–±–æ NEW
    p_cur_department_id     IN NUMBER,  -- P0_CURRENT_DEPARTMENT_ID –∞–±–æ NEW
    p_cur_uchastok          IN VARCHAR2, -- P0_CURRENT_UCHASTOK –∞–±–æ NEW
    p_cur_kategoria         IN NUMBER   -- P0_CURRENT_KATEGORIYA_OTIZ –∞–±–æ NEW
) RETURN BOOLEAN
IS
    v_sign_pos   NUMBER;
    v_sign_dep   NUMBER;
    v_sign_uch   VARCHAR2(100);
    v_sign_kat   NUMBER;
BEGIN
    -- –Ø–∫—â–æ —î USER_ID ‚Üí –≤–∏—Ç—è–≥—É—î–º–æ –ø–æ –Ω—å–æ–º—É
    IF p_signature_user_id IS NOT NULL THEN
        SELECT DOLZNOST, TSEH_ID, UCHASTOK, KATEGORIA_OTIZ
        INTO v_sign_pos, v_sign_dep, v_sign_uch, v_sign_kat
        FROM USERS
        WHERE TAB_NO = p_signature_user_id
          AND PRIZNAK IS NULL;

    -- –Ø–∫—â–æ –Ω–µ–º–∞—î USER_ID ‚Üí –≤–∏—Ç—è–≥—É—î–º–æ –ø–æ position/department/uchastok
    ELSIF p_signature_position_id IS NOT NULL AND p_signature_department IS NOT NULL THEN
        SELECT DOLZNOST, TSEH_ID, UCHASTOK, KATEGORIA_OTIZ
        INTO v_sign_pos, v_sign_dep, v_sign_uch, v_sign_kat
        FROM USERS
        WHERE PRIZNAK IS NULL
          AND DOLZNOST = p_signature_position_id
          AND TSEH_ID = p_signature_department
          AND (p_signature_uchastok IS NULL OR UCHASTOK = p_signature_uchastok)
          AND ROWNUM = 1;

    ELSE
        RETURN FALSE; -- –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö
    END IF;

    -- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–º–æ–≤
    IF v_sign_dep = p_cur_department_id
       AND v_sign_pos = p_cur_position_id
       AND (p_signature_uchastok IS NULL OR v_sign_uch = p_cur_uchastok)
       AND v_sign_kat = 1
       AND APEX_ACL.HAS_USER_ROLE(APEX_APPLICATION.G_FLOW_ID, APEX_CUSTOM_AUTH.GET_USERNAME, 'EXTEND_SIGN') = 'Y'
       AND p_cur_position_id NOT IN (2206, 2246)
    THEN
        RETURN TRUE;
    ELSE
        RETURN FALSE;
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN RETURN FALSE;
    WHEN OTHERS THEN RETURN FALSE;
END can_sign_by_name;
/
```

---

## ‚úÖ 2. **–í—Å—Ç–∞–≤–∫–∞ –≤–∏–∫–ª–∏–∫—É —Ñ—É–Ω–∫—Ü—ñ—ó —É –∫–æ–¥ —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–º—É –º—ñ—Å—Ü—ñ**

–£ —Ç–≤–æ—î–º—É –æ—Å–Ω–æ–≤–Ω–æ–º—É `PL/SQL`-–±–ª–æ—Ü—ñ (—è–∫–∏–π –±—É–¥—É—î –∫–∞—Ä—Ç–∫—É –ø—ñ–¥–ø–∏—Å—É), –∑–Ω–∞–π–¥–∏ –±–ª–æ–∫, –¥–µ `l_count_cb = 0` ‚Äî —Å–∞–º–µ —Ç–∞–º **—Ñ–æ—Ä–º—É—î—Ç—å—Å—è –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Å –Ω–∞ –ø—ñ–¥–ø–∏—Å**, —Ç–æ–±—Ç–æ **—Ç–æ–π, —Ö—Ç–æ –º–∞—î –ø—Ä–∞–≤–æ –∑—Ä–æ–±–∏—Ç–∏ –≤—ñ–¥–º—ñ—Ç–∫—É**.

### –í—Å—Ç–∞–≤ –ø—Ä–∏–∫–ª–∞–¥ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ `l_count_cb = 0`, –∞–ª–µ **–¥–æ `END IF;` —Ü—å–æ–≥–æ –±–ª–æ–∫—É:**

```plsql
IF l_count_cb = 0 THEN
  -- –í–∏–≤—ñ–¥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—ñ–¥–ø–∏—Å–∞–Ω—Ç–∞ (–º–æ–∂–ª–∏–≤–æ, –∫–Ω–æ–ø–∫–∞ –ø—ñ–¥–ø–∏—Å—É)

  IF can_sign_by_name(
      p_signature_user_id     => l_list_tab_no, -- SIGNATURERIGHTS.USER_ID
      p_signature_position_id => l_list_position_id,
      p_signature_department  => l_list_department_id,
      p_signature_uchastok    => l_list_uchastok,
      p_signature_kategoria   => l_list_kategoria_otiz,
      p_cur_position_id       => NVL(:P0_NEW_POSITION_ID, :P0_CURRENT_POSITION_ID),
      p_cur_department_id     => NVL(:P0_NEW_DEPARTMENT_ID, :P0_CURRENT_DEPARTMENT_ID),
      p_cur_uchastok          => NVL(:P0_NEW_UCHASTOK, :P0_CURRENT_UCHASTOK),
      p_cur_kategoria         => NVL(:P0_NEW_KATEGORIYA_OTIZ, :P0_CURRENT_KATEGORIYA_OTIZ)
  ) THEN
    HTP.P('<button class="byname-signature-button" data-signature-id="'|| l_signature_id || '">–í—ñ–¥–º—ñ—Ç–∫–∞ –≤—ñ–¥ —ñ–º–µ–Ω—ñ</button>');
  END IF;
END IF;
```

---

## üîé –ü–æ—è—Å–Ω–µ–Ω–Ω—è:

* –§—É–Ω–∫—Ü—ñ—è `can_sign_by_name(...)` –±–µ—Ä–µ –Ω–∞ –≤—Ö—ñ–¥ –≤—Å—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ `SIGNATURERIGHTS` —ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ (—á–∏ –∑–∞–º—ñ—â–µ–Ω–æ–≥–æ) –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
* –£ –≥–æ–ª–æ–≤–Ω–æ–º—É –∫–æ–¥—ñ –≤–æ–Ω–∞ **–≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —Ç–æ–¥—ñ**, –∫–æ–ª–∏ `l_count_cb = 0` (—Ç–æ–±—Ç–æ **–¥–ª—è –ø–µ—Ä—à–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É –Ω–∞ –ø—ñ–¥–ø–∏—Å**).
* –ö–Ω–æ–ø–∫–∞ **–≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –ª–∏—à–µ —Ç–æ–¥—ñ**, –∫–æ–ª–∏ —É–º–æ–≤–∏ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å (–ø–æ—Å–∞–¥–∞ + —Ü–µ—Ö + —É—á–∞—Å—Ç–æ–∫ \[–∑–∞ –ø–æ—Ç—Ä–µ–±–∏] + –∫–∞—Ç–µ–≥–æ—Ä—ñ—è + —Ä–æ–ª—å + ‚â† —Å–ª—É–∂–±–æ–≤–∏—Ö ID).

---

üîî –Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –º–æ–∂–Ω–∞ —Ç–∞–∫–æ–∂ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ **LOV –¥–ª—è –≤–∏–±–æ—Ä—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**, —è–∫–∏–π –±—É–¥–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ –¥–ª—è –ø—ñ–¥–ø–∏—Å—É "–≤—ñ–¥ —ñ–º–µ–Ω—ñ", –∞–ª–µ —Ü–µ –≤–∂–µ —ñ–Ω—à–∞ —á–∞—Å—Ç–∏–Ω–∞ –ª–æ–≥—ñ–∫–∏.

–•–æ—á–µ—à ‚Äî –ø–æ–∫–∞–∂—É.
