–ß—É–¥–æ–≤–æ! –ù–∏–∂—á–µ ‚Äî –ø–æ–≤–Ω–∏–π –∫–æ–¥ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å —É APEX 22 –Ω–∞ Oracle 12, –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `DRAFT_ID`, `TEMP_ROW_ID`, `PARENT_TEMP_ID`, —ñ –ø–æ–¥–∞–ª—å—à–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è `TASK_ID` —Ç–∞ `PARENT_ID`.

---

## ‚úÖ –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

–£ —Ç–∞–±–ª–∏—Ü—ñ `TASK_SUBTASKS` –º–∞—é—Ç—å –±—É—Ç–∏ —Ç–∞–∫—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–ª—è:

```sql
DRAFT_ID         VARCHAR2(100)
TEMP_ROW_ID      VARCHAR2(100)
PARENT_TEMP_ID   VARCHAR2(100)
```

> –Ø–∫—â–æ —ó—Ö —â–µ –Ω–µ–º–∞ ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏.

---

## üü° –ö—Ä–æ–∫ 1: **–ü—Ä–æ—Ü–µ—Å INSERT –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å**

### üìç APEX Process: `Insert Task Subtasks`
- **Point**: After Submit (–∞–±–æ –∫–æ–ª–∏ –Ω–∞—Ç–∏—Å–∫–∞—î—à "–ó–±–µ—Ä–µ–≥—Ç–∏")
- **Type**: PL/SQL Code

```plsql
DECLARE
  v_task_id NUMBER := :P50_TASK_ID;
  v_draft_id VARCHAR2(100) := :P50_DRAFT_ID;
BEGIN
  -- 1. –í—Å—Ç–∞–≤–∫–∞ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å, TASK_ID –±—É–¥–µ NULL, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è DRAFT_ID
  FOR rec IN (
    SELECT TEMP_ROW_ID,
           PARENT_TEMP_ID,
           SUBTASK_CONTENT,
           STATUS_ID,
           PLANNING_DATE_END,
           SUBTASK_ORDER,
           TEMPLATE_SUBTASK_ID,
           DRAFT_ID
    FROM APEX_COLLECTIONS
    WHERE COLLECTION_NAME = 'TASK_SUBTASKS_TEMP'
  )
  LOOP
    INSERT INTO TASK_SUBTASKS (
      TASK_ID,
      DRAFT_ID,
      TEMP_ROW_ID,
      PARENT_TEMP_ID,
      SUBTASK_CONTENT,
      STATUS_ID,
      PLANNING_DATE_END,
      SUBTASK_ORDER,
      TEMPLATE_SUBTASK_ID
    )
    VALUES (
      NULL,
      rec.DRAFT_ID,
      rec.TEMP_ROW_ID,
      rec.PARENT_TEMP_ID,
      rec.SUBTASK_CONTENT,
      rec.STATUS_ID,
      rec.PLANNING_DATE_END,
      rec.SUBTASK_ORDER,
      rec.TEMPLATE_SUBTASK_ID
    );
  END LOOP;
END;
```

> üëÜ **–ê–±–æ** ‚Äî —è–∫—â–æ —Ç–∏ –∑–±–µ—Ä—ñ–≥–∞—î—à –Ω–∞–ø—Ä—è–º—É –∑ IG (—á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π Data Processing), —Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–π–¥–∏ –¥–æ –∫—Ä–æ–∫—É 2.

---

## üü¢ –ö—Ä–æ–∫ 2: **–û–Ω–æ–≤–ª–µ–Ω–Ω—è `TASK_ID` –ø–æ `DRAFT_ID`**

–¶–µ–π –∫–æ–¥ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–∞–º–æ–≥–æ TASK**:

### APEX Process: `Update TASK_ID in Subtasks`
```plsql
UPDATE TASK_SUBTASKS
SET TASK_ID = :P50_TASK_ID
WHERE DRAFT_ID = :P50_DRAFT_ID;
```

---

## üü¢ –ö—Ä–æ–∫ 3: **–û–Ω–æ–≤–ª–µ–Ω–Ω—è `PARENT_ID` –ø–æ `PARENT_TEMP_ID`**

–¶–µ ‚Äî –æ—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞:

```plsql
MERGE INTO TASK_SUBTASKS dst
USING (
  SELECT s1.ID AS CHILD_ID,
         s2.ID AS REAL_PARENT_ID
  FROM TASK_SUBTASKS s1
  JOIN TASK_SUBTASKS s2
    ON s1.DRAFT_ID = s2.DRAFT_ID
   AND s1.PARENT_TEMP_ID = s2.TEMP_ROW_ID
  WHERE s1.DRAFT_ID = :P50_DRAFT_ID
) mapping
ON (dst.ID = mapping.CHILD_ID)
WHEN MATCHED THEN
  UPDATE SET dst.PARENT_ID = mapping.REAL_PARENT_ID;
```

---

## üîÅ –ü–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤ APEX

–£ `After Submit` –±–ª–æ–∫–∞—Ö –≤–∏–∫–æ–Ω–∞–π –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ:

1. `Insert Task Subtasks` (–Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω, —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à APEX Automatic Row Processing)
2. `Update TASK_ID in Subtasks`
3. `Update PARENT_ID in Subtasks`

---

## ‚ùó –î–æ–¥–∞—Ç–∫–æ–≤–æ: –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—ñ–≤

–ü—ñ—Å–ª—è –≤—Å—å–æ–≥–æ –º–æ–∂–Ω–∞ –æ—á–∏—Å—Ç–∏—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—ñ –ø–æ–ª—è (–æ–ø—Ü—ñ–π–Ω–æ):

```plsql
UPDATE TASK_SUBTASKS
SET TEMP_ROW_ID = NULL,
    PARENT_TEMP_ID = NULL,
    DRAFT_ID = NULL
WHERE TASK_ID = :P50_TASK_ID;
```

---

üîö –í—Å–µ, —Ç–µ–ø–µ—Ä —Ç–∏ –º–æ–∂–µ—à:

- –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è –∑ —ñ—î—Ä–∞—Ä—Ö—ñ—î—é –±–µ–∑ TASK_ID
- –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —ó—Ö —É –ë–î —ñ–∑ –∫–æ—Ä–µ–∫—Ç–Ω–∏–º–∏ –∑–≤'—è–∑–∫–∞–º–∏
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `DRAFT_ID` —è–∫ –æ—Å–Ω–æ–≤–Ω–∏–π —Ç–∏–º—á–∞—Å–æ–≤–∏–π –∫–ª—é—á

üîÅ –Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –º–æ–∂–µ–º–æ –¥–∞–ª—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –∑ IG —á–µ—Ä–µ–∑ APEX collections –∞–±–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ `Interactive Grid Data Source`.