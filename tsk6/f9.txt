–ß—É–¥–æ–≤—ñ –¥–≤–∞ –ø–∏—Ç–∞–Ω–Ω—è ‚Äî –∑–∞—Ä–∞–∑ —É—Å–µ –ø–æ—è—Å–Ω—é –ø–æ —á–µ—Ä–∑—ñ –π –Ω–∞–¥–∞–º –≥–æ—Ç–æ–≤–∏–π –∫–æ–¥.

---

## ‚úÖ **1. SQL-–∫–æ–¥ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–≤ —É —Ç–∞–±–ª–∏—Ü—é `TASK_SUBTASKS`**

```sql
ALTER TABLE TASK_SUBTASKS ADD (
  DRAFT_ID         VARCHAR2(100),
  TEMP_ROW_ID      VARCHAR2(100),
  PARENT_TEMP_ID   VARCHAR2(100)
);
```

> ‚ö†Ô∏è –ü–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—å, —â–æ –≤ —Ç–µ–±–µ –Ω–µ–º–∞—î –≤–∂–µ –ø–æ–ª—ñ–≤ —ñ–∑ —Ç–∞–∫–∏–º–∏ –Ω–∞–∑–≤–∞–º–∏. –Ø–∫—â–æ —î ‚Äî –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ –Ω–∞–∑–≤–∏ (`DRAFT_UUID`, `TMP_ID`, —Ç–æ—â–æ).

---

## ‚úÖ **2. –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ `Interactive Grid` –±–µ–∑ `APEX_COLLECTIONS`**

–¢–∞–∫, **—É —Ç–µ–±–µ –≤–∂–µ –Ω–∞–π–∫—Ä–∞—â–∞ —Å–∏—Ç—É–∞—Ü—ñ—è**, –±–æ:

- –¢–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à **Interactive Grid –∑ —Ç–∏–ø–æ–º –¥–∞–Ω–∏—Ö Table** (`TASK_SUBTASKS`).
- –¢–∏ –º–∞—î—à **–∫–Ω–æ–ø–∫—É Save**, —è–∫–∞ –≤–∏–∫–ª–∏–∫–∞—î `apex.region("subtask_ig").call("getActions").invoke("save")`.

üëâ **–¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ Oracle APEX —Å–∞–º –∑–±–µ—Ä—ñ–≥–∞—î –≤—Å—ñ –∑–º—ñ–Ω–∏** (insert/update/delete) –Ω–∞–ø—Ä—è–º—É –≤ —Ç–∞–±–ª–∏—Ü—é `TASK_SUBTASKS`, —Ç–æ–±—Ç–æ —Ç–æ–±—ñ **–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞ APEX_COLLECTION** –≤–∑–∞–≥–∞–ª—ñ.

---

## üß© –Ø–∫ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –∑ `DRAFT_ID` —ñ `TEMP_ROW_ID` –≤ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É?

### ‚úÖ –ù–∞ –∫–ª—ñ—î–Ω—Ç—ñ (JavaScript):
–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞ –≤ IG:
- —Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—à:

```javascript
model.setValue(newRec, "DRAFT_ID", $v("P50_DRAFT_ID"));
model.setValue(newRec, "TEMP_ROW_ID", "temp_" + new Date().getTime());
```

> –¢–∞–∫–∏–º —á–∏–Ω–æ–º APEX –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —ó—Ö —É —Ç–∞–±–ª–∏—Ü—é –ø—Ä–∏ `Save`.

---

## üõ†Ô∏è –©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –≤—Ä—É—á–Ω—É –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ?

### ‚úÖ APEX Process 1: –ü—Ä–∏—Å–≤–æ—ó—Ç–∏ TASK_ID

```plsql
UPDATE TASK_SUBTASKS
SET TASK_ID = :P50_TASK_ID
WHERE DRAFT_ID = :P50_DRAFT_ID
  AND TASK_ID IS NULL;
```

> –¶–µ –æ–Ω–æ–≤–ª—é—î –≤—Å—ñ "—á–µ—Ä–Ω–µ—Ç–∫–æ–≤—ñ" –∑–∞–ø–∏—Å–∏ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ —Ç–∏ —Å—Ç–≤–æ—Ä–∏–≤ —Å–∞–º–µ –∑–∞–≤–¥–∞–Ω–Ω—è (`TASK`).

---

### ‚úÖ APEX Process 2: –ü—Ä–∏—Å–≤–æ—ó—Ç–∏ PARENT_ID

```plsql
MERGE INTO TASK_SUBTASKS dst
USING (
  SELECT s1.ID AS CHILD_ID,
         s2.ID AS REAL_PARENT_ID
  FROM TASK_SUBTASKS s1
  JOIN TASK_SUBTASKS s2
    ON s1.DRAFT_ID = s2.DRAFT_ID
   AND s1.PARENT_TEMP_ID = s2.TEMP_ROW_ID
  WHERE s1.DRAFT_ID = :P50_DRAFT_ID
) mapping
ON (dst.ID = mapping.CHILD_ID)
WHEN MATCHED THEN
  UPDATE SET dst.PARENT_ID = mapping.REAL_PARENT_ID;
```

---

## üì¶ –ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å:

1. ‚ùó **–£ —Ñ–æ—Ä–º—ñ –∑–∞–≤–¥–∞–Ω–Ω—è:** –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è `:P50_DRAFT_ID` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `sys_guid()` –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏).
2. üì• IG —Å—Ç–≤–æ—Ä—é—î –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è –∑ `DRAFT_ID` + `TEMP_ROW_ID`.
3. üíæ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î `–ó–±–µ—Ä–µ–≥—Ç–∏` ‚Üí IG –∑–±–µ—Ä—ñ–≥–∞—î –≤—Å–µ –Ω–∞–ø—Ä—è–º—É –≤ `TASK_SUBTASKS`.
4. üõ†Ô∏è –ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è `TASK`, –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è:
   - `UPDATE TASK_ID` –ø–æ `DRAFT_ID`
   - `UPDATE PARENT_ID` –ø–æ `TEMP_ROW_ID ‚Üí ID`

---

üîÅ –Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –º–æ–∂–µ–º–æ:
- –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ `DRAFT_ID` –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏,
- –æ—á–∏—Å—Ç–∏—Ç–∏ —Ü—ñ –ø–æ–ª—è –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.

–ù–∞–ø–∏—à–∏, —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äî —ñ –ø—Ä–æ–¥–æ–≤–∂–∏–º–æ.