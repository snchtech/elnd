–¢–∏ –¥—É–∂–µ —á—ñ—Ç–∫–æ —Ä–æ–∑–∫–ª–∞–≤ –ª–æ–≥—ñ–∫—É –ø–æ –∫—Ä–æ–∫–∞—Ö ‚Äî —Ü–µ –≤–∂–µ –º–∞–π–∂–µ –≥–æ—Ç–æ–≤–∏–π –¥–∏–∑–∞–π–Ω —à–∞–±–ª–æ–Ω—É, —è–∫–∏–π –º–æ–∂–Ω–∞ **–Ω–∞–¥—ñ–π–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤ APEX**, —ñ —Ç–≤—ñ–π **–≥–æ–ª–æ–≤–Ω–∏–π —Ñ–æ–∫—É—Å ‚Äî –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –∑–∞–º—ñ–Ω—ñ `TEMP_ROW_ID` ‚Üí `ID` —Ç–∞ `DRAFT_ID` ‚Üí `TASK_ID`**, —â–æ–±–∏ —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–ª—É—Ç–∞–Ω–∏–Ω–∏.

–î–∞–≤–∞–π –ø–æ –∫—Ä–æ–∫–∞—Ö —Ä–æ–∑–ø–∏—à–µ–º–æ **—è–∫ –∑—Ä–æ–±–∏—Ç–∏ —Ü–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–∞ –±–µ–∑–ø–µ—á–Ω–æ**, –æ—Å–æ–±–ª–∏–≤–æ –¥–ª—è –ø—É–Ω–∫—Ç—É 4 —ñ 5.

---

## ‚úÖ –ö–æ—Ä–æ—Ç–∫–æ –ª–æ–≥—ñ–∫–∞:

| –ö—Ä–æ–∫ | –î—ñ—è                                      | –ü–æ–ª—è –≤ –≥—Ä—ñ                              |
|------|-------------------------------------------|------------------------------------------|
| 1    | –î–æ–¥–∞—î—à –∑–∞–ø–∏—Å –≤ IG                         | `TEMP_ROW_ID`, `DRAFT_ID`               |
| 2    | –ó–∞–ø–æ–≤–Ω—é—î—à `SUBTASK_CONTENT`, `PLANNING_DATE_END`, —Ç–æ—â–æ |
| 3    | –¢–∏—Å–Ω–µ—à `Save` IG                          | APEX DML —Å—Ç–≤–æ—Ä—é—î –∑–∞–ø–∏—Å —É –ë–î ‚Üí –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è `ID` |
| 4    | –ú–∞—î—à `ID` + `TEMP_ROW_ID`                | —Ç—Ä–µ–±–∞ –æ–Ω–æ–≤–∏—Ç–∏ `PARENT_ID` —á–µ—Ä–µ–∑ `TEMP_PARENT_ID` |
| 5    | –ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ "–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è"       | `DRAFT_ID` ‚Üí `TASK_ID`; `TEMP_ROW_ID` ‚Üí `ID`, `PARENT_ID` –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è |

---

## üî∂ –ü—Ä–æ–±–ª–µ–º–∞ –≤ –ø—É–Ω–∫—Ç—ñ 4:

> –ü—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è IG:
- `SUBTASK` –≤–∂–µ –º–∞—î —Å–ø—Ä–∞–≤–∂–Ω—ñ–π `ID`
- –ê–ª–µ `TEMP_ROW_ID` —â–µ –Ω–µ –æ—á–∏—â–µ–Ω–∏–π
- `PARENT_ID` —â–µ –Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–æ ‚Äî –º–∏ –º–∞—î–º–æ `PARENT_TEMP_ID`, —è–∫–∏–π –ø–æ—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ `TEMP_ROW_ID`

üëâ –¢–æ–±—Ç–æ —Ç–µ–ø–µ—Ä –ø–æ—Ç—Ä—ñ–±–Ω–æ **–∑–Ω–∞–π—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏**, —É —è–∫–∏—Ö `PARENT_TEMP_ID = TEMP_ROW_ID —ñ–Ω—à–æ–≥–æ –∑–∞–ø–∏—Å—É`, —ñ –∑–∞–º—ñ–Ω–∏—Ç–∏ `PARENT_ID = ID —Ç–æ–≥–æ –∑–∞–ø–∏—Å—É`.

---

## ‚úÖ üîß –Ø–∫ –æ–Ω–æ–≤–∏—Ç–∏ `PARENT_ID` –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è `ID`

### üîπ PL/SQL Process (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `Update PARENT_ID`)

```plsql
MERGE INTO TASK_SUBTASKS t
USING (
  SELECT
    child.ID AS CHILD_ID,
    parent.ID AS TRUE_PARENT_ID
  FROM
    TASK_SUBTASKS child
    JOIN TASK_SUBTASKS parent
      ON child.PARENT_TEMP_ID = parent.TEMP_ROW_ID
     AND child.DRAFT_ID = parent.DRAFT_ID
  WHERE
    child.DRAFT_ID = :P50_DRAFT_ID
) mapping
ON (t.ID = mapping.CHILD_ID)
WHEN MATCHED THEN
  UPDATE SET t.PARENT_ID = mapping.TRUE_PARENT_ID;
```

---

## ‚úÖ üîß –Ø–∫ –æ–Ω–æ–≤–∏—Ç–∏ `TASK_ID` —É –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è—Ö

```plsql
UPDATE TASK_SUBTASKS
SET TASK_ID = :P50_TASK_ID
WHERE DRAFT_ID = :P50_DRAFT_ID
  AND TASK_ID IS NULL;
```

---

## ‚úÖ üîß –Ø–∫ –æ—á–∏—Å—Ç–∏—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—ñ –ø–æ–ª—è

```plsql
UPDATE TASK_SUBTASKS
SET 
  DRAFT_ID = NULL,
  TEMP_ROW_ID = NULL,
  PARENT_TEMP_ID = NULL
WHERE TASK_ID = :P50_TASK_ID;
```

---

## ‚úÖ –ü–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—ñ–≤ —É `After Submit`:

1. `Insert into TASKS` ‚Üí –∑–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è `:P50_TASK_ID`
2. `UPDATE TASK_ID` —É `TASK_SUBTASKS`
3. `UPDATE PARENT_ID` —á–µ—Ä–µ–∑ `TEMP_PARENT_ID` ‚Üí `ID`
4. `CLEAR TEMP ROWS` (TEMP_ROW_ID / DRAFT_ID)

---

## üß† –©–æ —â–µ –≤–∞–∂–ª–∏–≤–æ:

- `TEMP_ROW_ID` –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è JS ‚Äî –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –¥–æ–¥–∞–≤–∞–π `SUBTASK_CONTENT` –∞–±–æ —ñ–Ω—à–µ –ø–æ–ª–µ, —â–æ–±–∏ –∑–∞–ø–∏—Å –±—É–≤ ‚Äúdirty‚Äù —ñ –∑–±–µ—Ä—ñ–≥—Å—è –≤ –ë–î.
- –ü—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ‚Äî `TEMP_ROW_ID` **—â–µ –∂–∏–≤–µ –≤ IG**, –∞–ª–µ –≤–∂–µ –Ω–µ –º–∞—î —Å–µ–Ω—Å—É –≤ –ë–î ‚Üí –π–æ–≥–æ —Ç—Ä–µ–±–∞ –æ—á–∏—Å—Ç–∏—Ç–∏.

---

## üîÅ –•–æ—á–µ—à ‚Äî —è –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏:
- –∑—Ä–æ–±–∏—Ç–∏ —Ü—ñ —Ç—Ä–∏ –ø—Ä–æ—Ü–µ—Å–∏ —è–∫ –æ–∫—Ä–µ–º—ñ `APEX Server Processes`
- –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ `SUBTASK_ORDER`
- –∑—Ä–æ–±–∏—Ç–∏ fallback, —è–∫—â–æ `PARENT_TEMP_ID` –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ

–ì–æ—Ç–æ–≤–∏–π —Ü–µ –∑—Ä–æ–±–∏—Ç–∏?