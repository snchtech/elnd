–¢–∞–∫, –∑–∞—Ä–∞–∑ –ø–æ–∫–∞–∂—É **–¥–≤–∞ –ø—Ä–∏–∫–ª–∞–¥–∏ SQL (PL/SQL) –∫–æ–¥—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å (`subtasks`)**, –∫–æ–ª–∏:

1. üîπ **`INSERT`** ‚Äî –ø—ñ–¥ —á–∞—Å `CREATE_TASK` / `UPDATE_TASK` (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è `TASK_ID` –∞–±–æ `TEMPLATE_ID`)
2. üîπ **`SAVE_ALL`** ‚Äî –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ–∫—Ä–µ–º–æ –Ω–∞—Ç–∏—Å–∫–∞—î –∫–Ω–æ–ø–∫—É `"–ó–±–µ—Ä–µ–≥—Ç–∏ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è"`

---

## üü¢ üì• 1. `INSERT` –∞–±–æ `UPDATE` (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è / —à–∞–±–ª–æ–Ω—É)

> –¶–µ–π –ø—Ä–æ—Ü–µ—Å –Ω–µ –≤—Å—Ç–∞–≤–ª—è—î –Ω–æ–≤—ñ –∑–∞–ø–∏—Å–∏, –±–æ IG –∑–±–µ—Ä—ñ–≥–∞—î —ó—Ö —Å–∞–º, –∞–ª–µ **–ø—Ä–∏–≤'—è–∑—É—î `TASK_ID` –∞–±–æ `TEMPLATE_ID` –¥–æ –∑–∞–ø–∏—Å—ñ–≤ –∑ `DRAFT_ID`**, —è–∫—ñ —Ä–∞–Ω—ñ—à–µ –±—É–ª–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ –±–µ–∑ –∑–≤'—è–∑–∫—É.

---

### ‚úÖ –í–∏–ø–∞–¥–æ–∫: **TASK (–ó–∞–≤–¥–∞–Ω–Ω—è)**

```plsql
UPDATE TASK_SUBTASKS
SET TASK_ID = :P50_TASK_ID
WHERE DRAFT_ID = :P50_DRAFT_ID
  AND TASK_ID IS NULL;
```

---

### ‚úÖ –í–∏–ø–∞–¥–æ–∫: **TEMPLATE (–®–∞–±–ª–æ–Ω)**

```plsql
UPDATE TASK_TEMPLATE_SUBTASKS
SET TEMPLATE_ID = :P50_TASK_ID
WHERE DRAFT_ID = :P50_DRAFT_ID
  AND TEMPLATE_ID IS NULL;
```

---

## üü† üíæ 2. –ü—Ä–æ—Ü–µ—Å `SAVE_ALL`: —Ä—É—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å (–Ω–∞ –≤–∏–º–æ–≥—É)

> –¢—É—Ç –æ—Å–Ω–æ–≤–Ω–∞ –º–µ—Ç–∞ ‚Äî **–æ–Ω–æ–≤–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—ñ –Ω–µ –±—É–ª–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –≤—Ä—É—á–Ω—É**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:
- `CREATOR_ID`
- `STATUS_ID` –ø–æ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—é
- –æ—á–∏—â–µ–Ω–Ω—è `DRAFT_ID`, `TEMP_ROW_ID` –ø—ñ—Å–ª—è –≤—Å—Ç–∞–≤–∫–∏
- –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è `SUBTASK_ORDER` –∑–∞ –ø–æ—Ä—è–¥–∫–æ–º

---

### ‚úÖ TASK_SUBTASKS (–¥–ª—è `P50_IS_TEMPLATE = 'N'`)

```plsql
BEGIN
  FOR rec IN (
    SELECT ID
    FROM TASK_SUBTASKS
    WHERE TASK_ID = :P50_TASK_ID
      AND DRAFT_ID = :P50_DRAFT_ID
  )
  LOOP
    UPDATE TASK_SUBTASKS
    SET 
      CREATOR_ID = :G_USER_ID,
      STATUS_ID = NVL(STATUS_ID, 1),
      DRAFT_ID = NULL,
      TEMP_ROW_ID = NULL,
      PARENT_TEMP_ID = NULL
    WHERE ID = rec.ID;
  END LOOP;

  -- –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ä—è–¥–∫—É
  UPDATE TASK_SUBTASKS t
  SET SUBTASK_ORDER = (
    SELECT ROWNUM
    FROM (
      SELECT ID
      FROM TASK_SUBTASKS
      WHERE TASK_ID = :P50_TASK_ID
      ORDER BY PLANNING_DATE_END NULLS LAST, ID
    )
    WHERE ID = t.ID
  )
  WHERE t.TASK_ID = :P50_TASK_ID;
END;
```

---

### ‚úÖ TASK_TEMPLATE_SUBTASKS (–¥–ª—è `P50_IS_TEMPLATE = 'Y'`)

```plsql
BEGIN
  FOR rec IN (
    SELECT ID
    FROM TASK_TEMPLATE_SUBTASKS
    WHERE TEMPLATE_ID = :P50_TASK_ID
      AND DRAFT_ID = :P50_DRAFT_ID
  )
  LOOP
    UPDATE TASK_TEMPLATE_SUBTASKS
    SET 
      CREATOR_ID = :G_USER_ID,
      STATUS_ID = NVL(STATUS_ID, 1),
      DRAFT_ID = NULL,
      TEMP_ROW_ID = NULL,
      PARENT_TEMP_ID = NULL
    WHERE ID = rec.ID;
  END LOOP;

  -- –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ä—è–¥–∫—É
  UPDATE TASK_TEMPLATE_SUBTASKS t
  SET SUBTASK_ORDER = (
    SELECT ROWNUM
    FROM (
      SELECT ID
      FROM TASK_TEMPLATE_SUBTASKS
      WHERE TEMPLATE_ID = :P50_TASK_ID
      ORDER BY PLANNING_DATE_END NULLS LAST, ID
    )
    WHERE ID = t.ID
  )
  WHERE t.TEMPLATE_ID = :P50_TASK_ID;
END;
```

---

## üß© –ö–æ–ª–∏ —Ü—ñ –ø—Ä–æ—Ü–µ—Å–∏ –≤–∏–∫–ª–∏–∫–∞—é—Ç—å—Å—è:

| –ü—Ä–æ—Ü–µ—Å                          | –£–º–æ–≤–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è                          |
|----------------------------------|------------------------------------------|
| `UPDATE TASK_ID in SUBTASKS`    | `:REQUEST IN ('CREATE_TASK', 'UPDATE_TASK') AND :P50_IS_TEMPLATE = 'N'` |
| `UPDATE TEMPLATE_ID in SUBTASKS`| `:REQUEST IN ('CREATE_TASK', 'UPDATE_TASK') AND :P50_IS_TEMPLATE = 'Y'` |
| `SAVE_ALL` –¥–ª—è –∑–∞–≤–¥–∞–Ω–Ω—è         | `:REQUEST = 'SAVE_ALL' AND :P50_IS_TEMPLATE = 'N'` |
| `SAVE_ALL` –¥–ª—è —à–∞–±–ª–æ–Ω—É          | `:REQUEST = 'SAVE_ALL' AND :P50_IS_TEMPLATE = 'Y'` |

---

üîÅ –•–æ—á–µ—à ‚Äî —è –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ —â–µ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏ —É `SAVE_ALL`, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:
- —á–∏ –≤—Å—ñ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ
- —á–∏ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ —Å–µ–±–µ —è–∫ `PARENT_ID`
- —á–∏ –Ω–µ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å

–ì–æ—Ç–æ–≤–∏–π?