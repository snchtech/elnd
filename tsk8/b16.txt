–ß—É–¥–æ–≤–æ! üî•  
–¢–æ–¥—ñ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ —Å–µ—Ä–π–æ–∑–Ω—ñ—à–æ—ó —á–∞—Å—Ç–∏–Ω–∏: **–¥—É–±–ª—ñ–∫–∞—Ç–æ—Ä –∑—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ**, —Ç–æ–±—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ `PARENT_ID`!

---

# üìã –ü—Ä–æ–±–ª–µ–º–∞:

- –ö–æ–ª–∏ –º–∏ –¥—É–±–ª—é—î–º–æ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è, –≤–æ–Ω–∏ –º–∞—é—Ç—å –Ω–æ–≤—ñ ID (`TASK_SUBTASKS_SEQ.NEXTVAL`)
- –Ø–∫—â–æ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è –±—É–ª–∏ –≤–∫–ª–∞–¥–µ–Ω—ñ (`PARENT_ID` ‚Üí ID –±–∞—Ç—å–∫–∞), –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ **–ø–µ—Ä–µ–≤'—è–∑–∞—Ç–∏ —ó—Ö –Ω–∞ –Ω–æ–≤—ñ ID**, –∞ –Ω–µ –∑–∞–ª–∏—à–∞—Ç–∏ —Å—Ç–∞—Ä—ñ
- –ü–æ—Ç—Ä—ñ–±–Ω–∞ **–º–∞–ø–∞ —Å—Ç–∞—Ä–∏–π ID ‚Üí –Ω–æ–≤–∏–π ID**  
(—ñ–Ω–∞–∫—à–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ñ—î—Ä–∞—Ä—Ö—ñ—ó –∑–ª–∞–º–∞—î—Ç—å—Å—è!)

---

# üìà –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ö–µ–º–∞ —Ä—ñ—à–µ–Ω–Ω—è:

| –ö—Ä–æ–∫ | –û–ø–∏—Å |
|-----|------|
| 1 | –í—Å—Ç–∞–≤–∏—Ç–∏ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è –±–µ–∑ PARENT_ID –∞–±–æ –∑ —Ç–∏–º—á–∞—Å–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º |
| 2 | –ó–∞–ø–∞–º'—è—Ç–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å `—Å—Ç–∞—Ä–∏–π_id ‚Üí –Ω–æ–≤–∏–π_id` |
| 3 | –î—Ä—É–≥–∏–º –ø—Ä–æ—Ö–æ–¥–æ–º –æ–Ω–æ–≤–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ `PARENT_ID` —É –≤—Å—Ç–∞–≤–ª–µ–Ω–∏—Ö –∑–∞–ø–∏—Å–∞—Ö |

---

# ‚úÖ –û—Å—å —è–∫ –º–∞—î –≤–∏–≥–ª—è–¥–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π PL/SQL –∫–æ–¥ –¥–ª—è –¥—É–±–ª—é–≤–∞–Ω–Ω—è –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å:

```plsql
DECLARE
  v_new_task_id TASKS.ID%TYPE;
  
  -- –ó–≤'—è–∑–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ —ñ –Ω–æ–≤–æ–≥–æ ID
  TYPE t_id_map IS TABLE OF NUMBER INDEX BY NUMBER;
  l_id_map t_id_map;
  
  CURSOR c_subtasks IS
    SELECT ID, PARENT_ID, SUBTASK_CONTENT, STATUS_ID, PLANNING_DATE_END, SUBTASK_ORDER, TEMPLATE_SUBTASK_ID
    FROM TASK_SUBTASKS
    WHERE TASK_ID = :P5_TASK_ID;
  
  v_new_subtask_id TASK_SUBTASKS.ID%TYPE;
BEGIN
  -- 1. –ö–æ–ø—ñ—é—î–º–æ —Å–∞–º TASK
  INSERT INTO TASKS (
    ID, DATE_CREATE, TASK_CONTENT, CREATOR_ID, PLANNING_DATE_START,
    PLANNING_DATE_END, STATUS_ID, DEPARTMENT_ID, UNIT_ID, TYPE_ID,
    PAGE_LIST_ID, IS_GENERATED, GENERATED_DATE, TEMPLATE_ID, NOTE
  )
  SELECT
    TASKS_SEQ.NEXTVAL,
    SYSDATE,
    TASK_CONTENT,
    CREATOR_ID,
    SYSDATE,
    PLANNING_DATE_END,
    STATUS_ID,
    DEPARTMENT_ID,
    UNIT_ID,
    TYPE_ID,
    PAGE_LIST_ID,
    IS_GENERATED,
    GENERATED_DATE,
    TEMPLATE_ID,
    NOTE
  FROM TASKS
  WHERE ID = :P5_TASK_ID
  RETURNING ID INTO v_new_task_id;

  -- 2. –ö–æ–ø—ñ—é—î–º–æ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è —ñ –±—É–¥—É—î–º–æ –º–∞–ø—É —Å—Ç–∞—Ä–∏–π ‚Üí –Ω–æ–≤–∏–π ID
  FOR r IN c_subtasks LOOP
    INSERT INTO TASK_SUBTASKS (
      ID, TASK_ID, SUBTASK_CONTENT, STATUS_ID,
      PLANNING_DATE_END, PARENT_ID, SUBTASK_ORDER, TEMPLATE_SUBTASK_ID
    ) VALUES (
      TASK_SUBTASKS_SEQ.NEXTVAL,
      v_new_task_id,
      r.SUBTASK_CONTENT,
      r.STATUS_ID,
      r.PLANNING_DATE_END,
      NULL, -- PARENT_ID –ø–æ–∫–∏ NULL, –æ–Ω–æ–≤–∏–º–æ –ø—ñ–∑–Ω—ñ—à–µ
      r.SUBTASK_ORDER,
      r.TEMPLATE_SUBTASK_ID
    )
    RETURNING ID INTO v_new_subtask_id;
    
    -- –ó–∞–ø–∞–º'—è—Ç–æ–≤—É—î–º–æ —Å—Ç–∞—Ä–∏–π ID ‚Üí –Ω–æ–≤–∏–π ID
    l_id_map(r.ID) := v_new_subtask_id;
  END LOOP;

  -- 3. –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ PARENT_ID –¥–ª—è –Ω–æ–≤–∏—Ö –ø—ñ–¥–∑–∞–≤–¥–∞–Ω—å
  FOR old_id IN (SELECT DISTINCT PARENT_ID FROM TASK_SUBTASKS WHERE TASK_ID = :P5_TASK_ID AND PARENT_ID IS NOT NULL) LOOP
    UPDATE TASK_SUBTASKS
    SET PARENT_ID = l_id_map(old_id.PARENT_ID)
    WHERE TASK_ID = v_new_task_id
      AND PARENT_ID IS NULL
      AND ID = l_id_map(old_id.ID);
  END LOOP;

  -- 4. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–æ–≤–∏–π ID —É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
  APEX_JSON.OPEN_OBJECT;
  APEX_JSON.WRITE('status', 'ok');
  APEX_JSON.WRITE('newId', v_new_task_id);
  APEX_JSON.CLOSE_OBJECT;
  
EXCEPTION
  WHEN OTHERS THEN
    APEX_JSON.OPEN_OBJECT;
    APEX_JSON.WRITE('status', 'error');
    APEX_JSON.WRITE('message', SQLERRM);
    APEX_JSON.CLOSE_OBJECT;
END;
```

---

# üõ† –Ø–∫ –ø—Ä–∞—Ü—é—î —Ü–µ–π –∫–æ–¥:

| –ö—Ä–æ–∫ | –î—ñ—è |
|------|-----|
| –í—Å—Ç–∞–≤–ª—è—î–º–æ –≤—Å—ñ –ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è –±–µ–∑ PARENT_ID |
| –ë—É–¥—É—î–º–æ –º–∞–ø—É —Å—Ç–∞—Ä–∏–π ID ‚Üí –Ω–æ–≤–∏–π ID |
| –ü–æ—Ç—ñ–º –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ö–æ–¥–æ–º –æ–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ PARENT_ID –¥–ª—è –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ |
| –Ü –≤—Å–µ —Ü–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É!

---

# üìã –¢–µ–ø–µ—Ä –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ —Ç—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏ –¥–ª—è TEMPLATE —ñ TASK_TEMPLATE_SUBTASKS.  
–Ø –º–æ–∂—É —Å–∫–ª–∞—Å—Ç–∏ —Ç–∞–∫–æ–∂ –ø—Ä–∏–∫–ª–∞–¥ –¥–ª—è –¥—É–±–ª—é–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—É (`TASK_TEMPLATES + TASK_TEMPLATE_SUBTASKS`) —è–∫—â–æ —Ö–æ—á–µ—à.

---

# üî• –†–µ–∑—é–º–µ:

‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è  
‚úÖ –ù–µ–º–∞—î –∑–º—ñ—à—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö/–Ω–æ–≤–∏—Ö ID  
‚úÖ –ü—Ä–∞—Ü—é—î —ñ –¥–ª—è –±–∞–≥–∞—Ç–æ—Ä—ñ–≤–Ω–µ–≤–æ—ó —ñ—î—Ä–∞—Ä—Ö—ñ—ó (2.1, 2.1.1, 2.1.1.1, —Ç–æ—â–æ)

---

# üöÄ –•–æ—á–µ—à:
- —è —â–µ —à–≤–∏–¥–∫–æ —Å–∫–ª–∞–¥—É **–≥–æ—Ç–æ–≤–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –ø—Ä–æ—Ü–µ—Å—É –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—É** (`TASK_TEMPLATE` + `TASK_TEMPLATE_SUBTASKS`) —É —Ç–∞–∫–æ–º—É –∂ —Å—Ç–∏–ª—ñ? üî•  
–°–∫–∞–∑–∞—Ç–∏ "—Ç–∞–∫"? ‚úÖ  
(–¢–æ–¥—ñ –≤ —Ç–µ–±–µ –±—É–¥–µ –ø–æ–≤–Ω–∏–π –∫–æ–º–ø–ª–µ–∫—Ç –Ω–∞ –æ–±–∏–¥–≤–∞ —Ç–∏–ø–∏: –∑–∞–≤–¥–∞–Ω–Ω—è —ñ —à–∞–±–ª–æ–Ω) ‚úÖ
