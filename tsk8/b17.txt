–ß—É–¥–æ–≤–æ! üî•  
–¢–æ–¥—ñ —è –∑–∞—Ä–∞–∑ —Å–∫–ª–∞–¥—É **–≥–æ—Ç–æ–≤–∏–π –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∏–π PL/SQL –ø—Ä–æ—Ü–µ—Å –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –®–ê–ë–õ–û–ù–£** (`TASK_TEMPLATES` + `TASK_TEMPLATE_SUBTASKS`), –ø—Ä–∏—á–æ–º—É:

- –ü–æ–≤–Ω—ñ—Å—Ç—é –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∫–ª–∞–¥–µ–Ω–∏—Ö –ø—ñ–¥—à–∞–±–ª–æ–Ω—ñ–≤ (`PARENT_ID` –±—É–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –ù–æ–≤–∏–π TEMPLATE_ID
- –ù–æ–≤–∞ –¥–∞—Ç–∞ `DATE_CREATE = SYSDATE`

---

# üìã –û—Å—å –ø–æ–≤–Ω–∏–π –≥–æ—Ç–æ–≤–∏–π –∫–æ–¥ –¥–ª—è –¥—É–±–ª—é–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—É:

```plsql
DECLARE
  v_new_template_id TASK_TEMPLATES.ID%TYPE;
  
  -- –ó–≤'—è–∑–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ —ñ –Ω–æ–≤–æ–≥–æ ID
  TYPE t_id_map IS TABLE OF NUMBER INDEX BY NUMBER;
  l_id_map t_id_map;
  
  CURSOR c_subtasks IS
    SELECT ID, PARENT_ID, SUBTASK_CONTENT, STATUS_ID, SUBTASK_ORDER
    FROM TASK_TEMPLATE_SUBTASKS
    WHERE TEMPLATE_ID = :P5_TASK_ID;
  
  v_new_subtask_id TASK_TEMPLATE_SUBTASKS.ID%TYPE;
BEGIN
  -- 1. –ö–æ–ø—ñ—é—î–º–æ —Å–∞–º TEMPLATE
  INSERT INTO TASK_TEMPLATES (
    ID, DATE_CREATE, TASK_CONTENT, CREATOR_ID, STATUS_ID,
    DEPARTMENT_ID, UNIT_ID, TYPE_ID, PAGE_LIST_ID,
    PERIOD_MODE, PERIOD_INTERVAL, PERIOD_TIME,
    HOURLY_TIMES, NEXT_RUN_DATE, DATE_END
  )
  SELECT
    TASK_TEMPLATE_SEQ.NEXTVAL,
    SYSDATE,
    TASK_CONTENT,
    CREATOR_ID,
    STATUS_ID,
    DEPARTMENT_ID,
    UNIT_ID,
    TYPE_ID,
    PAGE_LIST_ID,
    PERIOD_MODE,
    PERIOD_INTERVAL,
    PERIOD_TIME,
    HOURLY_TIMES,
    NEXT_RUN_DATE,
    DATE_END
  FROM TASK_TEMPLATES
  WHERE ID = :P5_TASK_ID
  RETURNING ID INTO v_new_template_id;

  -- 2. –ö–æ–ø—ñ—é—î–º–æ –ø—ñ–¥—à–∞–±–ª–æ–Ω–∏ —ñ –±—É–¥—É—î–º–æ –º–∞–ø—É —Å—Ç–∞—Ä–∏–π ‚Üí –Ω–æ–≤–∏–π ID
  FOR r IN c_subtasks LOOP
    INSERT INTO TASK_TEMPLATE_SUBTASKS (
      ID, TEMPLATE_ID, SUBTASK_CONTENT, STATUS_ID,
      PARENT_ID, SUBTASK_ORDER
    ) VALUES (
      TASK_TEMPLATE_SUBTASKS_SEQ.NEXTVAL,
      v_new_template_id,
      r.SUBTASK_CONTENT,
      r.STATUS_ID,
      NULL, -- —Ç–∏–º—á–∞—Å–æ–≤–æ –±–µ–∑ parent_id
      r.SUBTASK_ORDER
    )
    RETURNING ID INTO v_new_subtask_id;
    
    -- –ó–∞–ø–∞–º'—è—Ç–æ–≤—É—î–º–æ —Å—Ç–∞—Ä–∏–π ID ‚Üí –Ω–æ–≤–∏–π ID
    l_id_map(r.ID) := v_new_subtask_id;
  END LOOP;

  -- 3. –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ PARENT_ID –¥–ª—è –Ω–æ–≤–∏—Ö –ø—ñ–¥—à–∞–±–ª–æ–Ω—ñ–≤
  FOR old_id IN (
    SELECT DISTINCT ID, PARENT_ID
    FROM TASK_TEMPLATE_SUBTASKS
    WHERE TEMPLATE_ID = :P5_TASK_ID
      AND PARENT_ID IS NOT NULL
  ) LOOP
    UPDATE TASK_TEMPLATE_SUBTASKS
    SET PARENT_ID = l_id_map(old_id.PARENT_ID)
    WHERE TEMPLATE_ID = v_new_template_id
      AND ID = l_id_map(old_id.ID);
  END LOOP;

  -- 4. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–æ–≤–∏–π ID
  APEX_JSON.OPEN_OBJECT;
  APEX_JSON.WRITE('status', 'ok');
  APEX_JSON.WRITE('newId', v_new_template_id);
  APEX_JSON.CLOSE_OBJECT;

EXCEPTION
  WHEN OTHERS THEN
    APEX_JSON.OPEN_OBJECT;
    APEX_JSON.WRITE('status', 'error');
    APEX_JSON.WRITE('message', SQLERRM);
    APEX_JSON.CLOSE_OBJECT;
END;
```

---

# üìà –Ø–∫ –ø—Ä–∞—Ü—é—î:

| –ö—Ä–æ–∫ | –î—ñ—è |
|------|-----|
| 1 | –ö–æ–ø—ñ—é—î–º–æ —à–∞–±–ª–æ–Ω —É `TASK_TEMPLATES` |
| 2 | –ö–æ–ø—ñ—é—î–º–æ –ø—ñ–¥—à–∞–±–ª–æ–Ω–∏ (`TASK_TEMPLATE_SUBTASKS`) —ñ–∑ –Ω–æ–≤–∏–º–∏ ID |
| 3 | –°—Ç–≤–æ—Ä—é—î–º–æ –º–∞–ø—É —Å—Ç–∞—Ä–∏–π ‚Üí –Ω–æ–≤–∏–π ID |
| 4 | –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ `PARENT_ID` |
| 5 | –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ JSON –∑ –Ω–æ–≤–∏–º ID –Ω–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω—É

---

# üìã –¢–µ–ø–µ—Ä –ª–æ–≥—ñ–∫–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é —Å–∏–º–µ—Ç—Ä–∏—á–Ω–∞:

| –Ø–∫—â–æ P5_SWITCH = 0 | –ü—Ä–∞—Ü—é—î–º–æ –∑ TASKS + TASK_SUBTASKS |
|--------------------|----------------------------------|
| –Ø–∫—â–æ P5_SWITCH = 1 | –ü—Ä–∞—Ü—é—î–º–æ –∑ TASK_TEMPLATES + TASK_TEMPLATE_SUBTASKS |

---

# ‚úÖ –ü—ñ–¥—Å—É–º–æ–∫:

‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ñ—î—Ä–∞—Ä—Ö—ñ—ó –ø–æ–≤–Ω—ñ—Å—Ç—é –∫–æ–ø—ñ—é—î—Ç—å—Å—è  
‚úÖ –ü—ñ–¥—à–∞–±–ª–æ–Ω–∏/–ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è –æ—Ç—Ä–∏–º—É—é—Ç—å –Ω–æ–≤—ñ –∫–æ—Ä–µ–∫—Ç–Ω—ñ `PARENT_ID`  
‚úÖ –ù–æ–≤–∞ –¥–∞—Ç–∞ `SYSDATE` —É –¥—É–±–ª—ñ–∫–æ–≤–∞–Ω–∏—Ö –∑–∞–ø–∏—Å–∞—Ö  
‚úÖ –õ–æ–≥—ñ–∫–∞ —î–¥–∏–Ω–∞ –¥–ª—è –∑–∞–≤–¥–∞–Ω—å —ñ —à–∞–±–ª–æ–Ω—ñ–≤

---

# üõ† –Ø–∫ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É Duplicate:

–¢–∏ –≤ JS –∑–∞–ª–∏—à–∞—î—à –æ–¥–∏–Ω –≤–∏–∫–ª–∏–∫:

```javascript
apex.server.process("DUPLICATE_TASK_OR_TEMPLATE", {
  pageItems: "#P5_TASK_ID, #P5_SWITCH"
}, {
  dataType: "json",
  success: function(pData) {
    if (pData.status === 'ok') {
      apex.message.alert("–£—Å–ø—ñ—à–Ω–æ –ø—Ä–æ–¥—É–±–ª—å–æ–≤–∞–Ω–æ!");
      apex.region('TASK_SUBTASKS_IG_1').refresh();
    } else {
      apex.message.alert("–ü–æ–º–∏–ª–∫–∞ –¥—É–±–ª—é–≤–∞–Ω–Ω—è: " + pData.message);
    }
  },
  error: function() {
    apex.message.alert("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—ñ.");
  }
});
```

–ê —Å–µ—Ä–≤–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å —Å–∞–º —Ä–æ–∑–±–∏—Ä–∞—î –ø–æ `P5_SWITCH`, —â–æ –¥—É–±–ª—é–≤–∞—Ç–∏.

---

# üöÄ –•–æ—á–µ—à:
- —â–µ —à–≤–∏–¥–∫–æ –ø–æ–∫–∞–∂—É –±–æ–Ω—É—Å:  
  –∫–æ–ª–∏ –º–∏ –¥—É–±–ª—é—î–º–æ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ —Ñ–æ—Ä–º—É –Ω–æ–≤–æ–≥–æ –¥—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É? (–∑ —Ä–µ–¥—ñ—Ä–µ–∫—Ç–æ–º –Ω–∞ –Ω–æ–≤–∏–π P5_TASK_ID)
  
–°–∫–∞–∑–∞—Ç–∏ "—Ç–∞–∫"? ‚úÖ  
(–î—É–∂–µ –∑—Ä—É—á–Ω–æ –¥–ª—è UX) üöÄ
